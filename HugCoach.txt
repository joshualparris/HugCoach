HugCoach


Here’s what you need to get this app off the ground (using your current PDF corpus as “v0 content”), plus Prompt 1 you can paste into Codex inside VS Code on WSL.
________________


The documents you need (minimum set, but properly “ship-ready”)
1) Product + scope
1. Vision + Outcomes (1–2 pages)

   * What “expert” means (measurable competencies) + what “connection with Kristy + self” means (measurable habits/rituals).
   * Include initial content sources you’ve uploaded (Christian marriage, intimacy, porn impacts, date ideas, etc.).


   2. MVP Definition (single page)

      * “Vertical slice” features only: Topic → Lesson → Quiz → Spaced Review → Weekly Summary.
# HugCoach MVP Technical Specification


I'll create a comprehensive, technically accurate specification for building this learning app with Codex on VS Code in WSL.


## Complete Documentation Package


### 1. Product & Scope Documents


#### 01-vision.md
```markdown
# Vision + Outcomes for HugCoach


## Vision
HugCoach is a privacy-first, evidence-based learning platform designed to help individuals develop expertise in intimate relationships within a Christian marriage framework. The app integrates scientifically-proven learning methodologies (retrieval practice, spaced repetition, feedback loops) with relationship psychology, attachment theory, and evidence-based intimacy education.


### Core Philosophy
- **Privacy-first**: Local-only data storage, no cloud sync required
- **Evidence-based**: Grounded in peer-reviewed research from sexology, psychology, and learning science
- **Consent-centered**: All content emphasizes mutual consent, respect, and communication
- **Christian-aligned**: Respects biblical principles while incorporating modern relationship science
- **Non-coercive**: Never pressures partners; focuses on personal growth and communication skills


### Initial Content Sources
The v0 content corpus includes:
- Christian marriage foundations and theology
- Communication and emotional connection strategies
- Date ideas and at-home connection rituals
- Understanding porn's neurological impacts (from APA/PubMed research)
- Intimacy within Christian marriage contexts
- Consent and boundary-setting frameworks


### Expert Integration
The app synthesizes insights from leading researchers:
- **Esther Perel**: Maintaining desire in long-term relationships
- **Emily Nagoski**: Dual Control Model of arousal
- **Rosemary Basson**: Circular model of responsive desire
- **Peggy Kleinplatz**: Optimal sexuality components
- **Lori Brotto**: Mindfulness for sexual wellbeing
- **Ian Kerner**: Communication-first intimacy
- **John Gottman**: Relationship fundamentals (Sound Relationship House)
- **Sue Johnson**: Attachment and emotional bonds (EFT)
- **Masters & Johnson**: Sensate focus and anxiety reduction


## Outcomes


### Measurable Competencies ("Expert" Definition)
1. **Communication Skills**
   - 90% quiz accuracy on active listening techniques
   - Demonstrated understanding of Gottman's bids for connection
   - Mastery of consent negotiation frameworks


2. **Relationship Psychology**
   - Understanding attachment styles and their impact
   - Knowledge of Dual Control Model (accelerators/brakes)
   - Application of Basson's responsive desire model


3. **Intimacy Knowledge**
   - Evidence-based understanding of arousal physiology
   - Consent-based exploration frameworks
   - Mindfulness techniques for presence


4. **Porn Impact Awareness**
   - Neurological effects understanding (from research)
   - Healthy sexuality distinctions
   - Recovery and rewiring strategies


### Measurable Habits/Rituals ("Connection" Definition)
1. **Daily Rituals** (10-15 min)
   - 20-second hug practice (oxytocin bonding)
   - 2-minute check-in conversations
   - Gratitude/appreciation sharing
   - Prayer or spiritual connection moments


2. **Weekly Rituals** (30-60 min)
   - At-home date nights (from date ideas corpus)
   - Sensate focus practice sessions
   - Relationship reflection and planning
   - Shared learning discussions


3. **Tracking Metrics**
   - Streak maintenance (daily engagement)
   - Mastery progression by topic
   - Ritual completion rates
   - Self-reported connection quality (1-10 scales)
   - Emotional closeness ratings (pre/post activities)


### Success Criteria (6-month horizon)
- 80%+ lesson completion rate
- 90%+ mastery on core topics
- 70%+ ritual adherence
- Stable spaced repetition intervals (14+ days on mastered items)
- Self-reported relationship satisfaction improvement
```


#### 02-mvp.md
```markdown
# MVP Definition: Vertical Slice Features


## Scope: Single-Page "Vertical Slice"
The MVP delivers ONE complete learning loop to prove the core value proposition:


**Topic → Lesson → Quiz → Spaced Review → Weekly Summary**


### In Scope (MVP v0.1)
1. **Browse Topics**: List 3 seed topics from PDF corpus
2. **Read Lesson**: Markdown-rendered content with clear learning objectives
3. **Take Quiz**: 5-question quiz (MCQ + short answer) with immediate feedback
4. **Schedule Reviews**: SM-2 algorithm schedules future reviews based on performance
5. **Complete Reviews**: Daily review queue of due questions
6. **Log Rituals**: Simple checklist for daily/weekly connection activities
7. **View Dashboard**: Today's plan (reviews due + next lesson + ritual reminder)
8. **Weekly Summary**: Basic analytics (streak, mastery %, weakest topics)


### Out of Scope (Future Iterations)
- Multi-user support (start single-user/local)
- Mobile apps (web-first)
- Cloud sync
- Advanced analytics/ML
- Gamification beyond streaks
- Social features
- Video/audio content
- Advanced question types (drag-drop, matching)
- Content authoring UI (start with seed scripts)


### Technical Constraints
- **Local-first**: SQLite database, no cloud required
- **Privacy**: No telemetry, no external API calls
- **Performance**: <2s page loads, <500ms interactions
- **Accessibility**: WCAG 2.1 AA compliance


### Launch Criteria
- [ ] 3 topics, 2 lessons each, 5 questions per lesson (30 questions total)
- [ ] Quiz → Review loop functional end-to-end
- [ ] Scheduler correctly implements SM-2
- [ ] Dashboard shows accurate "today's plan"
- [ ] 90%+ test coverage on scheduling logic
- [ ] Zero data loss on app restart
```


#### 03-user-stories.md
```markdown
# User Stories + Acceptance Criteria


## Epic 1: Learning Loop


### US-001: Browse Topics
**As Josh**, I want to see available learning topics so I can choose what to study.


**Acceptance Criteria:**
- [ ] `/topics` page displays 3+ topics with title, description, lesson count
- [ ] Each topic shows mastery percentage (0-100%)
- [ ] Click topic navigates to topic detail page
- [ ] Topics are ordered by: incomplete → in-progress → mastered


### US-002: Read Lesson
**As Josh**, I want to read a lesson's content so I can learn new concepts.


**Acceptance Criteria:**
- [ ] `/lessons/[id]` renders Markdown content with proper formatting
- [ ] Page shows: topic breadcrumb, lesson title, estimated time, learning objectives
- [ ] "Start Quiz" button appears at bottom
- [ ] Progress indicator shows current lesson position in topic
- [ ] Content is responsive (mobile-friendly)


### US-003: Take Quiz
**As Josh**, I want to complete a quiz after a lesson so I can test my understanding.


**Acceptance Criteria:**
- [ ] `/quiz/[lessonId]` displays 5 questions sequentially
- [ ] Supports MCQ (radio buttons) and short answer (text input)
- [ ] After answering, immediate feedback shows:
  - Correct/incorrect indicator
  - Explanation of correct answer
  - Quality rating prompt (0-5: blackout → perfect)
- [ ] Submit button is disabled until answer provided
- [ ] Quiz completion shows summary (score, time taken)
- [ ] Answers are saved to database (QuizAttempt + QuestionAttempt records)


### US-004: Schedule Reviews
**As the system**, I want to schedule spaced reviews based on quiz performance so users retain knowledge.


**Acceptance Criteria:**
- [ ] After each question attempt, ReviewItem record created with:
  - `dueAt` calculated via SM-2 algorithm
  - `easinessFactor` initialized/updated (2.5 start, adjusted by quality)
  - `intervalDays` calculated (1, 6, then EF-multiplied)
  - `repetitions` incremented
- [ ] Quality 0-2 resets interval to 1 day (lapse)
- [ ] Quality 3+ increases interval exponentially
- [ ] Database stores full review history


### US-005: Complete Reviews
**As Josh**, I want to review due questions so I don't forget what I learned.


**Acceptance Criteria:**
- [ ] `/review` page shows count of due reviews
- [ ] Questions presented one at a time (card format)
- [ ] After answering, rate quality (0-5) and see feedback
- [ ] Review updates ReviewItem (new dueAt, EF, interval)
- [ ] "No reviews due" message when queue empty
- [ ] Reviews are sorted by: overdue (oldest first) → due today


## Epic 2: Connection Rituals


### US-006: Log Rituals
**As Josh**, I want to log daily connection rituals so I build consistent habits.


**Acceptance Criteria:**
- [ ] `/rituals` page shows checklist of daily rituals:
  - 20-second hug
  - 2-minute check-in
  - Gratitude sharing
  - Prayer/spiritual moment
- [ ] Each ritual has checkbox that creates RitualLog entry with timestamp
- [ ] Cannot check future dates (only today/past)
- [ ] Weekly rituals section with longer activities
- [ ] Ritual descriptions include WHY (purpose/benefit)


### US-007: View Dashboard
**As Josh**, I want to see today's learning plan so I know what to do.


**Acceptance Criteria:**
- [ ] `/` (home) shows:
  - Review count (with urgency indicator if overdue)
  - Next recommended lesson (from incomplete topics)
  - Today's ritual checklist status
  - Current streak (days of activity)
- [ ] Quick action buttons: "Start Reviews", "Continue Learning", "Log Rituals"
- [ ] Encouraging message if no actions due
- [ ] Last activity timestamp


## Epic 3: Progress Tracking


### US-008: Weekly Summary
**As Josh**, I want to see weekly progress so I stay motivated.


**Acceptance Criteria:**
- [ ] `/summary` page shows last 7 days:
  - Total reviews completed
  - New lessons finished
  - Ritual adherence rate
  - Mastery improvements by topic
- [ ] Chart: daily activity heatmap
- [ ] "Weakest areas" section (topics with <70% mastery)
- [ ] Suggestions: "Focus on X this week"


## Epic 4: Safety & Boundaries


### US-009: Content Safety
**As Josh**, I want content that respects boundaries so the app feels safe.


**Acceptance Criteria:**
-- [ ] All intimacy content emphasizes consent/communication
- [ ] Disclaimers on lessons: "Not medical advice", "Pause if causing conflict"
- [ ] Clear escalation guidance: "Consider counseling if..."
- Explicit Content is Allowed if it helps achieve goals of becoming a master of female and male orgasm and connection between a married man and woman.


### 2. Learning Science + Quiz Design


#### 04-learning-model.md
```markdown
# Learning Model Specification


## Evidence-Based Principles


### 1. Retrieval Practice
**Research basis**: Roediger & Karpicke (2006) - Testing effect shows retrieval strengthens memory more than re-reading.


**Implementation**:
- Every lesson followed by quiz (forced retrieval)
- Reviews re-test knowledge at intervals
- No "peek at answer" option during initial attempt
- Feedback only after committing to answer


### 2. Spaced Repetition
**Research basis**: Ebbinghaus forgetting curve - retention improves with spaced reviews.


**Implementation**:
- SM-2 algorithm (Wozniak, 1990)
- Intervals: 1 day → 6 days → 14 days → 30 days → ... (exponential)
- Lapses reset to short intervals
- Optimal spacing prevents both forgetting and wasted reviews


### 3. Interleaving
**Research basis**: Mixed practice improves discrimination and transfer.


**Implementation**:
- Review queue mixes questions from different topics
- No topic-blocked study sessions
- Daily plan suggests variety (not all same topic)


### 4. Immediate Feedback
**Research basis**: Feedback timing affects learning (Kulik & Kulik meta-analysis).


**Implementation**:
- Answer → Immediate correct/incorrect + explanation
- Quality rating prompts metacognition
- No delayed feedback (common LMS mistake)


### 5. Reflection
**Research basis**: Metacognitive prompts improve transfer (Schraw, 1998).


**Implementation**:
- Post-quiz reflection: "What was hardest?"
- Weekly summary prompts: "How will you apply this?"
- Ritual logs include notes field


### 6. Overlearning
**Research basis**: Continued practice after mastery improves retention.


**Implementation**:
- "Mastered" items still appear in reviews (longer intervals)
- No "retirement" of questions
- Gradual interval increases cap at ~180 days


## Daily Loop (10-15 minutes)
**Target time**: 10-15 min/day for sustainable habit.


**Flow**:
1. **Check Dashboard** (30s): See reviews due + ritual status
2. **Complete Reviews** (5-10 min): Clear due queue (target: 10-15 reviews/day)
3. **Log Ritual** (2 min): Quick check-in activity
4. **Optional: New Lesson** (if time remains)


**Triggers**:
- Push notification (if enabled): "5 reviews due today"
- Streak indicator: "7-day streak! Keep it going"


## Weekly Loop (30-60 minutes)
**Target time**: 30-60 min once per week for deeper learning.


**Flow**:
1. **New Lessons** (20-30 min): Complete 1-2 new lessons + quizzes
2. **Weekly Ritual** (20-30 min): Longer connection activity (date night, sensate focus)
3. **Review Summary** (5-10 min): Check analytics, note weak areas


**Triggers**:
- Sunday evening prompt: "Plan your week"
- Weekly email (if enabled): "This week's focus: [topic]"


## Mastery Progression Model


### Stages
1. **Novice** (0-40%): High error rate, short intervals
2. **Intermediate** (41-70%): Improving consistency
3. **Proficient** (71-89%): Stable recall
4. **Mastery** (90-100%): Long intervals, rare errors


### Topic Mastery Calculation
```
Mastery = (Σ question_mastery) / total_questions
Question Mastery = (easinessFactor - 1.3) / (2.5 - 1.3) * 100
```
- EF 1.3 → 0% mastery
- EF 2.5 → 100% mastery


### Advancement Gates
- **Unlock next topic**: 70%+ mastery on prerequisite topics
- **Weekly summary**: Only appears after 7+ days of activity
```


#### 05-question-bank.md
```markdown
# Question Bank Specification


## Question Types Supported (MVP)


### 1. Multiple Choice (MCQ)
**Use for**: Concept identification, fact recall, scenario analysis


**Format**:
```json
{
  "type": "mcq",
  "question": "Which component of Gottman's Sound Relationship House involves knowing your partner's inner world?",
  "options": [
    "Love Maps",
    "Trust",
    "Conflict Management",
    "Shared Meaning"
  ],
  "correctIndex": 0,
  "explanation": "Love Maps refer to the cognitive room where you store all the relevant information about your partner's life."
}
```


**Rules**:
- 4 options (1 correct, 3 plausible distractors)
- Distractors must be plausible (not obviously wrong)
- Avoid "all of the above" or "none of the above"
- Single concept per question


### 2. Short Answer
**Use for**: Application, reflection, personal insight


**Format**:
```json
{
  "type": "short_answer",
  "question": "Describe one 'brake' (inhibitor of arousal) from Nagoski's Dual Control Model that might affect you personally.",
  "sampleAnswers": [
    "Stress from work deadlines",
    "Feeling tired or fatigued",
    "Worries about performance"
  ],
  "explanation": "Brakes are factors that inhibit sexual arousal. Common brakes include stress, fatigue, distractions, or performance anxiety."
}
```


**Rules**:
- No auto-grading (user self-evaluates with quality rating)
- Provide 2-3 sample answers for guidance
- Explanation shows key concepts to include


### 3. Scenario-Based (MCQ variant)
**Use for**: Applying knowledge to realistic situations


**Format**:
```json
{
  "type": "mcq",
  "question": "Your partner seems distant during intimacy. According to Sue Johnson's EFT, what's the best first response?",
  "options": [
    "Ask 'Are you okay? What's on your mind?' and listen without judgment",
    "Try a different technique to increase arousal",
    "Assume they're not interested and stop",
    "Continue and hope they'll relax"
  ],
  "correctIndex": 0,
  "explanation": "EFT emphasizes emotional attunement. Checking in verbally creates safety and addresses potential attachment concerns."
}
```


### 4. Reflection Prompts (Short Answer variant)
**Use for**: Metacognition, personal application


**Format**:
```json
{
  "type": "short_answer",
  "question": "Reflect: How might implementing a 20-second hug daily affect your emotional connection?",
  "sampleAnswers": [
    "It could increase oxytocin and create a moment of presence",
    "It might help us slow down and reconnect amid busy schedules"
  ],
  "explanation": "Reflection prompts have no single 'correct' answer. The goal is to think deeply about personal application."
}
```


## Question Quality Guidelines


### Single Concept Rule
❌ Bad: "According to Basson and Nagoski, which model describes responsive desire and what are the key accelerators?"
✅ Good: "Basson's model suggests female desire often emerges from which process?"


### Plausible Distractors
❌ Bad distractors: "Eating pizza", "Watching TV" (obviously wrong in sexual context)
✅ Good distractors: "Spontaneous desire", "Goal-oriented arousal" (plausible but incorrect)


### Clear Correct Answer
- Only ONE defensibly correct option
- No ambiguity (unless testing judgment)
- Explanation justifies why correct


### Appropriate Difficulty
- **Knowledge**: Direct recall from lesson
- **Comprehension**: Explain in own words
- **Application**: Use in new scenario
- **Analysis**: Compare/contrast concepts


### Respectful Tone
- No TMI (too much information)
- Use clinical terminology when needed
- Frame intimacy in consent-first language
- Avoid male-centric or coercive framing


## Seed Content Structure


### Topic 1: Communication Foundations
**Lessons**:
1. Active Listening & Bids for Connection (Gottman)
2. Consent Conversations & Boundaries


**Sample Questions**:
- MCQ: "What is a 'bid' in Gottman's terminology?"
- Scenario: "Your partner mentions feeling tired. How do you 'turn towards' this bid?"
- Reflection: "When was the last time you turned away from a bid? What happened?"


### Topic 2: Understanding Arousal
**Lessons**:
1. Dual Control Model (Nagoski)
2. Responsive vs. Spontaneous Desire (Basson)


**Sample Questions**:
- MCQ: "Which is an example of an 'accelerator' in the Dual Control Model?"
- Short Answer: "List two brakes you've personally experienced."
- Scenario: "Your partner rarely initiates. Given Basson's model, what might explain this?"


### Topic 3: Mindfulness & Presence
**Lessons**:
1. Sensate Focus Basics (Masters & Johnson)
2. Mindfulness for Intimacy (Brotto)


**Sample Questions**:
- MCQ: "What is the primary goal of sensate focus exercises?"
- Short Answer: "Describe one way to bring mindfulness into a touch session."
- Reflection: "What distractions pull you out of presence during intimacy?"
```


#### 06-spaced-repetition.md
```markdown
# Spaced Repetition Specification


## Algorithm: SM-2 (Simplified)


### Background
SuperMemo 2 algorithm (Wozniak, 1990) is battle-tested and simple to implement. It uses:
- **Easiness Factor (EF)**: Reflects how easy a question is for the user (1.3 to 2.5)
- **Interval**: Days until next review
- **Repetitions**: Count of successful reviews


### Core Formula


```typescript
function calculateNextReview(
  quality: number, // 0-5 rating
  currentEF: number,
  currentInterval: number,
  repetitions: number
): { newEF: number; newInterval: number; newReps: number; dueAt: Date } {
  
  // Update Easiness Factor
  let newEF = currentEF + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
  newEF = Math.max(1.3, newEF); // Floor at 1.3
  
  let newInterval: number;
  let newReps: number;
  
  if (quality < 3) {
    // Lapse: reset interval
    newInterval = 1;
    newReps = 0;
  } else {
    // Success: increase interval
    if (repetitions === 0) {
      newInterval = 1;
    } else if (repetitions === 1) {
      newInterval = 6;
    } else {
      newInterval = Math.round(currentInterval * newEF);
    }
    newReps = repetitions + 1;
  }
  
  // Cap interval at 180 days (optional)
  newInterval = Math.min(newInterval, 180);
  
  const dueAt = new Date();
  dueAt.setDate(dueAt.getDate() + newInterval);
  
  return { newEF, newInterval, newReps, dueAt };
}
```


### Quality Ratings


| Rating | Label | Meaning | Effect |
|--------|-------|---------|--------|
| 0 | Blackout | Complete memory failure | Reset to day 1 |
| 1 | Incorrect | Wrong answer after effort | Reset to day 1 |
| 2 | Incorrect (easy) | Wrong but felt easy | Reset to day 1 |
| 3 | Correct (hard) | Right answer with effort | Increase interval, lower EF |
| 4 | Correct (good) | Right answer, some hesitation | Standard interval increase |
| 5 | Perfect | Instant correct recall | Larger interval increase |


### Database Fields (ReviewItem table)


```typescript
interface ReviewItem {
  id: string;
  questionId: string;
  userId: string;
  easinessFactor: number; // Default: 2.5
  intervalDays: number; // Default: 0 (new item)
  repetitions: number; // Default: 0
  dueAt: Date; // Initially: now (immediate first review)
  lastReviewedAt: Date | null;
  createdAt: Date;
}
```


### Scheduling Rules


#### Initial Schedule (after first quiz)
- All questions from quiz → ReviewItem with `dueAt = now + 1 day`
- First review happens next day


#### Subsequent Reviews
- Quality 0-2: Reset to 1-day interval (lapse)
- Quality 3: Interval × EF, but EF decreases slightly
- Quality 4-5: Interval × EF, EF stable or increases


#### Review Queue Priority
1. **Overdue** (dueAt < today): Sorted oldest first
2. **Due today** (dueAt = today): Sorted by creation time
3. **Upcoming** (dueAt > today): Not shown (wait until due)


### Lapse Handling


**Definition**: Quality < 3 is a lapse (forgot the answer).


**Actions**:
- Reset interval to 1 day
- Reset repetitions to 0
- Keep EF (to track difficulty history)
- Mark as "needs review" in analytics


**Frequency Cap**: If a question lapses >3 times, flag for content review (might be confusing).


## Mastery Thresholds


### Question-Level Mastery
- **Criterion**: EF ≥ 2.3 AND interval ≥ 14 days
- **Interpretation**: User can recall consistently with 2+ week gaps


### Topic-Level Mastery
```typescript
function calculateTopicMastery(questions: ReviewItem[]): number {
  const masteredCount = questions.filter(q => 
    q.easinessFactor >= 2.3 && q.intervalDays >= 14
  ).length;
  return (masteredCount / questions.length) * 100;
}
```


- 0-40%: Novice
- 41-70%: Intermediate
- 71-89%: Proficient
- 90-100%: Mastery


## Edge Cases


### Never Reviewed
- **Scenario**: Question created but never reviewed
- **Handling**: Show in review queue immediately (dueAt = now)


### Skipped Reviews
- **Scenario**: User doesn't review for days, items pile up
- **Handling**: Review queue shows all overdue (cap UI at 50 to avoid overwhelm)


### Deleted Questions
- **Scenario**: Content updated, old questions removed
- **Handling**: Soft-delete ReviewItems, exclude from mastery calculations


### Timezone Changes
- **Scenario**: User travels across timezones
- **Handling**: Use UTC for all `dueAt` timestamps, display in local time
```


### 3. Relationship + Spiritual Integration


#### 09-safety-boundaries.md
```markdown
# Safety + Boundaries Policy


## Core Principles


### 1. Consent is Paramount
- All content emphasizes **mutual, enthusiastic, ongoing consent**
- No activities should ever be pressured or coerced
- Either partner can pause/stop at any time
- "No" is always respected without guilt


### 2. Privacy First
- All data stored locally (SQLite)
- No telemetry or usage tracking
- No cloud sync without explicit opt-in
- User can export/delete all data anytime


### 3. Non-Coercive Education
- App teaches skills, never dictates outcomes
- No "you must do X" language
- Frames intimacy as collaborative exploration
- Acknowledges individual differences (not one-size-fits-all)


### 4. Age-Appropriate
- Designed for married adults (18+)
- No content involving minors under any circumstance


### 5. Medical Disclaimers
- App is NOT medical advice
- Does not diagnose, treat, or cure conditions
- Recommends professional help when needed


## Content Guardrails


### Prohibited Content
❌ **Never Include**:
- Explicit sexual imagery or pornographic material
- Coercive or manipulative tactics
- Content that could be used to pressure a partner
- Medical diagnoses or treatment plans
- Advice that violates consent principles
- Content involving non-consenting individuals
- Anything promoting harm or abuse


### Permitted Content
✅ **Allowed**:
- Evidence-based relationship education
- Communication frameworks (Gottman, Johnson, etc.)
- Anatomy/physiology education (clinical terminology)
- Consent negotiation strategies
- Mindfulness and presence techniques
- Christian theology on marriage (respectful framing)
- Research summaries (porn effects, attachment theory)


### Gray Areas (Handle with Care)
⚠️ **Requires Careful Framing**:
- **Intimacy techniques**: Frame as "options to explore together," not prescriptions
- **Desire discrepancy**: Validate both partners, emphasize communication
- **Porn impact**: Present research without shame, focus on recovery
- **Religious content**: Respect diverse interpretations, avoid dogmatism


## Safety Warnings


### When to Display Warnings


#### Conflict Warning
**Trigger**: Content on desire discrepancy, conflict resolution
**Message**: 
> "If discussing this topic creates conflict in your relationship, consider pausing and seeking support from a licensed therapist or counselor. This app is for education, not crisis intervention."


#### Medical Referral
**Trigger**: Content on pain, dysfunction, persistent issues
**Message**:
> "If you experience pain, persistent difficulties, or concerning symptoms, please consult a healthcare provider. This app does not replace medical advice."


#### Mental Health Referral
**Trigger**: Content on porn addiction, shame, depression
**Message**:
> "If you're struggling with compulsive behaviors, shame, or low mood, please reach out to a mental health professional. Resources: [link to SAMHSA, BetterHelp, etc.]"


#### Consent Reminder
**Trigger**: Content on trying new activities
**Message**:
> "Remember: Both partners must enthusiastically consent to any activity. It's always okay to say 'not right now' or 'let's talk about this first.'"


## Escalation Guidance


### When User Needs Help
The app should provide links/resources for:


1. **Relationship Counseling**
   - Gottman Institute therapist directory
   - AAMFT (American Association for Marriage and Family Therapy)
   - Local faith-based counseling (if requested)


2. **Sex Therapy**
   - AASECT (American Association of Sexuality Educators, Counselors and Therapists)
   - Local certified sex therapists


3. **Mental Health**
   - SAMHSA National Helpline: 1-800-662-4357
   - Psychology Today therapist finder
   - Crisis Text Line: Text HOME to 741741


4. **Domestic Violence** (if app detects coercion concerns)
   - National Domestic Violence Hotline: 1-800-799-7233
   - Clear message: "If you feel unsafe, please reach out for help."


### Feedback Loop
- Every lesson has "Report Content" link
- User can flag content as:
  - Inaccurate
  - Inappropriate
  - Triggering
  - Coercive
- Feedback stored locally, user can export for review


## Christian Framework Respectfulness


### Inclusive Approach
- Acknowledge diverse Christian traditions (Catholic, Protestant, Orthodox)
- Avoid narrow interpretations of theology
- Present biblical principles alongside modern research
- Never use Scripture to justify coercion or control


### Key Scriptural Anchors (if applicable)
- **Genesis 2:24**: "Becoming one flesh" as unity, not obligation
- **Song of Solomon**: Celebration of mutual desire and pleasure
- **1 Corinthians 7:3-5**: Mutual sexual generosity, not demand
- **Ephesians 5:21**: Mutual submission, not hierarchy


### Tone Guidelines
- Respectful of faith, not preachy
- Integrate theology naturally (not forced)
- Allow space for users to interpret through their own faith lens


## Privacy & Data Ethics


### Data Minimization
- Only collect data essential for app function
- No behavioral tracking or analytics
- No third-party integrations (ads, trackers)


### User Control
- Export all data as JSON
- Delete all data with one button
- No "are you sure?" dark patterns


### Transparency
- Open-source code (if desired)
- Clear privacy policy in plain language
- No hidden data collection


## Testing for Safety


### Pre-Launch Checklist
- [ ] All lessons reviewed by licensed therapist or educator
- [ ] Content tested with beta users for tone/appropriateness
- [ ] Warnings trigger correctly
- [ ] Resource links verified and current
- [ ] Privacy policy legally reviewed
- [ ] No unintended pressure tactics in language


### Ongoing Monitoring
- Regular content audits (quarterly)
- User feedback review
- Research updates incorporated
- Expert consultation for new topics
```


### 4. Engineering Documents


#### 08-architecture.md
```markdown
# Technical Architecture (MVP)


## Stack


### Core Technologies
- **Framework**: Next.js 15 (App Router)
- **Language**: TypeScript 5.x (strict mode)
- **Styling**: Tailwind CSS 3.x + shadcn/ui components
- **Database**: SQLite (via better-sqlite3)
- **ORM**: Prisma 5.x
- **Testing**: Vitest + Testing Library


### Why This Stack?


**Next.js**:
- Server components for performance
- File-based routing (intuitive structure)
- Built-in API routes
- Easy deployment (Vercel, self-hosted)


**SQLite**:
- Zero-config database (perfect for local-first)
- Single file (easy backup/restore)
- Fast for <100k records (MVP scale)
- Can migrate to PostgreSQL later if needed


**Prisma**:
- Type-safe database access
- Migration management
- Excellent TypeScript integration


**Tailwind + shadcn/ui**:
- Rapid UI development
- Accessible components out-of-box
- Consistent design system


## Project Structure


```
hugcoach/
├── app/                    # Next.js App Router
│   ├── (dashboard)/       # Groupe


```
│   ├── (dashboard)/       # Grouped routes (shared layout)
│   │   ├── layout.tsx     # Dashboard layout with nav
│   │   ├── page.tsx       # Home/Dashboard
│   │   ├── topics/
│   │   │   ├── page.tsx   # Topics list
│   │   │   └── [id]/
│   │   │       └── page.tsx  # Topic detail
│   │   ├── lessons/
│   │   │   └── [id]/
│   │   │       └── page.tsx  # Lesson reader
│   │   ├── quiz/
│   │   │   └── [lessonId]/
│   │   │       └── page.tsx  # Quiz runner
│   │   ├── review/
│   │   │   └── page.tsx   # Review queue
│   │   ├── rituals/
│   │   │   └── page.tsx   # Ritual tracker
│   │   └── summary/
│   │       └── page.tsx   # Weekly analytics
│   ├── api/               # API routes
│   │   ├── quiz/
│   │   │   └── submit/route.ts
│   │   ├── review/
│   │   │   └── submit/route.ts
│   │   └── rituals/
│   │       └── log/route.ts
│   ├── globals.css        # Global styles
│   └── layout.tsx         # Root layout
├── components/
│   ├── ui/                # shadcn/ui components
│   │   ├── button.tsx
│   │   ├── card.tsx
│   │   ├── progress.tsx
│   │   └── ...
│   ├── dashboard/
│   │   ├── DashboardCard.tsx
│   │   ├── StreakIndicator.tsx
│   │   └── TodaysPlan.tsx
│   ├── quiz/
│   │   ├── QuestionCard.tsx
│   │   ├── MCQOptions.tsx
│   │   ├── ShortAnswerInput.tsx
│   │   └── QualityRating.tsx
│   ├── review/
│   │   └── ReviewCard.tsx
│   └── shared/
│       ├── Navbar.tsx
│       ├── Breadcrumb.tsx
│       └── ProgressBar.tsx
├── lib/
│   ├── db.ts              # Prisma client singleton
│   ├── scheduler.ts       # SM-2 algorithm
│   ├── analytics.ts       # Mastery calculations
│   └── utils.ts           # Shared utilities
├── prisma/
│   ├── schema.prisma      # Database schema
│   ├── seed.ts            # Seed data script
│   └── migrations/        # Migration history
├── content/               # Lesson content (Markdown)
│   ├── topics/
│   │   ├── communication-foundations/
│   │   │   ├── 01-active-listening.md
│   │   │   └── 02-consent-conversations.md
│   │   ├── understanding-arousal/
│   │   │   ├── 01-dual-control-model.md
│   │   │   └── 02-responsive-desire.md
│   │   └── mindfulness-presence/
│   │       ├── 01-sensate-focus.md
│   │       └── 02-mindfulness-intimacy.md
│   └── questions/         # Question bank (JSON)
│       ├── communication-foundations.json
│       ├── understanding-arousal.json
│       └── mindfulness-presence.json
├── tests/
│   ├── unit/
│   │   ├── scheduler.test.ts
│   │   └── analytics.test.ts
│   └── e2e/
│       ├── quiz-flow.test.ts
│       └── review-flow.test.ts
├── docs/                  # Documentation (from above)
│   ├── 01-vision.md
│   ├── 02-mvp.md
│   ├── ...
│   └── 09-safety-boundaries.md
├── public/
│   └── images/            # Static assets
├── .env.example
├── .gitignore
├── next.config.js
├── package.json
├── tsconfig.json
├── tailwind.config.ts
└── vitest.config.ts
```


## Data Flow


### Quiz Submission Flow
```
User answers question
  ↓
POST /api/quiz/submit
  ↓
Create QuizAttempt + QuestionAttempt records
  ↓
For each question:
  - Calculate next review (SM-2)
  - Create/update ReviewItem
  ↓
Return quiz results + scheduled reviews
  ↓
Redirect to quiz summary page
```


### Review Submission Flow
```
User completes review question
  ↓
Rate quality (0-5)
  ↓
POST /api/review/submit
  ↓
Update ReviewItem:
  - Calculate new EF, interval, dueAt
  - Increment repetitions (or reset if lapse)
  ↓
Return next due review (if any)
  ↓
Show next review or "All done!" message
```


### Dashboard Data Loading
```
Server Component loads:
  - Review count (WHERE dueAt <= NOW)
  - Next lesson (first incomplete)
  - Today's rituals (grouped by daily/weekly)
  - Current streak (consecutive active days)
  ↓
Render with prefetched data (no loading spinners)
```


## Database Schema


### Core Tables
See `07-data-model.md` for full Prisma schema. Key relationships:


```
Topic (1) ──→ (N) Lesson
Lesson (1) ──→ (N) Question
Question (1) ──→ (N) QuestionAttempt
Question (1) ──→ (1) ReviewItem
User (1) ──→ (N) QuizAttempt
User (1) ──→ (N) RitualLog
```


### Indexes
```prisma
@@index([dueAt])                    // ReviewItem: Fast queue queries
@@index([lessonId])                 // Question: Group by lesson
@@index([userId, createdAt])        // QuizAttempt: User history
@@index([userId, ritualId, date])   // RitualLog: Daily tracking
```


## API Routes


### POST /api/quiz/submit
**Request**:
```json
{
  "lessonId": "uuid",
  "answers": [
    {
      "questionId": "uuid",
      "answer": "string | number",
      "quality": 0-5
    }
  ]
}
```


**Response**:
```json
{
  "quizAttemptId": "uuid",
  "score": 80,
  "totalQuestions": 5,
  "scheduledReviews": 5,
  "results": [
    {
      "questionId": "uuid",
      "correct": true,
      "explanation": "...",
      "nextReviewAt": "2025-12-18T10:00:00Z"
    }
  ]
}
```


### POST /api/review/submit
**Request**:
```json
{
  "reviewItemId": "uuid",
  "answer": "string | number",
  "quality": 0-5
}
```


**Response**:
```json
{
  "correct": true,
  "explanation": "...",
  "nextReviewAt": "2025-12-24T10:00:00Z",
  "newInterval": 7,
  "remainingReviews": 3
}
```


### POST /api/rituals/log
**Request**:
```json
{
  "ritualId": "uuid",
  "date": "2025-12-17",
  "notes": "Felt really connected during our hug"
}
```


**Response**:
```json
{
  "ritualLogId": "uuid",
  "streakUpdated": true,
  "newStreak": 8
}
```


## Performance Targets


### Page Load
- **Dashboard**: <1s (server-rendered)
- **Lesson**: <1.5s (Markdown parse + render)
- **Quiz**: <800ms
- **Review**: <500ms (single question)


### Database Queries
- **Dashboard data**: <50ms (4-5 queries, indexed)
- **Quiz submission**: <100ms (transaction with 5-10 inserts)
- **Review queue**: <30ms (indexed dueAt query)


### Bundle Size
- **First Load JS**: <150KB (Next.js + React)
- **Page JS**: <50KB per route
- **Total**: <500KB (including Tailwind)


## Security Considerations


### Local-First Security
- No authentication needed (single-user, local device)
- File permissions: Database file readable only by user
- No network requests (except optional future sync)


### Input Validation
- **API routes**: Validate all inputs with Zod schemas
- **Quality ratings**: Constrain to 0-5
- **Dates**: Validate ISO 8601 format
- **SQL injection**: Prevented by Prisma (parameterized queries)


### Data Integrity
- **Transactions**: Use Prisma transactions for multi-step operations
- **Constraints**: Foreign keys, unique constraints in schema
- **Soft deletes**: Flag records as deleted, don't remove


## Deployment Options


### Development (WSL)
```bash
npm run dev        # Next.js dev server on localhost:3000
npm run db:push    # Sync Prisma schema to SQLite
npm run db:seed    # Populate with seed data
```


### Production (Self-Hosted)
```bash
npm run build      # Create optimized production build
npm run start      # Run production server
```


**Database location**: `prisma/dev.db` (can configure path)


### Alternative: Electron Desktop App
For true "offline-first" experience, wrap Next.js in Electron:
- Package as `.exe` (Windows), `.app` (Mac), `.deb` (Linux)
- Bundle SQLite database
- No browser required


## Testing Strategy


### Unit Tests (Vitest)
- **lib/scheduler.ts**: Test SM-2 algorithm with edge cases
- **lib/analytics.ts**: Test mastery calculations
- **lib/utils.ts**: Test helper functions


### Integration Tests
- **API routes**: Test request/response with mock database
- **Database operations**: Test Prisma queries


### E2E Tests (Playwright)
- **Quiz flow**: Complete quiz → verify reviews scheduled
- **Review flow**: Complete review → verify interval updated
- **Dashboard**: Verify correct counts and next lesson


### Test Coverage Target
- **Scheduler logic**: 100% (critical for learning loop)
- **API routes**: 90%
- **Overall**: 80%


## Migration Path (Future)


### v0.1 → v0.2 (Multi-User)
- Add `User` table with authentication
- Add `userId` foreign keys to all tables
- Implement login/signup


### v0.2 → v0.3 (Cloud Sync)
- Add sync API (Supabase, PocketBase, or custom)
- Implement conflict resolution (last-write-wins or CRDT)
- Encrypted backups to cloud


### v0.3 → v1.0 (Mobile Apps)
- Expo/React Native for iOS/Android
- Shared TypeScript logic
- Native SQLite integration
```


#### 07-data-model.md
```markdown
# Data Model Specification


## Prisma Schema


```prisma
// prisma/schema.prisma


generator client {
  provider = "prisma-client-js"
}


datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}


// ============================================================================
// CONTENT STRUCTURE
// ============================================================================


model Topic {
  id          String   @id @default(cuid())
  title       String
  description String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  lessons     Lesson[]
  
  @@index([order])
}


model Lesson {
  id             String   @id @default(cuid())
  topicId        String
  title          String
  slug           String   @unique
  content        String   // Markdown content
  estimatedMinutes Int    @default(10)
  order          Int      @default(0)
  learningObjectives String // JSON array of objectives
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  topic          Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  questions      Question[]
  quizAttempts   QuizAttempt[]
  
  @@index([topicId])
  @@index([order])
}


model Question {
  id          String   @id @default(cuid())
  lessonId    String
  type        String   // 'mcq' | 'short_answer'
  question    String
  options     String?  // JSON array (for MCQ)
  correctAnswer String // Index (for MCQ) or sample answers (for short_answer)
  explanation String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  attempts    QuestionAttempt[]
  reviewItems ReviewItem[]
  
  @@index([lessonId])
  @@index([order])
}


// ============================================================================
// LEARNING ATTEMPTS & REVIEWS
// ============================================================================


model QuizAttempt {
  id          String   @id @default(cuid())
  lessonId    String
  score       Int      // Correct answers count
  total       Int      // Total questions
  timeSpent   Int?     // Seconds
  createdAt   DateTime @default(now())
  
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questionAttempts QuestionAttempt[]
  
  @@index([lessonId])
  @@index([createdAt])
}


model QuestionAttempt {
  id            String   @id @default(cuid())
  quizAttemptId String
  questionId    String
  answer        String   // User's answer
  correct       Boolean
  quality       Int      // 0-5 rating
  createdAt     DateTime @default(now())
  
  quizAttempt   QuizAttempt @relation(fields: [quizAttemptId], references: [id], onDelete: Cascade)
  question      Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  @@index([quizAttemptId])
  @@index([questionId])
}


model ReviewItem {
  id              String    @id @default(cuid())
  questionId      String    @unique
  easinessFactor  Float     @default(2.5)
  intervalDays    Int       @default(0)
  repetitions     Int       @default(0)
  dueAt           DateTime  @default(now())
  lastReviewedAt  DateTime?
  lapseCount      Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  question        Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  @@index([dueAt])
  @@index([questionId])
}


// ============================================================================
// RITUALS & REFLECTIONS
// ============================================================================


model Ritual {
  id          String   @id @default(cuid())
  title       String
  description String
  type        String   // 'daily' | 'weekly'
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  
  logs        RitualLog[]
  
  @@index([type])
  @@index([order])
}


model RitualLog {
  id        String   @id @default(cuid())
  ritualId  String
  date      String   // YYYY-MM-DD format
  notes     String?
  createdAt DateTime @default(now())
  
  ritual    Ritual   @relation(fields: [ritualId], references: [id], onDelete: Cascade)
  
  @@unique([ritualId, date])
  @@index([date])
}


model Reflection {
  id        String   @id @default(cuid())
  type      String   // 'quiz' | 'weekly' | 'ritual'
  content   String
  metadata  String?  // JSON (e.g., { quizAttemptId, weekStart })
  createdAt DateTime @default(now())
  
  @@index([type])
  @@index([createdAt])
}


// ============================================================================
// USER PROGRESS & ANALYTICS
// ============================================================================


model Session {
  id        String   @id @default(cuid())
  date      String   @unique // YYYY-MM-DD format
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  
  @@index([date])
}
```


## Table Descriptions


### Topic
**Purpose**: Top-level content organization (e.g., "Communication Foundations")


**Fields**:
- `id`: Unique identifier
- `title`: Display name
- `description`: Brief overview (2-3 sentences)
- `order`: Sort order for display
- `lessons`: One-to-many relationship with Lesson


**Example**:
```json
{
  "id": "topic_1",
  "title": "Communication Foundations",
  "description": "Master the basics of emotional connection through Gottman's research and consent-first communication.",
  "order": 1
}
```


### Lesson
**Purpose**: Individual learning modules with content + quiz


**Fields**:
- `slug`: URL-friendly identifier (e.g., "active-listening")
- `content`: Full Markdown text (rendered on lesson page)
- `estimatedMinutes`: Reading + quiz time estimate
- `learningObjectives`: JSON array of goals (e.g., `["Identify Gottman's 'bids'", "Practice turning towards"]`)


**Example**:
```json
{
  "id": "lesson_1",
  "topicId": "topic_1",
  "title": "Active Listening & Bids for Connection",
  "slug": "active-listening",
  "content": "# Active Listening...",
  "estimatedMinutes": 12,
  "learningObjectives": "[\"Identify bids\", \"Practice responses\"]",
  "order": 1
}
```


### Question
**Purpose**: Quiz/review questions linked to lessons


**Fields**:
- `type`: "mcq" or "short_answer"
- `options`: JSON array for MCQ (e.g., `["Option A", "Option B"]`)
- `correctAnswer`: For MCQ, index (e.g., `"0"`); for short_answer, sample answers JSON
- `explanation`: Feedback shown after answering


**MCQ Example**:
```json
{
  "id": "q_1",
  "lessonId": "lesson_1",
  "type": "mcq",
  "question": "What is a 'bid' in Gottman's terminology?",
  "options": "[\"Request for connection\", \"Argument tactic\", \"Compliment\", \"Apology\"]",
  "correctAnswer": "0",
  "explanation": "A bid is any attempt to connect..."
}
```


**Short Answer Example**:
```json
{
  "id": "q_2",
  "type": "short_answer",
  "question": "Describe one brake from Nagoski's model you experience.",
  "correctAnswer": "[\"Stress\", \"Fatigue\", \"Distractions\"]",
  "explanation": "Common brakes include..."
}
```


### QuizAttempt
**Purpose**: Track each quiz completion


**Fields**:
- `score`: Number of correct answers
- `total`: Total questions in quiz
- `timeSpent`: Optional (seconds to complete)
- `questionAttempts`: One-to-many with QuestionAttempt


### QuestionAttempt
**Purpose**: Individual question responses within a quiz


**Fields**:
- `answer`: User's raw answer (text or option index)
- `correct`: Boolean (calculated server-side)
- `quality`: User's self-rating (0-5)


### ReviewItem
**Purpose**: Spaced repetition state for each question


**Fields**:
- `easinessFactor`: SM-2 difficulty metric (1.3-2.5)
- `intervalDays`: Days until next review
- `repetitions`: Successful review count
- `dueAt`: DateTime when review is due
- `lapseCount`: Times user forgot (for analytics)


**State Progression**:
```
New Question → First Review (1 day) → Second Review (6 days) 
  → Third Review (14 days) → Fourth Review (~35 days) → ...
```


### Ritual
**Purpose**: Seed data for daily/weekly connection activities


**Fields**:
- `type`: "daily" or "weekly"
- `title`: "20-second hug", "2-minute check-in", etc.
- `description`: Instructions and purpose


**Example**:
```json
{
  "id": "ritual_1",
  "title": "20-Second Hug",
  "description": "A sustained hug lasting at least 20 seconds releases oxytocin...",
  "type": "daily",
  "order": 1
}
```


### RitualLog
**Purpose**: Track ritual completion


**Fields**:
- `date`: YYYY-MM-DD string (unique per ritual per day)
- `notes`: Optional reflection


**Constraint**: `@@unique([ritualId, date])` prevents duplicate logs


### Reflection
**Purpose**: Store user's metacognitive reflections


**Fields**:
- `type`: Context (quiz, weekly, ritual)
- `content`: User's text
- `metadata`: JSON with related IDs


### Session
**Purpose**: Track daily activity for streak calculation


**Fields**:
- `date`: YYYY-MM-DD (unique)
- `active`: Boolean (did user do anything today?)


**Streak Logic**:
```typescript
function calculateStreak(): number {
  const sessions = await db.session.findMany({
    where: { active: true },
    orderBy: { date: 'desc' }
  });
  
  let streak = 0;
  let currentDate = new Date();
  
  for (const session of sessions) {
    if (isSameOrPreviousDay(session.date, currentDate)) {
      streak++;
      currentDate = new Date(session.date);
      currentDate.setDate(currentDate.getDate() - 1);
    } else {
      break;
    }
  }
  
  return streak;
}
```


## Relationships Diagram


```
Topic
  └─→ Lesson (many)
        ├─→ Question (many)
        │     ├─→ QuestionAttempt (many)
        │     └─→ ReviewItem (one)
        └─→ QuizAttempt (many)
              └─→ QuestionAttempt (many)


Ritual
  └─→ RitualLog (many)


(Reflection and Session are standalone)
```


## Seed Data Structure


### Seed Script Overview
**File**: `prisma/seed.ts`


**What it populates**:
1. **3 Topics** (Communication, Arousal, Mindfulness)
2. **2 Lessons per topic** (6 total)
3. **5 Questions per lesson** (30 total)
4. **4 Daily rituals** (hug, check-in, gratitude, prayer)
5. **3 Weekly rituals** (date night, sensate focus, reflection)


### Sample Topic Seed
```typescript
const topics = [
  {
    title: "Communication Foundations",
    description: "Master emotional connection through research-backed communication strategies and consent frameworks.",
    order: 1,
    lessons: [
      {
        title: "Active Listening & Bids for Connection",
        slug: "active-listening",
        content: readFileSync('./content/topics/communication-foundations/01-active-listening.md', 'utf-8'),
        estimatedMinutes: 12,
        learningObjectives: JSON.stringify([
          "Identify Gottman's 'bids' for connection",
          "Practice turning towards responses",
          "Recognize turning away and turning against patterns"
        ]),
        order: 1,
        questions: [
          {
            type: "mcq",
            question: "What is a 'bid' in Gottman's terminology?",
            options: JSON.stringify([
              "An attempt to connect emotionally",
              "A way to win an argument",
              "A form of manipulation",
              "A romantic gesture"
            ]),
            correctAnswer: "0",
            explanation: "A bid is any attempt—verbal or nonverbal—to connect with your partner...",
            order: 1
          },
          // ... 4 more questions
        ]
      },
      // ... 1 more lesson
    ]
  },
  // ... 2 more topics
];
```


### Content File Structure
**Location**: `content/topics/[topic-slug]/[lesson-number]-[lesson-slug].md`


**Example**: `content/topics/communication-foundations/01-active-listening.md`


```markdown
# Active Listening & Bids for Connection


## Learning Objectives
By the end of this lesson, you will be able to:
- Identify emotional bids in everyday interactions
- Practice "turning towards" responses
- Recognize patterns of turning away or against


## What Are Bids?


Dr. John Gottman's research on couples revealed a simple but profound insight: **the small moments matter most**. A "bid" is any attempt to connect—verbal or nonverbal...


## The Three Responses


When your partner makes a bid, you have three options...


[Full lesson content continues...]
```


## Migration Strategy


### Initial Setup
```bash
npx prisma migrate dev --name init
npx prisma db seed
```


### Adding Fields (Example: Add `difficulty` to Question)
```bash
# 1. Update schema.prisma
model Question {
  // ... existing fields
  difficulty String @default("medium") // 'easy' | 'medium' | 'hard'
}


# 2. Create migration
npx prisma migrate dev --name add_question_difficulty


# 3. Backfill existing data
npx prisma db execute --stdin < backfill-difficulty.sql
```


### Data Export/Import
```typescript
// Export all data
async function exportData() {
  const data = {
    topics: await db.topic.findMany({ include: { lessons: { include: { questions: true } } } }),
    rituals: await db.ritual.findMany(),
    quizAttempts: await db.quizAttempt.findMany({ include: { questionAttempts: true } }),
    reviewItems: await db.reviewItem.findMany(),
    // ...
  };
  
  writeFileSync('./backup.json', JSON.stringify(data, null, 2));
}


// Import from backup
async function importData(backup: any) {
  await db.$transaction(async (tx) => {
    // Delete existing data
    await tx.questionAttempt.deleteMany();
    await tx.quizAttempt.deleteMany();
    // ... (in reverse FK order)
    
    // Re-create from backup
    for (const topic of backup.topics) {
      await tx.topic.create({ data: topic });
    }
    // ...
  });
}
```
```


#### Content Authoring + Import Spec
```markdown
# Content Authoring + Import Specification


## Content Format Standards


### Lesson Content (Markdown)


**File Naming**: `[order]-[slug].md` (e.g., `01-active-listening.md`)


**Required Frontmatter**:
```yaml
---
title: Active Listening & Bids for Connection
slug: active-listening
topic: communication-foundations
estimatedMinutes: 12
learningObjectives:
  - Identify Gottman's 'bids' for connection
  - Practice turning towards responses
  - Recognize turning away/against patterns
---
```


**Content Structure**:
```markdown
# [Lesson Title]


## Learning Objectives
[Bulleted list matching frontmatter]


## Introduction
[Hook + relevance]


## Main Content
[Sections with ## headers]


### Subsection Example
[Explanations, examples, research citations]


## Key Takeaways
[3-5 bullet summary]


## Reflection Prompt
[Optional: Question for user to ponder]


## Resources
[Optional: Links to research papers, videos]
```


**Markdown Guidelines**:
- Use `##` for sections, `###` for subsections
- Bold key terms on first use: `**bid**`
- Use block quotes for important warnings:
  ```markdown
  > **Important**: Always prioritize consent and communication.
  ```
- Code blocks for examples (if applicable)
- No raw HTML (keep it portable)


### Question Bank (JSON)


**File Naming**: `[topic-slug].json`


**Structure**:
```json
{
  "topic": "communication-foundations",
  "lessons": [
    {
      "lessonSlug": "active-listening",
      "questions": [
        {
          "type": "mcq",
          "question": "What is a 'bid' in Gottman's terminology?",
          "options": [
            "An attempt to connect emotionally",
            "A way to win an argument",
            "A form of manipulation",
            "A romantic gesture"
          ],
          "correctAnswer": 0,
          "explanation": "A bid is any attempt—verbal or nonverbal—to connect with your partner. Examples include sharing a thought, asking a question, or physical touch.",
          "order": 1
        },
        {
          "type": "short_answer",
          "question": "Describe a recent 'bid' your partner made toward you. How did you respond?",
          "sampleAnswers": [
            "They asked about my day, and I put down my phone to listen",
            "They touched my shoulder, and I leaned into the touch",
            "They shared a worry, and I validated their feelings"
          ],
          "explanation": "Turning towards bids strengthens connection. Even small acknowledgments matter.",
          "order": 2
        }
        // ... 3 more questions
      ]
    }
    // ... more lessons
  ]
}
```


**Question Validation Rules**:
- MCQ must have 4 options (no more, no fewer)
- `correctAnswer` is 0-indexed integer for MCQ
- `sampleAnswers` array for short_answer (2-3 examples)
- `explanation` is required (shown after answering)
- `order` determines sequence in quiz


### Ritual Definitions (JSON)


**File**: `content/rituals.json`


```json
{
  "daily": [
    {
      "title": "20-Second Hug",
      "description": "A sustained hug lasting at least 20 seconds releases oxytocin, the 'bonding hormone.' This simple practice reduces stress and increases feelings of safety and connection.",
      "order": 1
    },
    {
      "title": "2-Minute Check-In",
      "description": "Share one high and one low from your day. Listen without trying to fix or advise—just acknowledge and empathize.",
      "order": 2
    }
  ],
  "weekly": [
    {
      "title": "At-Home Date Night",
      "description": "Set aside 60-90 minutes for a distraction-free activity together: cook a meal, play a game, or try a sensate focus exercise. The goal is presence, not perfection.",
      "order": 1
    }
  ]
}
```


## Import Script Specification


### Seed Script (`prisma/seed.ts`)


**Purpose**: Populate database with initial content for MVP.


**Steps**:
1. Parse Markdown frontmatter from lesson files
2. Load question banks (JSON)
3. Load ritual definitions
4. Create Prisma records in correct order (respect FKs)


**Implementation**:
```typescript
import { PrismaClient } from '@prisma/client';
import { readdirSync, readFileSync } from 'fs';
import matter from 'gray-matter';


const db = new PrismaClient();


async function main() {
  console.log('🌱
Seeding database...');


  // ============================================================================
  // 1. LOAD TOPICS + LESSONS FROM MARKDOWN FILES
  // ============================================================================
  
  const topicsDir = './content/topics';
  const topicFolders = readdirSync(topicsDir);
  
  const topicsData = [];
  
  for (const [index, topicSlug] of topicFolders.entries()) {
    const lessonFiles = readdirSync(`${topicsDir}/${topicSlug}`)
      .filter(f => f.endsWith('.md'))
      .sort();
    
    const lessonsData = [];
    
    for (const lessonFile of lessonFiles) {
      const filePath = `${topicsDir}/${topicSlug}/${lessonFile}`;
      const fileContent = readFileSync(filePath, 'utf-8');
      const { data: frontmatter, content } = matter(fileContent);
      
      lessonsData.push({
        title: frontmatter.title,
        slug: frontmatter.slug,
        content: content.trim(),
        estimatedMinutes: frontmatter.estimatedMinutes,
        learningObjectives: JSON.stringify(frontmatter.learningObjectives),
        order: parseInt(lessonFile.split('-')[0]),
      });
    }
    
    topicsData.push({
      title: toTitleCase(topicSlug),
      slug: topicSlug,
      description: getTopicDescription(topicSlug), // Helper function
      order: index + 1,
      lessons: lessonsData,
    });
  }
  
  // ============================================================================
  // 2. LOAD QUESTION BANKS
  // ============================================================================
  
  const questionBanks: Record<string, any> = {};
  
  for (const topic of topicsData) {
    const questionFile = `./content/questions/${topic.slug}.json`;
    const questionData = JSON.parse(readFileSync(questionFile, 'utf-8'));
    questionBanks[topic.slug] = questionData;
  }
  
  // ============================================================================
  // 3. CREATE TOPICS, LESSONS, QUESTIONS
  // ============================================================================
  
  for (const topicData of topicsData) {
    const topic = await db.topic.create({
      data: {
        title: topicData.title,
        description: topicData.description,
        order: topicData.order,
      },
    });
    
    console.log(`  ✓ Topic: ${topic.title}`);
    
    for (const lessonData of topicData.lessons) {
      const lesson = await db.lesson.create({
        data: {
          topicId: topic.id,
          title: lessonData.title,
          slug: lessonData.slug,
          content: lessonData.content,
          estimatedMinutes: lessonData.estimatedMinutes,
          learningObjectives: lessonData.learningObjectives,
          order: lessonData.order,
        },
      });
      
      console.log(`    ✓ Lesson: ${lesson.title}`);
      
      // Find questions for this lesson
      const questionBank = questionBanks[topicData.slug];
      const lessonQuestions = questionBank.lessons.find(
        (l: any) => l.lessonSlug === lessonData.slug
      )?.questions || [];
      
      for (const q of lessonQuestions) {
        const question = await db.question.create({
          data: {
            lessonId: lesson.id,
            type: q.type,
            question: q.question,
            options: q.options ? JSON.stringify(q.options) : null,
            correctAnswer: q.type === 'mcq' 
              ? String(q.correctAnswer) 
              : JSON.stringify(q.sampleAnswers),
            explanation: q.explanation,
            order: q.order,
          },
        });
        
        console.log(`      ✓ Question: ${question.question.substring(0, 50)}...`);
      }
    }
  }
  
  // ============================================================================
  // 4. CREATE RITUALS
  // ============================================================================
  
  const ritualsFile = './content/rituals.json';
  const ritualsData = JSON.parse(readFileSync(ritualsFile, 'utf-8'));
  
  for (const ritual of ritualsData.daily) {
    await db.ritual.create({
      data: {
        title: ritual.title,
        description: ritual.description,
        type: 'daily',
        order: ritual.order,
      },
    });
    console.log(`  ✓ Daily Ritual: ${ritual.title}`);
  }
  
  for (const ritual of ritualsData.weekly) {
    await db.ritual.create({
      data: {
        title: ritual.title,
        description: ritual.description,
        type: 'weekly',
        order: ritual.order,
      },
    });
    console.log(`  ✓ Weekly Ritual: ${ritual.title}`);
  }
  
  console.log('✅ Seed complete!');
}


// ============================================================================
// HELPER FUNCTIONS
// ============================================================================


function toTitleCase(slug: string): string {
  return slug
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}


function getTopicDescription(slug: string): string {
  const descriptions: Record<string, string> = {
    'communication-foundations': 'Master emotional connection through research-backed communication strategies and consent frameworks.',
    'understanding-arousal': 'Learn the science of desire, arousal, and pleasure through evidence-based models.',
    'mindfulness-presence': 'Develop presence and body awareness for deeper intimacy and connection.',
  };
  return descriptions[slug] || '';
}


// ============================================================================
// RUN SEED
// ============================================================================


main()
  .catch((e) => {
    console.error('❌ Seed failed:', e);
    process.exit(1);
  })
  .finally(async () => {
    await db.$disconnect();
  });
```


### Content Validation Script


**File**: `scripts/validate-content.ts`


**Purpose**: Check content before seeding to catch errors early.


```typescript
import { readdirSync, readFileSync } from 'fs';
import matter from 'gray-matter';


const errors: string[] = [];
const warnings: string[] = [];


// Validate lesson files
function validateLessons() {
  const topicsDir = './content/topics';
  const topicFolders = readdirSync(topicsDir);
  
  for (const topicSlug of topicFolders) {
    const lessonFiles = readdirSync(`${topicsDir}/${topicSlug}`)
      .filter(f => f.endsWith('.md'));
    
    for (const lessonFile of lessonFiles) {
      const filePath = `${topicsDir}/${topicSlug}/${lessonFile}`;
      const fileContent = readFileSync(filePath, 'utf-8');
      
      try {
        const { data: frontmatter, content } = matter(fileContent);
        
        // Check required frontmatter
        if (!frontmatter.title) {
          errors.push(`${filePath}: Missing 'title' in frontmatter`);
        }
        if (!frontmatter.slug) {
          errors.push(`${filePath}: Missing 'slug' in frontmatter`);
        }
        if (!frontmatter.learningObjectives || !Array.isArray(frontmatter.learningObjectives)) {
          errors.push(`${filePath}: 'learningObjectives' must be an array`);
        }
        
        // Check content length
        if (content.trim().length < 500) {
          warnings.push(`${filePath}: Content seems short (<500 chars)`);
        }
        
        // Check for common mistakes
        if (content.includes('TODO') || content.includes('FIXME')) {
          warnings.push(`${filePath}: Contains TODO/FIXME`);
        }
        
      } catch (e) {
        errors.push(`${filePath}: Failed to parse - ${e.message}`);
      }
    }
  }
}


// Validate question banks
function validateQuestions() {
  const topicsDir = './content/topics';
  const topicFolders = readdirSync(topicsDir);
  
  for (const topicSlug of topicFolders) {
    const questionFile = `./content/questions/${topicSlug}.json`;
    
    try {
      const questionData = JSON.parse(readFileSync(questionFile, 'utf-8'));
      
      for (const lesson of questionData.lessons) {
        for (const q of lesson.questions) {
          // Validate MCQ
          if (q.type === 'mcq') {
            if (!Array.isArray(q.options) || q.options.length !== 4) {
              errors.push(`${questionFile} (${lesson.lessonSlug}): MCQ must have exactly 4 options`);
            }
            if (typeof q.correctAnswer !== 'number' || q.correctAnswer < 0 || q.correctAnswer > 3) {
              errors.push(`${questionFile} (${lesson.lessonSlug}): correctAnswer must be 0-3`);
            }
          }
          
          // Validate short_answer
          if (q.type === 'short_answer') {
            if (!Array.isArray(q.sampleAnswers) || q.sampleAnswers.length < 2) {
              errors.push(`${questionFile} (${lesson.lessonSlug}): short_answer needs 2+ sampleAnswers`);
            }
          }
          
          // Common validations
          if (!q.question || q.question.length < 10) {
            errors.push(`${questionFile}: Question text too short`);
          }
          if (!q.explanation || q.explanation.length < 20) {
            errors.push(`${questionFile}: Explanation too short`);
          }
        }
      }
    } catch (e) {
      errors.push(`${questionFile}: Failed to parse - ${e.message}`);
    }
  }
}


// Run validations
validateLessons();
validateQuestions();


// Report results
if (errors.length > 0) {
  console.error('❌ ERRORS:');
  errors.forEach(e => console.error(`  - ${e}`));
  process.exit(1);
}


if (warnings.length > 0) {
  console.warn('⚠️  WARNINGS:');
  warnings.forEach(w => console.warn(`  - ${w}`));
}


console.log('✅ Content validation passed!');
```


## Versioning & Updates


### Content Versioning Strategy


**Problem**: Users have completed lessons/quizzes. If content updates, how do we handle existing progress?


**Solution**: Content versioning with backward compatibility.


```prisma
model Lesson {
  // ... existing fields
  version     Int      @default(1)
  archivedAt  DateTime?
  
  @@index([slug, version])
}


model Question {
  // ... existing fields
  version     Int      @default(1)
  archivedAt  DateTime?
}
```


**Update Process**:
1. New content version created (v2)
2. Old version marked as archived
3. User progress remains valid (linked to v1)
4. New users get v2
5. Returning users see "Updated content available" prompt


### Migration Script Example


```typescript
// scripts/update-lesson.ts


async function updateLesson(slug: string, newContent: string) {
  // 1. Find current lesson
  const currentLesson = await db.lesson.findFirst({
    where: { slug, archivedAt: null },
  });
  
  if (!currentLesson) throw new Error('Lesson not found');
  
  // 2. Archive current version
  await db.lesson.update({
    where: { id: currentLesson.id },
    data: { archivedAt: new Date() },
  });
  
  // 3. Create new version
  await db.lesson.create({
    data: {
      ...currentLesson,
      id: undefined, // Generate new ID
      content: newContent,
      version: currentLesson.version + 1,
      archivedAt: null,
      createdAt: new Date(),
      updatedAt: new Date(),
    },
  });
  
  console.log(`✓ Updated lesson ${slug} to v${currentLesson.version + 1}`);
}
```


## Content Guidelines Reference


### Writing Style
- **Tone**: Warm, professional, non-judgmental
- **POV**: Second person ("you") for connection
- **Length**: 800-1500 words per lesson (10-12 min read)
- **Citations**: Include researcher names inline (e.g., "Dr. Gottman found...")


### Safety Reminders
- Include consent reminder every 2-3 lessons
- Medical disclaimer on any physiology content
- Conflict warning on sensitive topics (desire discrepancy, porn effects)


### Accessibility
- Alt text for any images: `![Woman and man hugging](hug.jpg "20-second embrace")`
- Heading hierarchy (no skipped levels)
- No color-only information
```


---


## CODEX PROMPT (Ready to Paste)


Now, here's the **complete prompt** to paste into Codex in VS Code on WSL:


```
ROLE: You are a senior full-stack engineer working inside VS Code on WSL. Build an MVP learning app for expertise in intimate relationships within a Christian marriage framework, using evidence-based learning loops (retrieval practice + spaced repetition + feedback + reflection).


STACK (MVP): 
- Next.js 15 (App Router) + TypeScript 5 (strict mode)
- Tailwind CSS 3 + shadcn/ui components
- Prisma 5 + SQLite (better-sqlite3)
- Vitest + Testing Library


DELIVERABLE: In this repo, create:


1. /docs/ folder with complete Markdown documentation:
   - 01-vision.md
   - 02-mvp.md
   - 03-user-stories.md
   - 04-learning-model.md
   - 05-question-bank.md
   - 06-spaced-repetition.md
   - 07-data-model.md
   - 08-architecture.md
   - 09-safety-boundaries.md


2. A working Next.js web app with these routes:
   - / → Dashboard (today's plan: reviews + next lesson + ritual status + streak)
   - /topics → List all topics with mastery %
   - /topics/[id] → Topic detail (lessons list + overall mastery)
   - /lessons/[id] → Lesson reader (Markdown rendered) + "Start Quiz" button
   - /quiz/[lessonId] → Quiz runner (5 questions: MCQ + short answer) with immediate feedback + quality rating (0-5)
   - /review → Spaced repetition queue (due questions, sorted by dueAt)
   - /rituals → Daily/weekly connection activity checklist + notes
   - /summary → Weekly analytics (streak, mastery by topic, weakest areas)


3. Database schema (Prisma) with these tables:
   - Topic, Lesson, Question, QuizAttempt, QuestionAttempt, ReviewItem, Ritual, RitualLog, Reflection, Session


4. Seed data:
   - 3 topics: "Communication Foundations", "Understanding Arousal", "Mindfulness & Presence"
   - 2 lessons per topic (6 total)
   - 5 questions per lesson (30 total: mix of MCQ and short answer)
   - Use neutral, educational titles inspired by Christian marriage, intimacy research, consent frameworks, and porn impact studies
   - DO NOT generate explicit sexual content or medical advice
   - 4 daily rituals (20-second hug, 2-minute check-in, gratitude sharing, prayer moment)
   - 3 weekly rituals (date night, sensate focus session, weekly reflection)


5. Implement SM-2 spaced repetition scheduler:
   - After each question attempt, calculate: easinessFactor, intervalDays, dueAt
   - Quality 0-2 = lapse (reset to 1 day)
   - Quality 3-5 = success (increase interval exponentially)
   - Store full review history in ReviewItem table


6. API routes:
   - POST /api/quiz/submit → Create QuizAttempt + QuestionAttempts, schedule reviews
   - POST /api/review/submit → Update ReviewItem with new schedule
   - POST /api/rituals/log → Create RitualLog entry


7. Basic tests:
   - Unit tests for lib/scheduler.ts (SM-2 algorithm edge cases)
   - Unit tests for lib/analytics.ts (mastery calculations)
   - Integration tests for API routes (with mock DB)
   - Aim for 80%+ coverage on scheduler logic


8. UI Components (shadcn/ui):
   - Use shadcn/ui for Button, Card, Progress, RadioGroup, Textarea, etc.
   - Dashboard with cards for reviews, next lesson, rituals
   - Quiz interface with question cards, immediate feedback, quality rating (0-5 slider)
   - Review queue with card-flip interaction
   - Streak indicator (fire emoji + number)


CONSTRAINTS:
- Local-first (SQLite, no cloud services)
- No authentication (single-user MVP)
- No medical claims, no coercive relationship advice, no explicit sexual instructions
- All intimacy content emphasizes consent and communication
- Include safety warnings where appropriate (conflict, medical referral)
- Keep code clean, typed (TypeScript strict), and well-organized


OUTPUT REQUIRED:
1. Create all files and code
2. Provide exact commands to run:
   - Installation: npm install (or pnpm, yarn)
   - Database setup: npx prisma generate && npx prisma db push
   - Seed data: npx prisma db seed
   - Dev server: npm run dev
   - Tests: npm run test
3. Use stable current versions (Next.js 15, Prisma 5, TypeScript 5)
4. Ensure app runs on localhost:3000 with no errors


START NOW: 
1. Initialize Next.js project with TypeScript + Tailwind
2. Set up Prisma with SQLite
3. Create schema with all tables
4. Implement seed script with sample content
5. Build UI components + pages
6. Implement quiz/review flow end-to-end
7. Add scheduler logic + tests
8. Verify everything works


GO!
```


---


## Additional Setup Commands


After Codex generates the project, you'll run:


```bash
# Install dependencies
npm install


# Install shadcn/ui components
npx shadcn-ui@latest init
npx shadcn-ui@latest add button card progress radio-group textarea badge separator


# Install additional dependencies
npm install gray-matter date-fns zod


# Set up database
npx prisma generate
npx prisma db push
npx prisma db seed


# Run development server
npm run dev


# Open browser to http://localhost:3000


# Run tests
npm run test
```


---


## Success Criteria Checklist


After Codex completes, verify:


- [ ] App loads at `http://localhost:3000` without errors
- [ ] Dashboard shows correct counts (0 reviews initially)
- [ ] Can navigate to Topics → Lesson → Quiz
- [ ] Quiz submission creates ReviewItem records
- [ ] Review queue shows due questions (next day)
- [ ] Quality ratings (0-5) correctly update scheduler
- [ ] Rituals can be logged with notes
- [ ] Weekly summary shows streak + mastery
- [ ] Tests pass: `npm run test`
- [ ] No TypeScript errors: `npx tsc --noEmit`
- [ ] Database persists on restart (check `prisma/dev.db`)


---


This specification is **production-ready** and gives Codex everything needed to build a fully functional MVP. The documentation is comprehensive, technically accurate, and respects all safety/consent boundaries while delivering a scientifically-grounded learning system.
















      3. User Stories + Acceptance Criteria (engineer-ready)

         * Eg. “As Josh, I can complete a 5-question quiz from a lesson and get scheduled reviews.”


         4. Content Taxonomy + Competency Map

            * Topics → modules → lessons → skills → “mastery checks”.
            * Seed topics from your PDFs (marriage foundations, at-home connection rituals, sexuality within Christian marriage, porn effects, etc.).
________________


2) Learning science + quiz design (this is the “scientifically proven” core)
            5. Learning Model Spec (how people improve)

               * Retrieval practice, spaced repetition, interleaving, feedback, reflection, overlearning rules.
               * Define your “daily loop” (10–15 min) and “weekly loop” (30–60 min).
               6. Question Bank Spec

                  * Question types you’ll support: MCQ, short answer, scenario, “explain like I’m five”, reflection prompts.
                  * Rules for good questions (single concept, plausible distractors, immediate feedback).
                  7. Spaced Repetition Spec

                     * Pick algorithm (SM-2 variant is fine), define scheduling fields + lapse rules.
                     8. Mastery + Analytics Spec

                        * What counts as “mastered”? (e.g., 90%+ over last N reviews, or stable interval threshold)
                        * What charts you’ll show (streak, mastery by topic, weakest skills).
________________


3) Relationship + spiritual integration (without being weird or unsafe)
                        9. Rituals & Check-ins Spec

                           * “2-minute check-in”, “20-second hug”, prayer/Scripture prompts, at-home date templates.
                           * Consent + tone guidelines (never coercive, never guilt-driven).
                           10. Safety + Boundaries Policy

                              * Clear guardrails: no coercion, no explicit sexual content, no medical diagnosis, no “pressure Kristy” content.
                              * Escalation guidance: “if this brings conflict, pause and consider counselling / GP”.
________________


4) Engineering docs (so Codex builds the right thing)
                              11. Technical Architecture (MVP)
                              * Stack choice (recommended for WSL): Next.js + TypeScript + Tailwind + SQLite + Prisma
                              * Data model overview + API routes overview.
                              12. Data Model Spec (tables + fields)
                              * Topics, Lessons, Questions, Attempts, ReviewSchedule, Reflections, Rituals, Sessions.
                              13. Content Authoring + Import Spec
                              * Markdown format for lessons/questions + a script to import into DB.
                              * Versioning + IDs so you can safely edit content later.
                              14. Security + Privacy Notes
                              * Local-first by default, encryption-at-rest optional, backups, no cloud until you choose.
                              15. Test Plan
                              * Unit tests for scheduling + scoring; e2e for “take quiz → schedule review → review”.
________________


Prompt 1 for Codex (VS Code on WSL)
Paste this as-is into Codex:
ROLE: You are a senior full-stack engineer working inside VS Code on WSL. Build an MVP learning app for “expertise + marriage connection” using evidence-based learning loops (retrieval + spaced repetition + feedback + reflection).
STACK (MVP): Next.js (App Router) + TypeScript + Tailwind + shadcn/ui + Prisma + SQLite.
DELIVERABLE: In this repo, create:
                              1. /docs/ with Markdown docs: 01-vision.md, 02-mvp.md, 03-user-stories.md, 04-learning-model.md, 05-question-bank.md, 06-spaced-repetition.md, 07-data-model.md, 08-architecture.md, 09-safety-boundaries.md.
                              2. A working web app with these routes:
                              * / Dashboard (today’s plan: reviews + 1 quiz + 1 ritual)
                              * /topics list topics
                              * /topics/[id] topic detail (lessons + mastery)
                              * /lessons/[id] lesson reader (markdown render) + “Start Quiz”
                              * /quiz/[lessonId] quiz runner (MCQ + short answer) with instant feedback
                              * /review spaced repetition queue (cards/questions due)
                              * /rituals simple connection checklist + reflection log
                              3. Database schema with Prisma for: Topic, Lesson, Question, QuizAttempt, QuestionAttempt, ReviewItem, Reflection, Ritual, RitualLog.
                              4. Seed data with 3 topics and 2 lessons each, and 5 questions per lesson. Use neutral titles inspired by the provided PDFs (Christian marriage, intimacy, at-home dates, porn impacts) but do NOT generate explicit sexual content.
                              5. Implement a simple SM-2-style scheduler: after each question attempt, store quality (0-5), update easinessFactor, intervalDays, dueAt. Lapses reset interval.
                              6. Add basic tests for scheduler logic.
CONSTRAINTS:
                              * Keep it local-first (SQLite). No external services required.
                              * No medical claims, no coercive relationship advice, no explicit sexual instructions.
                              * Keep code clean and runnable.
OUTPUT REQUIRED:
                              * Create the files and code.
                              * Provide exact commands to run: install, migrate, seed, dev server, tests.
                              * If you need to choose versions, pick stable current defaults.
START NOW: Scaffold the repo, implement the Prisma schema + seed, then implement the minimal UI and quiz/review loop end-to-end.
________________


If you want, next message I can turn your PDFs into a Topic → Lesson → Question bank blueprint (titles + learning objectives + quiz styles) so you can seed the app with content that matches what you actually care about.




# Vision + Outcomes for the GoodNik App


## Vision
The GoodNik app is designed to empower Josh in mastering sexual intimacy within a Christian marriage framework, focusing on becoming an unparalleled expert in pleasuring Kristy through every conceivable technique, position, and sensory exploration that enhances her arousal, orgasmic intensity, and overall ecstasy. This vision extends beyond physical acts to foster profound emotional and spiritual bonds, ensuring that sexual encounters result in the most explosive, multi-orgasmic experiences for both partners while aligning with principles of mutual consent, respect, and biblical values of oneness in marriage (e.g., Genesis 2:24, Song of Solomon). By integrating evidence-based insights from leading sexologists, the app transforms routine intimacy into transcendent, orgasm-centered connections that prioritize Kristy's pleasure—making her feel desired, ravished, and deeply loved—while helping Josh overcome any barriers like performance anxiety or porn-influenced distortions.


Drawing from initial content sources in the uploaded PDFs (e.g., "Thriving Sexual Intimacy in Christian Marriage," "Restoring and Strengthening a Christian Marriage," "Holistic Attraction & Seduction Plan," porn impact studies from PubMed and APA, and date idea compilations), the app starts with v0 content emphasizing privacy, consent, and avoiding porn triggers. These sources highlight self-reports on satisfaction, emotional closeness, conflict repair, and orgasm quality, ensuring the app respects Kristy's autonomy while guiding Josh toward expert-level proficiency in delivering mind-blowing orgasms through clitoral stimulation, G-spot targeting, anal play (if consensual), edging techniques, and multi-sensory foreplay. The ultimate goal is a marriage where sex is not just frequent but extraordinarily fulfilling, with orgasms that leave Kristy quivering in waves of pleasure, strengthening the emotional-spiritual union and reducing any negative porn effects like desensitization or unrealistic expectations.


Incorporating diverse sexologist perspectives:


- **Esther Perel** (Mating in Captivity): Emphasizes maintaining erotic mystery in long-term relationships to fuel desire, suggesting playful teasing and novelty to build anticipation for intense orgasms, viewing sex as a gateway to deepest emotional places where pleasure triggers passion, joy, and love.


- **Emily Nagoski** (Come As You Are): Introduces the Dual Control Model, where accelerators (e.g., erotic stimuli like nipple play or dirty talk) amp up arousal, while removing brakes (stress, fatigue) allows for easier, more powerful orgasms; app modules will teach identifying Kristy's personal accelerators for squirting or full-body climaxes.




- **Rosemary Basson**: Her circular model of female sexual response highlights that women's desire often emerges from arousal rather than preceding it, so starting with non-genital touch builds to responsive desire, leading to multiple orgasms through cycles of pleasure and satisfaction






- **Peggy Kleinplatz**: Defines optimal sexuality through eight components like deep erotic intimacy, extraordinary communication, and being fully present, enabling "magnificent sex" with transcendent pleasure, vulnerability, and connection that elevates orgasms to spiritual highs








- **Lori Brotto**: Advocates mindfulness to heighten bodily sensations, improving orgasm quality by unifying mind and body, reducing distractions for more intense, connected climaxes during penetration or oral sex.








- **Ian Kerner** (She Comes First): Focuses on cunnilingus mastery with techniques like rhythmic tongue circles on the clitoris, building tension for clitoral orgasms, ensuring Kristy achieves ecstasy before intercourse for mutual fulfillment.




- **Barry McCarthy**: Promotes intimacy-based sex therapy, integrating emotional bonds with erotic play to enhance pleasure, using shared exploration of erogenous zones for deeper orgasms and relational security








- **John Gottman** (Sound Relationship House): Builds emotional intimacy through love maps and turning towards bids, creating a foundation where sex reinforces trust and fondness, leading to more vulnerable, orgasmic encounters.




- **Sue Johnson** (Emotionally Focused Therapy): Views sex through attachment lenses, where secure bonds allow open exploration of desires, turning physical pleasure into emotional healing and intensified orgasms




- **Masters and Johnson**: Their sensate focus technique encourages non-goal-oriented touch to build arousal gradually, reducing anxiety for spontaneous, powerful orgasms through full-body exploration.






This holistic vision ensures the app evolves from Christian-rooted content to expert-guided explicit mastery, always prioritizing consent and avoiding coercion.


## Outcomes
### What "Expert" Means: Measurable Competencies
Becoming an "expert" in pleasuring Kristy involves mastering techniques for every facet of her pleasure, measured by self-reported metrics from app quizzes, reflections, and weekly summaries. Competencies include:
- **Clitoral Mastery (Kerner-inspired)**: Achieve 90% success in inducing clitoral orgasms via oral techniques like flat-tongue lapping, suction, and vibration simulation, tracking frequency of Kristy's vocalized peak pleasure (e.g., 5+ sessions/week with multi-orgasms)










- **G-Spot and Internal Stimulation (Nagoski/Basson)**: Expertly locate and stimulate the G-spot with curved fingers or angled penetration for squirting orgasms, measuring via orgasm intensity scales (1-10, aiming for 8+ consistently), incorporating accelerators like simultaneous clitoral touch.










- **Anal and Full-Body Exploration (Kleinplatz/McCarthy)**: If consensual, introduce gentle anal play (fingering, toys) for blended orgasms, with metrics on erotic intimacy depth (e.g., post-session connection ratings) and pleasure variety (tracking 10+ positions/erogenous zones per month).






- **Edging and Multi-Orgasmic Build-Up (Brotto/Perel)**: Use mindfulness to edge Kristy toward orgasm thresholds, delaying release for amplified climaxes, measured by orgasm count per session (target: 3-5) and duration variability from PDFs (e.g., extending pleasure waves)










- **Porn Impact Mitigation**: From PDF sources on porn effects, competencies include shifting from visual fixation to sensory focus, measured by reduced desensitization (e.g., easier arousal without aids, per self-reports).


Mastery threshold: 90% quiz accuracy on techniques, stable review intervals in spaced repetition.


### What "Connection with Kristy + Self" Means: Measurable Habits/Rituals
Connection manifests as intertwined emotional-spiritual bonds amplified by orgasms, measured through daily/weekly rituals:




- **Emotional Bids and Rituals (Gottman/Johnson)**: Daily 20-second hugs or prayer prompts building attachment, tracked by connection scores (e.g., fondness/admiration logs, aiming for 80% positive bids), leading to post-orgasm cuddling for oxytocin-fueled bonding.






- **Sensate Focus Sessions (Masters and Johnson)**: Weekly non-sexual touch rituals evolving to erotic play, measuring self-connection via reflection prompts on bodily awareness and mutual pleasure peaks.


</argument>
</grok:render>




- **Mindful Orgasm Sharing (Brotto/Kleinplatz)**: Habits like shared breathing during climax for synchronized orgasms, tracked by emotional closeness scales (e.g., pre/post-session ratings) and rituals from date idea PDFs (at-home dates with teasing foreplay).- *


*Erotic Communication (Perel/McCarthy)**: Daily discussions of fantasies without judgment, measured by orgasm satisfaction feedback loops, ensuring spiritual alignment from Christian marriage PDFs.


Outcomes tracked via app analytics: Streak maintenance, mastery charts, and weakest areas for growth, aiming for sustained high orgasm quality and connection over 6 months.






Prompt 2
ROLE: You are a senior full-stack engineer continuing development on the HugCoach app repo built from the previous MVP prompt. The app is a local-first Next.js learning platform using spaced repetition to help Josh become an absolute master of female pleasure and orgasms in marriage. The goal is now to make the content MUCH more explicit, detailed, and "spicy" — no censorship, no holding back on anatomical language, techniques, or descriptions. Focus heavily on teaching advanced, proven techniques for giving Kristy intense, multiple, full-body, squirting, and blended orgasms using insights from PhD sexologists (Ian Kerner, Emily Nagoski, Peggy Kleinplatz, Rosemary Basson, Lori Brotto, etc.).
STACK remains: Next.js (App Router) + TypeScript + Tailwind + shadcn/ui + Prisma + SQLite.
PREVIOUS WORK: The repo already has safe, neutral topics (communication, arousal models, mindfulness). Keep those but now ADD a new "Advanced Mastery" section with explicitly sexual topics and lessons. Mark advanced topics as optional/unlockable after basic mastery if possible, but make them fully accessible.
DELIVERABLE: Update the existing repo with the following:
Update /docs/01-vision.md to a spicier version emphasizing mastery of female orgasm techniques (clitoral, G-spot, squirting, edging, blended, multiple, full-body) and explicit pleasuring skills. Explicitly state the goal is for Josh to learn more about female orgasms and sexual techniques than he ever thought possible, drawing directly from Kerner ("She Comes First" oral mastery), Nagoski (Dual Control Model accelerators/brakes), Kleinplatz (components of magnificent sex), etc. Include measurable outcomes like "90% mastery on techniques for inducing squirting orgasms" and "tracking multi-orgasm sessions."
Add new advanced topics to the seed data (in prisma/seed.ts or equivalent):
Topic: "Clitoral Orgasm Mastery" (Inspired by Ian Kerner – She Comes First)
Lessons:
Core Techniques: Tension building, flat tongue strokes, rhythmic consistency, suction, specific patterns (circles, side-to-side, up-down flicks).
Advanced Oral Routines: Full sequences (start slow at perineum → long licks → focused clitoral head → building to climax without stopping).
6-8 explicit questions per lesson (mix MCQ and short answer) testing detailed technique recall.
Topic: "G-Spot Stimulation & Squirting"
Lessons:
Locating and stimulating the G-spot (come-hither motion, firm pressure, simultaneous clitoral touch).
Squirting mechanics and techniques (bearing down, relaxation, building pressure, best positions like doggy or legs-up missionary).
Explicit questions on angles, pressure, and combining with clitoral stim.
Topic: "Edging & Multiple Orgasms"
Lessons:
Edging theory and practice (bringing to the brink 5-10 times, reading body signals, backing off).
Building to 3-10+ orgasms per session, recovery techniques, tantric breathing.
Questions on timing, reading cues, and personal application.
Topic: "Blended & Full-Body Orgasms"
Lessons:
Combining clitoral + G-spot, nipple play, anal (if consensual), A-spot/cervical.
Positions for maximum stimulation (woman on top grinding, doggy with reach-around, prone bone, bridge, etc.).
Types of orgasms (clitoral, vaginal, blended, anal, coregasm, nipple).
Explicit scenario questions.
Topic: "Magnificent Sex Framework" (Peggy Kleinplatz)
Lessons on the 8 components: presence, authenticity, vulnerability, transcendence, extraordinary communication, etc., applied to explicit sexual scenarios.
Topic: "Accelerators & Brakes Mastery" (Emily Nagoski Dual Control Model)
Identifying and maximizing Kristy's personal accelerators (specific touches, dirty talk, settings) while removing brakes for easier, more explosive orgasms.
Update seed data to include 4-6 lessons per advanced topic, each with detailed Markdown content that is fully explicit:
Use anatomical terms (clitoris, vulva, labia, G-spot, urethral sponge, etc.).
Describe techniques step-by-step with intensity, rhythm, pressure, duration.
Include warnings/reminders about consent, communication, and stopping if uncomfortable.
Example lesson excerpt style: "Start with 10 slow, flat-tongue licks from the vaginal entrance to the clitoral head, applying gentle upward pressure. Gradually increase speed while maintaining consistent rhythm — this builds tension essential for powerful clitoral orgasms (Kerner)."
Add explicit quiz questions examples (generate 40-50 total across new topics):
MCQ: "According to Ian Kerner, what is the most important principle for clitoral stimulation? A) Speed B) Consistency of rhythm C) Hard pressure D) Intermittent stopping" (Answer: B)
Short answer: "Describe the 'come-hither' motion for G-spot stimulation and explain how combining it with clitoral touch creates a blended orgasm."
Scenario: "Kristy is close to orgasm but plateaus. What edging technique should you use to push her into multiples?"
Minor UI updates:
Add a toggle or section on dashboard for "Advanced Mastery Mode" that shows/unlocks spicy topics.
In lesson reader, add a "Consent Reminder" banner on advanced lessons.
Add tracking fields if needed (e.g., self-reported orgasm quality logs in reflections, optional).
Keep all previous functionality (SM-2 scheduler, reviews, rituals, dashboard) but enhance ritual suggestions to include spicier options (e.g., "Extended oral pleasure session" or "Edging practice date").
CONSTRAINTS:
REMAIN local-first, privacy-focused.
ALWAYS emphasize enthusiastic consent, communication, and Kristy's comfort/autonomy in every lesson.
Explicit sexual content is REQUIRED and encouraged in advanced sections — be detailed, anatomical, and technique-focused.
NO coercion, pressure, or guilt language.
Base techniques on established sexologists (cite Kerner, Nagoski, Kleinplatz, etc., in lessons).
OUTPUT REQUIRED:
Update existing files (vision.md, seed.ts, etc.).
Add new seed content with explicit lessons/questions.
Provide exact commands: npm run dev, etc.
Ensure the app runs with new spicy content loaded.
START NOW: First update 01-vision.md with the spicier vision, then add the new advanced topics and seed data with fully explicit content, then test the quiz/review flow with the new questions. Make this the deepest, most comprehensive female orgasm mastery curriculum possible.














Prompt 3


ROLE: You are a senior full-stack engineer continuing development on the HugCoach app repo (built from previous MVP and Prompt 2). The app is now a deeply explicit, NSFW, mind-expanding sexual mastery platform designed to blow Josh's mind with every new concept, technique, and philosophy from global sexology traditions — focused exclusively on heterosexual married intimacy (man pleasuring woman + mutual ecstasy). The goal is to expose Josh to the widest possible range of advanced, proven ideas from Eastern and Western sexology (Tantra, Taoism, Kama Sutra, modern sex therapists) so he gains encyclopedic knowledge of female pleasure, multiple orgasm pathways, energy-based sex, prolonged ecstasy, and creative variations — all while prioritizing enthusiastic consent, communication, and Kristy's autonomy/comfort.
STACK remains: Next.js (App Router) + TypeScript + Tailwind + shadcn/ui + Prisma + SQLite.
PREVIOUS WORK: The app already has foundational topics (communication, arousal models) + advanced female orgasm mastery (clitoral, G-spot/squirting, edging/multiples, blended/full-body, magnificent sex, accelerators/brakes). Keep everything but now EXPAND dramatically with mind-blowing new sections covering diverse sexual philosophies and advanced heterosexual techniques.
DELIVERABLE: Update the repo to make the content explosively spicy, NSFW, and comprehensive:
Update /docs/01-vision.md to reflect the new expanded scope: Emphasize mind-blowing exposure to EVERY major sexual philosophy (Tantra, Taoism, Kama Sutra, Western sexology) for straight couples. State the goal is for Josh to learn thousands of explicit techniques/ideas that will repeatedly blow his mind with new possibilities for Kristy's pleasure and mutual transcendence. Include measurable outcomes like "90% mastery on Tantric energy circulation for full-body orgasms" and "tracking 10+ different orgasm types achieved."
Add a new "Sexual Philosophies & Advanced Exploration" category in topics (unlockable or visible in Advanced Mastery Mode). Seed 8-10 new high-impact topics with 4-6 explicit lessons each:
Topic: "Tantric Sex Mastery" (Eastern Tantra – slow, energetic, transcendent sex)
Lessons: Eye gazing & breath synchronization; Yab-Yum position for energy merging; Slow penetration with PC muscle contractions; Energy orgasms without movement; Full-body energy circulation for extended ecstasy.
Topic: "Taoist Sexual Alchemy" (Mantak Chia-inspired – energy retention, multi-orgasmic man/woman)
Lessons: Testicle/ovarian breathing; Big Draw technique for whole-body orgasms; Valley orgasms (non-ejaculatory male peaks); Circulating sexual energy up the spine; Harmonizing yin/yang for marathon sessions.
Topic: "Kama Sutra Exploration"
Lessons: Embracing & kissing varieties; Nail marks, biting, scratching (consensual); Advanced positions (Mare's Position, Congress of the Cow, etc.); Oral techniques from ancient texts; Erotic scratching and hair-pulling dynamics.
Topic: "Advanced Erotic Massage"
Lessons: Full-body sensual massage sequences (lingam/yoni focus last); Feather-light touch to intense pressure; Breast/nipple massage for arousal; Perineum and sacral stimulation; Yoni massage for deep release and squirting prep.
Topic: "Exotic Orgasm Types"
Lessons: Cervical orgasms (deep penetration techniques); A-spot & U-spot stimulation; Nipple-only orgasms; Coregasms & exercise-induced; Breath/blended energy orgasms; Sleep orgasms & dream cultivation.
Topic: "Marathon Lovemaking Sessions"
Lessons: Building sessions to 1-3+ hours; Alternating high/low arousal; Edging both partners; Position marathons; Recovery strokes for endless waves.
Topic: "Fantasy & Role-Play Integration" (Perel-inspired eroticism)
Lessons: Building mystery/desire in long-term marriage; Safe fantasy sharing; Stranger role-play; Dominant/submissive dynamics (light); Erotic storytelling during sex.
Topic: "Sensual Toys & Enhancers"
Lessons: Vibrators for clitoral/G-spot blending; Dildos for dual penetration feel; Cock rings for prolonged erection; Nipple clamps & feathers; Lubricants and temperature play.
Topic: "The Joy of Sex Variations" (Alex Comfort-inspired creative play)
Lessons: Outercourse & mutual masturbation; Pompoir (vaginal gripping); Advanced oral variations; Spontaneous quickies vs. planned rituals.
Topic: "Passionate Marriage Dynamics" (David Schnarch – differentiation & intense intimacy)
Lessons: Holding onto self during deep vulnerability; Wall-socket sex (intense eye contact penetration); Using desire differences for growth.
For each new topic/lesson: Write fully explicit Markdown content — anatomical (yoni, lingam, clitoris, cervix, etc.), step-by-step techniques, rhythms, pressures, durations, body signals. Example: "In Yab-Yum, sit lotus-style with penetration; synchronize breathing while contracting PC muscles in waves — this circulates energy for full-body orgasms that feel like electric waves through the spine (Tantra)."
Generate 50-80 new explicit quiz questions across topics (MCQ, short answer, scenario):
MCQ: "In Taoist practice, the 'Big Draw' is used to: A) Ejaculate forcefully B) Circulate energy for non-ejaculatory orgasm C) Speed up thrusting" (B)
Short answer: "Describe the Mare's Position from Kama Sutra and how the woman controls rhythm for her pleasure."
Scenario: "Kristy wants longer sessions without fatigue — outline a Tantric breathing sequence to build energy."
Enhancements:
Add "Session Journal" feature: Optional logging of practice sessions (orgasm types achieved, duration, new techniques tried, Kristy's feedback, mind-blowing insights).
Spicier rituals: "Tantric date night," "Extended yoni massage," "Energy circulation practice," "Role-play evening."
UI: Add "Mind-Blowing Insights" highlights in lessons (quotes from philosophies that reframe sex entirely).
Reflection prompts: "What new idea from this lesson completely shifted your view of what's possible in bed?"
CONSTRAINTS:
Local-first, privacy absolute.
EVERY piece of content MUST hammer enthusiastic consent, communication, check-ins, and stopping immediately if uncomfortable.
Explicit, anatomical, NSFW language REQUIRED — no censorship, detailed descriptions of penetration, oral, manual, energy, positions.
Straight heterosexual focus only (man/woman married couple).
Base on real philosophies/sexologists (cite Tantra, Taoism, Kama Sutra, Schnarch, Comfort, etc.).
No coercion, pressure, or guilt — frame as joyful exploration.
OUTPUT REQUIRED:
Update vision.md with expanded mind-blowing scope.
Add all new topics/lessons/questions to seed data.
Implement journal feature (simple form + list view).
Provide run commands.
Ensure app loads new content seamlessly.
START NOW: Begin with vision update, then seed the new philosophy topics with maximally explicit, mind-expanding content that will repeatedly blow the user's mind with depth and variety. Make this the ultimate heterosexual sexology encyclopedia.

Based on the metadata and content of your uploaded file HugCoach.txt, it appears you are following a "LLM-driven development" workflow. Prompt 1 generated the specifications. Prompt 4 is designed to take the app from a basic MVP to a "mind-blowing," feature-rich, and content-heavy application, specifically focusing on the Journal feature and expanding the content depth (incorporating the explicit/philosophical aspects mentioned in the file's tail).

Here is Prompt 4, drafted to be pasted directly into Codex or your LLM editor to execute these improvements.

Prompt 4: Comprehensive Expansion & Polish
Context: We have established the MVP specifications and the basic application structure for HugCoach. Now, we need to significantly upgrade the application's scope, content depth, and feature set to move beyond a "basic" app into a "mind-blowing" expert tool.

Goal: Improve the app in every possible way by:

Expanding the Vision & Content: Shift from basic instruction to a deep, explicit, and philosophical "encyclopedia" of heterosexual intimacy.

Implementing the Journal Feature: Allow users to track their journey and insights.

Polishing the UI/UX: Ensure the new content loads seamlessly and the experience is engaging.

Constraints & Guidelines:

Privacy First: Maintain strict local-only data storage (SQLite).

Consent & Safety: EVERY piece of content MUST emphasize enthusiastic consent, communication, and the ability to stop immediately.

Explicit & Anatomical: Use NSFW, clinical, and descriptive language (no censorship). Cover detailed descriptions of penetration, oral, manual, energy, and positions.

Philosophical Basis: Integrate concepts from Tantra, Taoism, Kama Sutra, Schnarch, Comfort, etc.

Target Audience: Straight heterosexual married couples (man/woman).

Tone: Joyful exploration, no pressure, no coercion, no guilt.

Execution Tasks:

1. Update Product Documents
Update 01-vision.md and 02-mvp.md to reflect the expanded scope:

New Feature: "Mind-Blowing Insights" – highlights in lessons that reframe sex entirely.

New Feature: "Spicier Rituals" – e.g., "Tantric date night," "Extended yoni massage," "Energy circulation practice," "Role-play evening."

Journaling: Define the requirements for the Journal feature (tracking practice sessions, orgasm types, duration, techniques tried, feedback).

2. Implement the Journal Feature
Create the full vertical slice for the Journal:

Database: Update schema.prisma to include a JournalEntry model (date, activity types, duration, rating, notes, private boolean).

UI: Create /journal page with:

A "Log Session" form (simple, friction-less).

A list view of past entries.

Reflection prompts: "What new idea shifted your view?", "What was the highlight?".

3. Expand Seed Content (The "Encyclopedia")
Update the seed script (prisma/seed.ts or equivalent) to include 3-5 new, highly detailed topics that push the boundaries:

Topic Ideas: "The Art of Tantric Touch," "Advanced Oral Mastery," "Energy & Breathwork."

Content: Write explicit, step-by-step lessons for these topics using the "Expert Integration" sources (Perel, Nagoski, etc.).

Reframing: Include "Mind-Blowing Insight" callouts in these lessons.

4. Technical Refinement
Ensure the "Run Commands" (dev server, db push) work with the new schema.

Verify that the app loads the new heavy content steps seamlessly.

START NOW: Begin by updating 01-vision.md with the new "mind-blowing" scope, then proceed to modify the schema and implement the Journal feature. Finally, generate the new explicit seed data. Output the code for all changed files.







# Prompt 5: Technical Excellence & Feature Enhancement

```
ROLE: You are a distinguished principal engineer and UX architect tasked with transforming the HugCoach app from a functional MVP into a world-class, production-grade learning platform. Your mandate is to implement cutting-edge technical improvements, sophisticated UX patterns, advanced analytics, and robust engineering practices while maintaining the app's explicit educational mission and local-first architecture.

STACK: Next.js 15 (App Router) + TypeScript 5 (strict) + Tailwind CSS 3 + shadcn/ui + Prisma 5 + SQLite (better-sqlite3) + Vitest + Playwright

CURRENT STATE: The app has comprehensive content (foundational → advanced → philosophical sexual mastery), basic SM-2 spaced repetition, quiz/review flows, ritual tracking, and weekly analytics. All core features work but lack polish, performance optimization, advanced UX patterns, and production-grade error handling.

OBJECTIVE: Elevate EVERY aspect of the application to professional standards while adding powerful new features that dramatically improve learning efficacy, user engagement, and technical robustness.

---

## PART 1: CORE TECHNICAL IMPROVEMENTS

### 1.1 Advanced Spaced Repetition & Learning Science

**Upgrade SM-2 to FSRS (Free Spaced Repetition Scheduler)**:
- Implement FSRS algorithm (more accurate than SM-2, uses ML-derived parameters)
- Add difficulty/stability tracking per question
- Implement retrievability calculation for optimal scheduling
- Add load balancing (distribute reviews evenly across days)
- Support custom scheduling presets (aggressive/balanced/relaxed)

**Learning Analytics Engine**:
```typescript
// lib/analytics/learning-engine.ts
interface LearningMetrics {
  retentionRate: number;           // % correct on first review attempt
  masteryVelocity: number;          // Days to reach 90% mastery
  forgettingCurve: DataPoint[];     // Plot retention over time
  optimalStudyTime: number;         // Personalized best time of day
  weeklyLoadRecommendation: number; // Adaptive new lesson suggestions
  strugglingConcepts: string[];     // Auto-identified weak areas
  learningMomentum: number;         // Engagement trajectory score
}
```

**Adaptive Difficulty**:
- Analyze performance patterns to surface easier questions first in reviews
- Auto-flag questions with >40% lapse rate for content review
- Suggest prerequisite lessons if struggling with advanced topics
- Implement "graduated interval" unlocking (master basics before philosophy topics)

**Interleaving Scheduler**:
- Never show 2 questions from same lesson consecutively in reviews
- Mix topics in daily queue for better discrimination learning
- Smart shuffling based on similarity scores

### 1.2 Performance Optimization

**Database Query Optimization**:
```typescript
// Implement query result caching
import { LRUCache } from 'lru-cache';

const queryCache = new LRUCache<string, any>({
  max: 500,
  ttl: 1000 * 60 * 5, // 5 min cache
});

// Add database indexes for all hot paths
@@index([dueAt, userId])
@@index([lessonId, order])
@@index([topicId, completedAt])

// Implement prepared statements for frequent queries
const getReviewQueueStmt = db.prepare(`
  SELECT * FROM ReviewItem 
  WHERE dueAt <= ? AND userId = ? 
  ORDER BY dueAt ASC, priority DESC 
  LIMIT 50
`);
```

**Bundle Optimization**:
- Implement route-based code splitting for all lesson content
- Lazy load quiz components until needed
- Use Next.js Image component with proper sizing
- Tree-shake unused shadcn/ui components
- Target: <100KB First Load JS, <30KB per route

**Virtual Scrolling**:
- Implement react-virtual for long lesson lists (1000+ items)
- Infinite scroll for review history
- Windowed rendering for question banks

**Progressive Web App (PWA)**:
```json
// next.config.js + workbox
{
  "pwa": {
    "dest": "public",
    "register": true,
    "skipWaiting": true,
    "runtimeCaching": [
      {
        "urlPattern": "/api/.*",
        "handler": "NetworkFirst",
        "options": { "cacheName": "api-cache" }
      }
    ]
  }
}
```
- Offline support for reading lessons
- Background sync for quiz submissions
- Add to home screen prompt
- Service worker for asset caching

### 1.3 Advanced State Management

**Implement Zustand for Global State**:
```typescript
// stores/app-store.ts
interface AppState {
  // User preferences
  theme: 'light' | 'dark' | 'auto';
  studyReminders: boolean;
  reviewsPerSession: number;
  
  // Learning state
  currentStreak: number;
  reviewQueue: ReviewItem[];
  todayProgress: DailyProgress;
  
  // UI state
  sidebarOpen: boolean;
  activeFilters: TopicFilter[];
  
  // Actions
  updatePreferences: (prefs: Partial<Preferences>) => void;
  incrementStreak: () => void;
  markReviewComplete: (id: string) => void;
}
```

**Optimistic Updates**:
- Instant UI feedback on quiz submissions (update before API response)
- Rollback mechanism for failed mutations
- Toast notifications for sync status

**React Query Integration**:
```typescript
// For server state management
const { data: reviewQueue, isLoading } = useQuery({
  queryKey: ['reviews', userId],
  queryFn: fetchReviews,
  staleTime: 1000 * 60, // 1 min
  refetchOnWindowFocus: true,
});

const submitQuiz = useMutation({
  mutationFn: submitQuizAttempt,
  onMutate: async (newAttempt) => {
    // Optimistic update
    await queryClient.cancelQueries(['reviews']);
    const prev = queryClient.getQueryData(['reviews']);
    queryClient.setQueryData(['reviews'], optimisticUpdate);
    return { prev };
  },
  onError: (err, vars, context) => {
    queryClient.setQueryData(['reviews'], context.prev);
  },
});
```

---

## PART 2: ADVANCED UX/UI ENHANCEMENTS

### 2.1 Sophisticated Quiz Interface

**Multi-Modal Question Types**:
```typescript
// Add new question types
type QuestionType = 
  | 'mcq' 
  | 'short_answer'
  | 'multi_select'          // Multiple correct answers
  | 'ordering'              // Sequence steps correctly
  | 'matching'              // Match terms to definitions
  | 'fill_blank'            // Cloze deletion
  | 'image_hotspot'         // Click anatomical diagrams
  | 'slider_rating';        // Rate 1-10 with justification
```

**Progressive Disclosure Quiz UI**:
- Show one question at a time with smooth transitions
- Progress bar with question numbers
- "Mark for review" flag system
- Skip button with later prompt
- Timer (optional, for self-pacing awareness)

**Rich Feedback System**:
```typescript
interface Feedback {
  correct: boolean;
  explanation: string;
  expertInsight: string;        // Sexologist quote
  relatedLesson: string;         // Link to review
  commonMistake: string;         // If wrong, why people miss this
  practicalTip: string;          // Immediate application
  visualAid?: string;            // Optional diagram/animation
}
```

**Answer Confidence Rating**:
- Before seeing result, rate confidence (1-5)
- Track metacognition accuracy over time
- Adjust scheduling based on confidence-correctness mismatch

### 2.2 Immersive Lesson Reader

**Enhanced Markdown Rendering**:
```typescript
// Custom MDX components
const components = {
  h2: ({ children }) => (
    <h2 className="scroll-mt-16 text-2xl font-bold tracking-tight">
      {children}
      <button className="ml-2 text-xs">🔗 Copy Link</button>
    </h2>
  ),
  
  Callout: ({ type, children }) => (
    <div className={`p-4 rounded-lg ${typeStyles[type]}`}>
      {children}
    </div>
  ),
  
  Technique: ({ name, steps }) => (
    <div className="technique-card">
      <h3>{name}</h3>
      <ol>{steps.map(s => <li key={s}>{s}</li>)}</ol>
    </div>
  ),
  
  ConsentReminder: () => (
    <aside className="consent-banner">
      ⚠️ Always ensure enthusiastic consent and open communication
    </aside>
  ),
};
```

**Interactive Elements**:
- Expandable technique demonstrations
- Inline glossary (hover anatomical terms for definitions)
- Progress checkpoints ("Mark as understood" per section)
- Audio narration (optional TTS for lessons)
- Highlight & note-taking (local storage)

**Table of Contents**:
- Auto-generated from headings
- Sticky sidebar with scroll spy
- Estimated reading time per section
- Jump to specific techniques

### 2.3 Advanced Dashboard

**Personalized Learning Dashboard**:
```typescript
interface DashboardData {
  hero: {
    streak: number;
    nextMilestone: string;
    motivationalQuote: string;
  };
  
  todayPlan: {
    reviewsDue: number;
    reviewsOverdue: number;
    suggestedNewLesson: Lesson;
    ritualReminder: Ritual;
    estimatedTime: number; // minutes
  };
  
  insights: {
    weeklyProgress: ProgressChart;
    topicMasteryRadar: RadarChart;
    learningVelocity: number;
    consistencyScore: number;
    weakestAreas: ConceptGap[];
  };
  
  achievements: Badge[];
  recentActivity: Activity[];
}
```

**Gamification Elements**:
- Achievement badges (first orgasm mastery, 30-day streak, philosophy explorer)
- Level system (Novice → Intermediate → Expert → Master → Guru)
- Daily challenges ("Review 10 questions today")
- Leaderboard (compete with past self, not others)
- Unlock rewards (new ritual ideas, bonus content)

**Smart Suggestions**:
- ML-based next lesson recommendations
- "Similar learners also studied..."
- Adaptive difficulty progression
- Time-of-day optimization ("You learn best at 7pm")

### 2.4 Enhanced Ritual Tracking

**Ritual Logging 2.0**:
```typescript
interface RitualLog {
  id: string;
  ritualId: string;
  date: string;
  completed: boolean;
  
  // New fields
  durationMinutes: number;
  qualityRating: number;          // 1-10
  emotionalConnectionScore: number; // 1-10
  notes: string;
  techniques: string[];           // Tags for what was practiced
  partnerFeedback?: string;       // Optional Kristy input
  nextTimeGoals: string;
  
  // Metrics
  orgasmsCount?: number;
  newDiscoveries: string[];
}
```

**Ritual Analytics**:
- Correlation analysis (ritual frequency → mastery improvement)
- Best time/day for rituals (pattern detection)
- Technique effectiveness tracking
- Emotional connection trends

**Ritual Library**:
- Searchable/filterable ritual database
- Custom ritual creation
- Community-inspired rituals (future)
- Difficulty ratings (beginner → advanced)

---

## PART 3: ADVANCED FEATURES

### 3.1 Intelligent Content System

**Dynamic Content Generation**:
```typescript
// AI-powered quiz generation from lessons
async function generateQuizFromLesson(lessonId: string) {
  const lesson = await getLesson(lessonId);
  
  // Extract key concepts via NLP
  const concepts = extractConcepts(lesson.content);
  
  // Generate questions at varying difficulty
  const questions = concepts.map(concept => ({
    type: 'mcq',
    question: `According to ${lesson.source}, ${concept.question}?`,
    options: generateDistractors(concept),
    correctAnswer: concept.answer,
    explanation: concept.context,
  }));
  
  return questions;
}
```

**Content Versioning**:
```typescript
// Track lesson updates
interface LessonVersion {
  id: string;
  lessonId: string;
  version: number;
  content: string;
  changelog: string;
  publishedAt: Date;
  
  // Migration path for user progress
  questionMappings: { oldId: string; newId: string }[];
}

// Notify users of updates
function checkForUpdates() {
  const outdatedLessons = getCompletedLessons()
    .filter(l => l.version < latestVersion);
    
  if (outdatedLessons.length > 0) {
    showNotification('New insights available in 3 lessons!');
  }
}
```

**Prerequisite System**:
```prisma
model Lesson {
  // ... existing fields
  prerequisites: Lesson[] @relation("Prerequisites")
  unlocksMastery: number @default(0) // Required % to unlock
}
```

### 3.2 Advanced Analytics & Insights

**Machine Learning Predictions**:
```typescript
// Predict review success rate
function predictReviewSuccess(reviewItem: ReviewItem): number {
  const features = {
    daysSinceLastReview: reviewItem.intervalDays,
    repetitions: reviewItem.repetitions,
    easinessFactor: reviewItem.easinessFactor,
    timeOfDay: new Date().getHours(),
    dayOfWeek: new Date().getDay(),
    recentSuccessRate: getUserSuccessRate(7), // last 7 days
  };
  
  return mlModel.predict(features);
}

// Adaptive review scheduling
if (predictReviewSuccess(item) < 0.7) {
  // Show this review sooner
  adjustInterval(item, -2);
}
```

**Behavioral Analytics**:
```typescript
interface UserBehaviorMetrics {
  sessionDuration: number[];
  peakLearningHours: number[];
  dropoffPoints: string[];        // Where users quit lessons
  strugglingTopics: string[];
  engagementScore: number;
  
  // Advanced
  cognitiveLoad: number;          // Inferred from pause times
  comprehensionRate: number;      // First-attempt accuracy
  retentionCurve: DataPoint[];
}
```

**Visualization Library**:
- Victory charts for progress over time
- Recharts for topic mastery radar
- D3.js for custom knowledge graphs
- Heatmaps for study patterns

### 3.3 Session Journal Enhancement

**Rich Session Logging**:
```typescript
interface SessionJournal {
  id: string;
  date: Date;
  
  // Detailed tracking
  techniquesUsed: Technique[];
  orgasmDetails: {
    count: number;
    types: OrgasmType[];
    intensityRatings: number[];
    duration: number[];
  };
  
  // Qualitative
  newDiscoveries: string;
  challengesFaced: string;
  kristyFeedback: string;
  emotionalConnection: number;   // 1-10
  physicalSatisfaction: number;  // 1-10
  
  // Learning integration
  lessonsApplied: string[];
  improvementGoals: string;
  
  // Media (optional, encrypted)
  voiceNotes?: Blob[];
  privatePhotos?: Blob[];         // Encrypted at rest
}
```

**Pattern Recognition**:
- Auto-detect successful technique combinations
- Suggest based on past successes
- Identify plateaus and recommend new approaches

**Goal Tracking**:
```typescript
interface Goal {
  id: string;
  title: string;                  // "Master squirting technique"
  category: 'technique' | 'frequency' | 'connection';
  targetDate: Date;
  milestones: Milestone[];
  
  // Tracking
  currentProgress: number;        // %
  sessionsLogged: number;
  breakthroughs: string[];
}
```

### 3.4 Smart Reminders & Notifications

**Intelligent Notification System**:
```typescript
interface SmartReminder {
  type: 'review' | 'ritual' | 'lesson' | 'milestone';
  priority: 'low' | 'medium' | 'high';
  
  // ML-optimized timing
  optimalTime: Date;              // Predicted best engagement time
  
  // Context-aware
  message: string;
  actionButton: string;
  
  // Personalization
  tone: 'encouraging' | 'urgent' | 'playful';
}

// Examples:
"Your 7-day streak is at risk! 5 reviews waiting."
"Perfect time for a ritual - Kristy usually feels most connected at 8pm 💑"
"You're 90% through Tantric Mastery - finish tonight?"
```

**Do Not Disturb Modes**:
- Focus hours (no interruptions)
- Weekend-only reminders
- Time zone aware
- Integrates with device DND

---

## PART 4: TECHNICAL ROBUSTNESS

### 4.1 Comprehensive Error Handling

**Global Error Boundary**:
```typescript
// app/error.tsx
export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    // Log to error tracking (local file)
    logError(error);
  }, [error]);

  return (
    <div className="error-container">
      <h2>Something went wrong</h2>
      <details>
        <summary>Error Details</summary>
        <pre>{error.message}</pre>
      </details>
      <Button onClick={reset}>Try Again</Button>
      <Button onClick={() => exportLogs()}>Export Debug Info</Button>
    </div>
  );
}
```

**Graceful Degradation**:
```typescript
// Handle database errors
async function safeQuery<T>(query: () => Promise<T>): Promise<T | null> {
  try {
    return await query();
  } catch (err) {
    if (err.code === 'SQLITE_BUSY') {
      // Retry with exponential backoff
      await delay(100);
      return safeQuery(query);
    }
    
    // Log and return null
    console.error('Query failed:', err);
    return null;
  }
}
```

**Data Integrity Checks**:
```typescript
// Validate database on startup
async function validateDatabase() {
  const checks = [
    checkForeignKeyIntegrity(),
    checkOrphanedRecords(),
    checkDateConsistency(),
    verifySchedulerState(),
  ];
  
  const results = await Promise.all(checks);
  
  if (results.some(r => !r.valid)) {
    showWarning('Database issues detected. Run repair?');
  }
}
```

### 4.2 Advanced Testing

**Comprehensive Test Suite**:
```typescript
// Unit tests for scheduler
describe('FSRS Scheduler', () => {
  test('calculates stability correctly', () => {
    const item = createReviewItem();
    const newStability = calculateStability(item, 4);
    expect(newStability).toBeGreaterThan(item.stability);
  });
  
  test('handles lapses appropriately', () => {
    const item = { ...defaults, repetitions: 5 };
    const updated = processReview(item, 1); // lapse
    expect(updated.repetitions).toBe(0);
    expect(updated.intervalDays).toBe(1);
  });
});

// Integration tests for quiz flow
describe('Quiz Submission Flow', () => {
  test('creates review items for all questions', async () => {
    await submitQuiz(mockQuizData);
    const reviews = await getReviewItems(userId);
    expect(reviews.length).toBe(5);
  });
  
  test('schedules first review for tomorrow', async () => {
    await submitQuiz(mockQuizData);
    const firstReview = await getNextReview(userId);
    expect(firstReview.dueAt).toBe(tomorrow);
  });
});

// E2E tests with Playwright
test('complete quiz and review flow', async ({ page }) => {
  await page.goto('/lessons/123');
  await page.click('text=Start Quiz');
  
  // Answer questions
  await page.click('[data-testid="option-0"]');
  await page.click('text=Submit');
  
  // Rate quality
  await page.click('[data-quality="4"]');
  
  // Check review scheduled
  await page.goto('/review');
  await expect(page.locator('text=Review tomorrow')).toBeVisible();
});
```

**Performance Testing**:
```typescript
// Load testing for large datasets
describe('Performance with 10k questions', () => {
  beforeAll(async () => {
    await seedLargeDataset(10000);
  });
  
  test('review queue loads in <500ms', async () => {
    const start = performance.now();
    await getReviewQueue();
    const duration = performance.now() - start;
    expect(duration).toBeLessThan(500);
  });
});
```

### 4.3 Security & Privacy

**Data Encryption**:
```typescript
// Encrypt sensitive journal entries
import { encrypt, decrypt } from './crypto';

async function saveJournal(entry: SessionJournal) {
  const encrypted = await encrypt(
    JSON.stringify(entry),
    getUserMasterKey()
  );
  
  await db.journal.create({
    data: { userId, encryptedData: encrypted },
  });
}
```

**Secure Backup/Restore**:
```typescript
// Export encrypted backup
async function createBackup() {
  const data = await exportAllData();
  const encrypted = await encrypt(data, userPassword);
  
  downloadFile('joshcoach-backup.enc', encrypted);
}

// Restore with verification
async function restoreBackup(file: File, password: string) {
  const encrypted = await file.text();
  const decrypted = await decrypt(encrypted, password);
  
  // Validate schema before importing
  if (!validateBackupSchema(decrypted)) {
    throw new Error('Invalid backup file');
  }
  
  await importData(decrypted);
}
```

**Audit Logging**:
```prisma
model AuditLog {
  id        String   @id @default(cuid())
  action    String   // 'quiz_submit', 'lesson_complete', etc.
  details   String   // JSON metadata
  timestamp DateTime @default(now())
  
  @@index([action, timestamp])
}
```

### 4.4 Developer Experience

**Comprehensive Documentation**:
```markdown
# /docs/10-developer-guide.md

## Local Development
1. Clone repo
2. Install: `npm install`
3. Setup DB: `npx prisma generate && npx prisma db push`
4. Seed: `npx prisma db seed`
5. Run: `npm run dev`

## Architecture Decision Records (ADRs)
- ADR-001: Why FSRS over SM-2
- ADR-002: SQLite vs PostgreSQL choice
- ADR-003: Local-first vs cloud-sync

## Code Style
- Use TypeScript strict mode
- Max function length: 50 lines
- Prefer functional components
- Test coverage >80%
```

**Developer Tools**:
```typescript
// Debug panel (dev mode only)
if (process.env.NODE_ENV === 'development') {
  return (
    <DebugPanel>
      <QueryInspector />
      <StateViewer />
      <PerformanceMonitor />
      <DatabaseExplorer />
    </DebugPanel>
  );
}
```

**Hot Module Replacement**:
- Fast Refresh for instant UI updates
- Preserve state during code changes
- Error overlay with stack traces

---

## PART 5: DEPLOYMENT & MAINTENANCE

### 5.1 Production Build

**Optimized Build Configuration**:
```javascript
// next.config.js
module.exports = {
  reactStrictMode: true,
  swcMinify: true,
  
  experimental: {
    optimizeCss: true,
    optimizePackageImports: ['recharts', 'lucide-react'],
  },
  
  images: {
    formats: ['image/avif', 'image/webp'],
  },
  
  webpack: (config) => {
    config.optimization.splitChunks.cacheGroups = {
      vendor: {
        test: /[\\/]node_modules[\\/]/,
        name: 'vendor',
        chunks: 'all',
      },
    };
    return config;
  },
};
```

**Lighthouse Score Targets**:
- Performance: >90
- Accessibility: 100
- Best Practices: 100
- SEO: N/A (local app)

### 5.2 Update Mechanism

**Semantic Versioning**:
```json
{
  "version": "1.2.3",
  "changelog": {
    "1.2.3": [
      "Added FSRS scheduler",
      "Fixed quiz timer bug",
      "Improved dashboard performance"
    ]
  }
}
```

**Auto-Update Check**:
```typescript
async function checkForUpdates() {
  const currentVersion = getAppVersion();
  const latestRelease = await fetchLatestRelease();
  
  if (compareVersions(latestRelease, currentVersion) > 0) {
    showUpdateNotification({
      version: latestRelease,
      changes: getChangelog(latestRelease),
      downloadUrl: getReleaseUrl(latestRelease),
    });
  }
}
```

### 5.3 Monitoring & Telemetry

**Local Analytics (Privacy-Preserving)**:
```typescript
// Track aggregate metrics only (no PII)
interface LocalMetrics {
  appVersion: string;
  totalLessons: number;
  totalReviews: number;
  avgSessionDuration: number;
  crashCount: number;
  
  // NO user-identifying info
  // NO content details
  // NO personal data
}

// Export for manual sharing (opt-in)
function exportAnonymizedMetrics() {
  const metrics = calculateLocalMetrics();
  downloadFile('metrics.json', metrics);
}
```

---

## DELIVERABLES

1. **Update ALL Documentation** (`/docs/`):
   - 10-technical-excellence.md (this spec)
   - 11-developer-guide.md
   - 12-testing-strategy.md
   - Update 08-architecture.md with new patterns

2. **Implement Core Improvements**:
   - Migrate SM-2 → FSRS scheduler
   - Add Zustand + React Query
   - Optimize database queries (add indexes, prepared statements)
   - Implement PWA with service worker

3. **Advanced Features**:
   - Enhanced dashboard with ML insights
   - Rich session journal with analytics
   - Multi-modal question types (matching, ordering, etc.)
   - Smart notifications system

4. **UX Polish**:
   - Smooth animations (framer-motion)
   - Loading skeletons everywhere
   - Optimistic updates
   - Error states with recovery
   - Empty states with guidance

5. **Testing Infrastructure**:
   - 90%+ unit test coverage on core logic
   - E2E tests for all critical flows
   - Performance benchmarks
   - Visual regression tests (Chromatic/Percy)

6. **Developer Tools**:
   - Debug panel for dev mode
   - Comprehensive logging
   - Database migration scripts
   - Backup/restore system

7. **Production Readiness**:
   - Build optimization (<100KB FCP)
   - Lighthouse audit passing
   - Security audit (OWASP basics)
   - Accessibility audit (WCAG 2.1 AA)

## CONSTRAINTS

- MAINTAIN local-first architecture (no required cloud services)
- PRESERVE all explicit educational content (no censorship)
- ENSURE backwards compatibility with existing data
- KEEP consent/safety reminders prominent
- RESPECT privacy absolutely (no telemetry without opt-in)
- TARGET 60fps UI interactions
- SUPPORT offline usage

## SUCCESS CRITERIA

- [ ] App boots in <2s cold start
- [ ] Review queue loads in <300ms
- [ ] Quiz submission feels instant (<100ms perceived)
- [ ] Zero data loss on crashes (WAL mode, transactions)
- [ ] 90%+ test coverage on scheduler/analytics
- [ ] Lighthouse Performance >90
- [ ] Works offline (PWA)
- [ ] Smooth 60fps animations
- [ ] Zero TypeScript errors
- [ ] Comprehensive error handling

## OUTPUT REQUIRED

1. Update all affected files with improvements
2. Add new files for advanced features
3. Update tests to match new functionality
4. Provide migration guide for existing users
5. Document ALL new features in /docs/
6. Include performance benchmarks
7. Exact commands to upgrade existing installation

START NOW:
1. Begin with FSRS scheduler implementation (most critical)
2. Add Zustand store for global state
3. Implement React Query for server state
4. Optimize database with indexes
5. Build enhanced dashboard
6. Add comprehensive tests
7. Polish UX with animations/loading states
8. Document everything

GO! Make this the most technically robust, performant, and feature-rich educational platform possible while maintaining privacy and explicit content. Blow past every limitation of the current MVP.
```

---

This prompt will transform your app from functional to world-class by addressing:

1. **Learning Science**: Upgrading to FSRS (state-of-the-art spaced repetition)
2. **Performance**: Bundle optimization, query caching, PWA
3. **UX**: Sophisticated animations, loading states, error handling
4. **Features**: ML-powered insights, rich journaling, smart notifications
5. **Robustness**: Comprehensive testing, error boundaries, data integrity
6. **Developer Experience**: Better tooling, documentation, debugging

The result will be a production-grade learning platform that rivals commercial apps while maintaining your explicit educational mission and privacy-first architecture.



HugCoach

Here’s what you need to get this app off the ground (using your current PDF corpus as “v0 content”), plus Prompt 1 you can paste into Codex inside VS Code on WSL.

The documents you need (minimum set, but properly “ship-ready”)
1) Product + scope
Vision + Outcomes (1–2 pages)


What “expert” means (measurable competencies) + what “connection with Kristy + self” means (measurable habits/rituals).
Include initial content sources you’ve uploaded (Christian marriage, intimacy, porn impacts, date ideas, etc.).

MVP Definition (single page)


“Vertical slice” features only: Topic → Lesson → Quiz → Spaced Review → Weekly Summary.
# HugCoach MVP Technical Specification

I'll create a comprehensive, technically accurate specification for building this learning app with Codex on VS Code in WSL.

## Complete Documentation Package

### 1. Product & Scope Documents

#### 01-vision.md
```markdown
# Vision + Outcomes for HugCoach

## Vision
HugCoach is a privacy-first, evidence-based learning platform designed to help individuals develop expertise in intimate relationships within a Christian marriage framework. The app integrates scientifically-proven learning methodologies (retrieval practice, spaced repetition, feedback loops) with relationship psychology, attachment theory, and evidence-based intimacy education.

### Core Philosophy
- **Privacy-first**: Local-only data storage, no cloud sync required
- **Evidence-based**: Grounded in peer-reviewed research from sexology, psychology, and learning science
- **Consent-centered**: All content emphasizes mutual consent, respect, and communication
- **Christian-aligned**: Respects biblical principles while incorporating modern relationship science
- **Non-coercive**: Never pressures partners; focuses on personal growth and communication skills

### Initial Content Sources
The v0 content corpus includes:
- Christian marriage foundations and theology
- Communication and emotional connection strategies
- Date ideas and at-home connection rituals
- Understanding porn's neurological impacts (from APA/PubMed research)
- Intimacy within Christian marriage contexts
- Consent and boundary-setting frameworks

### Expert Integration
The app synthesizes insights from leading researchers:
- **Esther Perel**: Maintaining desire in long-term relationships
- **Emily Nagoski**: Dual Control Model of arousal
- **Rosemary Basson**: Circular model of responsive desire
- **Peggy Kleinplatz**: Optimal sexuality components
- **Lori Brotto**: Mindfulness for sexual wellbeing
- **Ian Kerner**: Communication-first intimacy
- **John Gottman**: Relationship fundamentals (Sound Relationship House)
- **Sue Johnson**: Attachment and emotional bonds (EFT)
- **Masters & Johnson**: Sensate focus and anxiety reduction

## Outcomes

### Measurable Competencies ("Expert" Definition)
1. **Communication Skills**
   - 90% quiz accuracy on active listening techniques
   - Demonstrated understanding of Gottman's bids for connection
   - Mastery of consent negotiation frameworks

2. **Relationship Psychology**
   - Understanding attachment styles and their impact
   - Knowledge of Dual Control Model (accelerators/brakes)
   - Application of Basson's responsive desire model

3. **Intimacy Knowledge**
   - Evidence-based understanding of arousal physiology
   - Consent-based exploration frameworks
   - Mindfulness techniques for presence

4. **Porn Impact Awareness**
   - Neurological effects understanding (from research)
   - Healthy sexuality distinctions
   - Recovery and rewiring strategies

### Measurable Habits/Rituals ("Connection" Definition)
1. **Daily Rituals** (10-15 min)
   - 20-second hug practice (oxytocin bonding)
   - 2-minute check-in conversations
   - Gratitude/appreciation sharing
   - Prayer or spiritual connection moments

2. **Weekly Rituals** (30-60 min)
   - At-home date nights (from date ideas corpus)
   - Sensate focus practice sessions
   - Relationship reflection and planning
   - Shared learning discussions

3. **Tracking Metrics**
   - Streak maintenance (daily engagement)
   - Mastery progression by topic
   - Ritual completion rates
   - Self-reported connection quality (1-10 scales)
   - Emotional closeness ratings (pre/post activities)

### Success Criteria (6-month horizon)
- 80%+ lesson completion rate
- 90%+ mastery on core topics
- 70%+ ritual adherence
- Stable spaced repetition intervals (14+ days on mastered items)
- Self-reported relationship satisfaction improvement
```

#### 02-mvp.md
```markdown
# MVP Definition: Vertical Slice Features

## Scope: Single-Page "Vertical Slice"
The MVP delivers ONE complete learning loop to prove the core value proposition:

**Topic → Lesson → Quiz → Spaced Review → Weekly Summary**

### In Scope (MVP v0.1)
1. **Browse Topics**: List 3 seed topics from PDF corpus
2. **Read Lesson**: Markdown-rendered content with clear learning objectives
3. **Take Quiz**: 5-question quiz (MCQ + short answer) with immediate feedback
4. **Schedule Reviews**: SM-2 algorithm schedules future reviews based on performance
5. **Complete Reviews**: Daily review queue of due questions
6. **Log Rituals**: Simple checklist for daily/weekly connection activities
7. **View Dashboard**: Today's plan (reviews due + next lesson + ritual reminder)
8. **Weekly Summary**: Basic analytics (streak, mastery %, weakest topics)

### Out of Scope (Future Iterations)
- Multi-user support (start single-user/local)
- Mobile apps (web-first)
- Cloud sync
- Advanced analytics/ML
- Gamification beyond streaks
- Social features
- Video/audio content
- Advanced question types (drag-drop, matching)
- Content authoring UI (start with seed scripts)

### Technical Constraints
- **Local-first**: SQLite database, no cloud required
- **Privacy**: No telemetry, no external API calls
- **Performance**: <2s page loads, <500ms interactions
- **Accessibility**: WCAG 2.1 AA compliance

### Launch Criteria
- [ ] 3 topics, 2 lessons each, 5 questions per lesson (30 questions total)
- [ ] Quiz → Review loop functional end-to-end
- [ ] Scheduler correctly implements SM-2
- [ ] Dashboard shows accurate "today's plan"
- [ ] 90%+ test coverage on scheduling logic
- [ ] Zero data loss on app restart
```

#### 03-user-stories.md
```markdown
# User Stories + Acceptance Criteria

## Epic 1: Learning Loop

### US-001: Browse Topics
**As Josh**, I want to see available learning topics so I can choose what to study.

**Acceptance Criteria:**
- [ ] `/topics` page displays 3+ topics with title, description, lesson count
- [ ] Each topic shows mastery percentage (0-100%)
- [ ] Click topic navigates to topic detail page
- [ ] Topics are ordered by: incomplete → in-progress → mastered

### US-002: Read Lesson
**As Josh**, I want to read a lesson's content so I can learn new concepts.

**Acceptance Criteria:**
- [ ] `/lessons/[id]` renders Markdown content with proper formatting
- [ ] Page shows: topic breadcrumb, lesson title, estimated time, learning objectives
- [ ] "Start Quiz" button appears at bottom
- [ ] Progress indicator shows current lesson position in topic
- [ ] Content is responsive (mobile-friendly)

### US-003: Take Quiz
**As Josh**, I want to complete a quiz after a lesson so I can test my understanding.

**Acceptance Criteria:**
- [ ] `/quiz/[lessonId]` displays 5 questions sequentially
- [ ] Supports MCQ (radio buttons) and short answer (text input)
- [ ] After answering, immediate feedback shows:
  - Correct/incorrect indicator
  - Explanation of correct answer
  - Quality rating prompt (0-5: blackout → perfect)
- [ ] Submit button is disabled until answer provided
- [ ] Quiz completion shows summary (score, time taken)
- [ ] Answers are saved to database (QuizAttempt + QuestionAttempt records)

### US-004: Schedule Reviews
**As the system**, I want to schedule spaced reviews based on quiz performance so users retain knowledge.

**Acceptance Criteria:**
- [ ] After each question attempt, ReviewItem record created with:
  - `dueAt` calculated via SM-2 algorithm
  - `easinessFactor` initialized/updated (2.5 start, adjusted by quality)
  - `intervalDays` calculated (1, 6, then EF-multiplied)
  - `repetitions` incremented
- [ ] Quality 0-2 resets interval to 1 day (lapse)
- [ ] Quality 3+ increases interval exponentially
- [ ] Database stores full review history

### US-005: Complete Reviews
**As Josh**, I want to review due questions so I don't forget what I learned.

**Acceptance Criteria:**
- [ ] `/review` page shows count of due reviews
- [ ] Questions presented one at a time (card format)
- [ ] After answering, rate quality (0-5) and see feedback
- [ ] Review updates ReviewItem (new dueAt, EF, interval)
- [ ] "No reviews due" message when queue empty
- [ ] Reviews are sorted by: overdue (oldest first) → due today

## Epic 2: Connection Rituals

### US-006: Log Rituals
**As Josh**, I want to log daily connection rituals so I build consistent habits.

**Acceptance Criteria:**
- [ ] `/rituals` page shows checklist of daily rituals:
  - 20-second hug
  - 2-minute check-in
  - Gratitude sharing
  - Prayer/spiritual moment
- [ ] Each ritual has checkbox that creates RitualLog entry with timestamp
- [ ] Cannot check future dates (only today/past)
- [ ] Weekly rituals section with longer activities
- [ ] Ritual descriptions include WHY (purpose/benefit)

### US-007: View Dashboard
**As Josh**, I want to see today's learning plan so I know what to do.

**Acceptance Criteria:**
- [ ] `/` (home) shows:
  - Review count (with urgency indicator if overdue)
  - Next recommended lesson (from incomplete topics)
  - Today's ritual checklist status
  - Current streak (days of activity)
- [ ] Quick action buttons: "Start Reviews", "Continue Learning", "Log Rituals"
- [ ] Encouraging message if no actions due
- [ ] Last activity timestamp

## Epic 3: Progress Tracking

### US-008: Weekly Summary
**As Josh**, I want to see weekly progress so I stay motivated.

**Acceptance Criteria:**
- [ ] `/summary` page shows last 7 days:
  - Total reviews completed
  - New lessons finished
  - Ritual adherence rate
  - Mastery improvements by topic
- [ ] Chart: daily activity heatmap
- [ ] "Weakest areas" section (topics with <70% mastery)
- [ ] Suggestions: "Focus on X this week"

## Epic 4: Safety & Boundaries

### US-009: Content Safety
**As Josh**, I want content that respects boundaries so the app feels safe.

**Acceptance Criteria:**
-- [ ] All intimacy content emphasizes consent/communication
- [ ] Disclaimers on lessons: "Not medical advice", "Pause if causing conflict"
- [ ] Clear escalation guidance: "Consider counseling if..."
- Explicit Content is Allowed if it helps achieve goals of becoming a master of female and male orgasm and connection between a married man and woman.

### 2. Learning Science + Quiz Design

#### 04-learning-model.md
```markdown
# Learning Model Specification

## Evidence-Based Principles

### 1. Retrieval Practice
**Research basis**: Roediger & Karpicke (2006) - Testing effect shows retrieval strengthens memory more than re-reading.

**Implementation**:
- Every lesson followed by quiz (forced retrieval)
- Reviews re-test knowledge at intervals
- No "peek at answer" option during initial attempt
- Feedback only after committing to answer

### 2. Spaced Repetition
**Research basis**: Ebbinghaus forgetting curve - retention improves with spaced reviews.

**Implementation**:
- SM-2 algorithm (Wozniak, 1990)
- Intervals: 1 day → 6 days → 14 days → 30 days → ... (exponential)
- Lapses reset to short intervals
- Optimal spacing prevents both forgetting and wasted reviews

### 3. Interleaving
**Research basis**: Mixed practice improves discrimination and transfer.

**Implementation**:
- Review queue mixes questions from different topics
- No topic-blocked study sessions
- Daily plan suggests variety (not all same topic)

### 4. Immediate Feedback
**Research basis**: Feedback timing affects learning (Kulik & Kulik meta-analysis).

**Implementation**:
- Answer → Immediate correct/incorrect + explanation
- Quality rating prompts metacognition
- No delayed feedback (common LMS mistake)

### 5. Reflection
**Research basis**: Metacognitive prompts improve transfer (Schraw, 1998).

**Implementation**:
- Post-quiz reflection: "What was hardest?"
- Weekly summary prompts: "How will you apply this?"
- Ritual logs include notes field

### 6. Overlearning
**Research basis**: Continued practice after mastery improves retention.

**Implementation**:
- "Mastered" items still appear in reviews (longer intervals)
- No "retirement" of questions
- Gradual interval increases cap at ~180 days

## Daily Loop (10-15 minutes)
**Target time**: 10-15 min/day for sustainable habit.

**Flow**:
1. **Check Dashboard** (30s): See reviews due + ritual status
2. **Complete Reviews** (5-10 min): Clear due queue (target: 10-15 reviews/day)
3. **Log Ritual** (2 min): Quick check-in activity
4. **Optional: New Lesson** (if time remains)

**Triggers**:
- Push notification (if enabled): "5 reviews due today"
- Streak indicator: "7-day streak! Keep it going"

## Weekly Loop (30-60 minutes)
**Target time**: 30-60 min once per week for deeper learning.

**Flow**:
1. **New Lessons** (20-30 min): Complete 1-2 new lessons + quizzes
2. **Weekly Ritual** (20-30 min): Longer connection activity (date night, sensate focus)
3. **Review Summary** (5-10 min): Check analytics, note weak areas

**Triggers**:
- Sunday evening prompt: "Plan your week"
- Weekly email (if enabled): "This week's focus: [topic]"

## Mastery Progression Model

### Stages
1. **Novice** (0-40%): High error rate, short intervals
2. **Intermediate** (41-70%): Improving consistency
3. **Proficient** (71-89%): Stable recall
4. **Mastery** (90-100%): Long intervals, rare errors

### Topic Mastery Calculation
```
Mastery = (Σ question_mastery) / total_questions
Question Mastery = (easinessFactor - 1.3) / (2.5 - 1.3) * 100
```
- EF 1.3 → 0% mastery
- EF 2.5 → 100% mastery

### Advancement Gates
- **Unlock next topic**: 70%+ mastery on prerequisite topics
- **Weekly summary**: Only appears after 7+ days of activity
```

#### 05-question-bank.md
```markdown
# Question Bank Specification

## Question Types Supported (MVP)

### 1. Multiple Choice (MCQ)
**Use for**: Concept identification, fact recall, scenario analysis

**Format**:
```json
{
  "type": "mcq",
  "question": "Which component of Gottman's Sound Relationship House involves knowing your partner's inner world?",
  "options": [
    "Love Maps",
    "Trust",
    "Conflict Management",
    "Shared Meaning"
  ],
  "correctIndex": 0,
  "explanation": "Love Maps refer to the cognitive room where you store all the relevant information about your partner's life."
}
```

**Rules**:
- 4 options (1 correct, 3 plausible distractors)
- Distractors must be plausible (not obviously wrong)
- Avoid "all of the above" or "none of the above"
- Single concept per question

### 2. Short Answer
**Use for**: Application, reflection, personal insight

**Format**:
```json
{
  "type": "short_answer",
  "question": "Describe one 'brake' (inhibitor of arousal) from Nagoski's Dual Control Model that might affect you personally.",
  "sampleAnswers": [
    "Stress from work deadlines",
    "Feeling tired or fatigued",
    "Worries about performance"
  ],
  "explanation": "Brakes are factors that inhibit sexual arousal. Common brakes include stress, fatigue, distractions, or performance anxiety."
}
```

**Rules**:
- No auto-grading (user self-evaluates with quality rating)
- Provide 2-3 sample answers for guidance
- Explanation shows key concepts to include

### 3. Scenario-Based (MCQ variant)
**Use for**: Applying knowledge to realistic situations

**Format**:
```json
{
  "type": "mcq",
  "question": "Your partner seems distant during intimacy. According to Sue Johnson's EFT, what's the best first response?",
  "options": [
    "Ask 'Are you okay? What's on your mind?' and listen without judgment",
    "Try a different technique to increase arousal",
    "Assume they're not interested and stop",
    "Continue and hope they'll relax"
  ],
  "correctIndex": 0,
  "explanation": "EFT emphasizes emotional attunement. Checking in verbally creates safety and addresses potential attachment concerns."
}
```

### 4. Reflection Prompts (Short Answer variant)
**Use for**: Metacognition, personal application

**Format**:
```json
{
  "type": "short_answer",
  "question": "Reflect: How might implementing a 20-second hug daily affect your emotional connection?",
  "sampleAnswers": [
    "It could increase oxytocin and create a moment of presence",
    "It might help us slow down and reconnect amid busy schedules"
  ],
  "explanation": "Reflection prompts have no single 'correct' answer. The goal is to think deeply about personal application."
}
```

## Question Quality Guidelines

### Single Concept Rule
❌ Bad: "According to Basson and Nagoski, which model describes responsive desire and what are the key accelerators?"
✅ Good: "Basson's model suggests female desire often emerges from which process?"

### Plausible Distractors
❌ Bad distractors: "Eating pizza", "Watching TV" (obviously wrong in sexual context)
✅ Good distractors: "Spontaneous desire", "Goal-oriented arousal" (plausible but incorrect)

### Clear Correct Answer
- Only ONE defensibly correct option
- No ambiguity (unless testing judgment)
- Explanation justifies why correct

### Appropriate Difficulty
- **Knowledge**: Direct recall from lesson
- **Comprehension**: Explain in own words
- **Application**: Use in new scenario
- **Analysis**: Compare/contrast concepts

### Respectful Tone
- No TMI (too much information)
- Use clinical terminology when needed
- Frame intimacy in consent-first language
- Avoid male-centric or coercive framing

## Seed Content Structure

### Topic 1: Communication Foundations
**Lessons**:
1. Active Listening & Bids for Connection (Gottman)
2. Consent Conversations & Boundaries

**Sample Questions**:
- MCQ: "What is a 'bid' in Gottman's terminology?"
- Scenario: "Your partner mentions feeling tired. How do you 'turn towards' this bid?"
- Reflection: "When was the last time you turned away from a bid? What happened?"

### Topic 2: Understanding Arousal
**Lessons**:
1. Dual Control Model (Nagoski)
2. Responsive vs. Spontaneous Desire (Basson)

**Sample Questions**:
- MCQ: "Which is an example of an 'accelerator' in the Dual Control Model?"
- Short Answer: "List two brakes you've personally experienced."
- Scenario: "Your partner rarely initiates. Given Basson's model, what might explain this?"

### Topic 3: Mindfulness & Presence
**Lessons**:
1. Sensate Focus Basics (Masters & Johnson)
2. Mindfulness for Intimacy (Brotto)

**Sample Questions**:
- MCQ: "What is the primary goal of sensate focus exercises?"
- Short Answer: "Describe one way to bring mindfulness into a touch session."
- Reflection: "What distractions pull you out of presence during intimacy?"
```

#### 06-spaced-repetition.md
```markdown
# Spaced Repetition Specification

## Algorithm: SM-2 (Simplified)

### Background
SuperMemo 2 algorithm (Wozniak, 1990) is battle-tested and simple to implement. It uses:
- **Easiness Factor (EF)**: Reflects how easy a question is for the user (1.3 to 2.5)
- **Interval**: Days until next review
- **Repetitions**: Count of successful reviews

### Core Formula

```typescript
function calculateNextReview(
  quality: number, // 0-5 rating
  currentEF: number,
  currentInterval: number,
  repetitions: number
): { newEF: number; newInterval: number; newReps: number; dueAt: Date } {
  
  // Update Easiness Factor
  let newEF = currentEF + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
  newEF = Math.max(1.3, newEF); // Floor at 1.3
  
  let newInterval: number;
  let newReps: number;
  
  if (quality < 3) {
    // Lapse: reset interval
    newInterval = 1;
    newReps = 0;
  } else {
    // Success: increase interval
    if (repetitions === 0) {
      newInterval = 1;
    } else if (repetitions === 1) {
      newInterval = 6;
    } else {
      newInterval = Math.round(currentInterval * newEF);
    }
    newReps = repetitions + 1;
  }
  
  // Cap interval at 180 days (optional)
  newInterval = Math.min(newInterval, 180);
  
  const dueAt = new Date();
  dueAt.setDate(dueAt.getDate() + newInterval);
  
  return { newEF, newInterval, newReps, dueAt };
}
```

### Quality Ratings

| Rating | Label | Meaning | Effect |
|--------|-------|---------|--------|
| 0 | Blackout | Complete memory failure | Reset to day 1 |
| 1 | Incorrect | Wrong answer after effort | Reset to day 1 |
| 2 | Incorrect (easy) | Wrong but felt easy | Reset to day 1 |
| 3 | Correct (hard) | Right answer with effort | Increase interval, lower EF |
| 4 | Correct (good) | Right answer, some hesitation | Standard interval increase |
| 5 | Perfect | Instant correct recall | Larger interval increase |

### Database Fields (ReviewItem table)

```typescript
interface ReviewItem {
  id: string;
  questionId: string;
  userId: string;
  easinessFactor: number; // Default: 2.5
  intervalDays: number; // Default: 0 (new item)
  repetitions: number; // Default: 0
  dueAt: Date; // Initially: now (immediate first review)
  lastReviewedAt: Date | null;
  createdAt: Date;
}
```

### Scheduling Rules

#### Initial Schedule (after first quiz)
- All questions from quiz → ReviewItem with `dueAt = now + 1 day`
- First review happens next day

#### Subsequent Reviews
- Quality 0-2: Reset to 1-day interval (lapse)
- Quality 3: Interval × EF, but EF decreases slightly
- Quality 4-5: Interval × EF, EF stable or increases

#### Review Queue Priority
1. **Overdue** (dueAt < today): Sorted oldest first
2. **Due today** (dueAt = today): Sorted by creation time
3. **Upcoming** (dueAt > today): Not shown (wait until due)

### Lapse Handling

**Definition**: Quality < 3 is a lapse (forgot the answer).

**Actions**:
- Reset interval to 1 day
- Reset repetitions to 0
- Keep EF (to track difficulty history)
- Mark as "needs review" in analytics

**Frequency Cap**: If a question lapses >3 times, flag for content review (might be confusing).

## Mastery Thresholds

### Question-Level Mastery
- **Criterion**: EF ≥ 2.3 AND interval ≥ 14 days
- **Interpretation**: User can recall consistently with 2+ week gaps

### Topic-Level Mastery
```typescript
function calculateTopicMastery(questions: ReviewItem[]): number {
  const masteredCount = questions.filter(q => 
    q.easinessFactor >= 2.3 && q.intervalDays >= 14
  ).length;
  return (masteredCount / questions.length) * 100;
}
```

- 0-40%: Novice
- 41-70%: Intermediate
- 71-89%: Proficient
- 90-100%: Mastery

## Edge Cases

### Never Reviewed
- **Scenario**: Question created but never reviewed
- **Handling**: Show in review queue immediately (dueAt = now)

### Skipped Reviews
- **Scenario**: User doesn't review for days, items pile up
- **Handling**: Review queue shows all overdue (cap UI at 50 to avoid overwhelm)

### Deleted Questions
- **Scenario**: Content updated, old questions removed
- **Handling**: Soft-delete ReviewItems, exclude from mastery calculations

### Timezone Changes
- **Scenario**: User travels across timezones
- **Handling**: Use UTC for all `dueAt` timestamps, display in local time
```

### 3. Relationship + Spiritual Integration

#### 09-safety-boundaries.md
```markdown
# Safety + Boundaries Policy

## Core Principles

### 1. Consent is Paramount
- All content emphasizes **mutual, enthusiastic, ongoing consent**
- No activities should ever be pressured or coerced
- Either partner can pause/stop at any time
- "No" is always respected without guilt

### 2. Privacy First
- All data stored locally (SQLite)
- No telemetry or usage tracking
- No cloud sync without explicit opt-in
- User can export/delete all data anytime

### 3. Non-Coercive Education
- App teaches skills, never dictates outcomes
- No "you must do X" language
- Frames intimacy as collaborative exploration
- Acknowledges individual differences (not one-size-fits-all)

### 4. Age-Appropriate
- Designed for married adults (18+)
- No content involving minors under any circumstance

### 5. Medical Disclaimers
- App is NOT medical advice
- Does not diagnose, treat, or cure conditions
- Recommends professional help when needed

## Content Guardrails

### Prohibited Content
❌ **Never Include**:
- Explicit sexual imagery or pornographic material
- Coercive or manipulative tactics
- Content that could be used to pressure a partner
- Medical diagnoses or treatment plans
- Advice that violates consent principles
- Content involving non-consenting individuals
- Anything promoting harm or abuse

### Permitted Content
✅ **Allowed**:
- Evidence-based relationship education
- Communication frameworks (Gottman, Johnson, etc.)
- Anatomy/physiology education (clinical terminology)
- Consent negotiation strategies
- Mindfulness and presence techniques
- Christian theology on marriage (respectful framing)
- Research summaries (porn effects, attachment theory)

### Gray Areas (Handle with Care)
⚠️ **Requires Careful Framing**:
- **Intimacy techniques**: Frame as "options to explore together," not prescriptions
- **Desire discrepancy**: Validate both partners, emphasize communication
- **Porn impact**: Present research without shame, focus on recovery
- **Religious content**: Respect diverse interpretations, avoid dogmatism

## Safety Warnings

### When to Display Warnings

#### Conflict Warning
**Trigger**: Content on desire discrepancy, conflict resolution
**Message**: 
> "If discussing this topic creates conflict in your relationship, consider pausing and seeking support from a licensed therapist or counselor. This app is for education, not crisis intervention."

#### Medical Referral
**Trigger**: Content on pain, dysfunction, persistent issues
**Message**:
> "If you experience pain, persistent difficulties, or concerning symptoms, please consult a healthcare provider. This app does not replace medical advice."

#### Mental Health Referral
**Trigger**: Content on porn addiction, shame, depression
**Message**:
> "If you're struggling with compulsive behaviors, shame, or low mood, please reach out to a mental health professional. Resources: [link to SAMHSA, BetterHelp, etc.]"

#### Consent Reminder
**Trigger**: Content on trying new activities
**Message**:
> "Remember: Both partners must enthusiastically consent to any activity. It's always okay to say 'not right now' or 'let's talk about this first.'"

## Escalation Guidance

### When User Needs Help
The app should provide links/resources for:

1. **Relationship Counseling**
   - Gottman Institute therapist directory
   - AAMFT (American Association for Marriage and Family Therapy)
   - Local faith-based counseling (if requested)

2. **Sex Therapy**
   - AASECT (American Association of Sexuality Educators, Counselors and Therapists)
   - Local certified sex therapists

3. **Mental Health**
   - SAMHSA National Helpline: 1-800-662-4357
   - Psychology Today therapist finder
   - Crisis Text Line: Text HOME to 741741

4. **Domestic Violence** (if app detects coercion concerns)
   - National Domestic Violence Hotline: 1-800-799-7233
   - Clear message: "If you feel unsafe, please reach out for help."

### Feedback Loop
- Every lesson has "Report Content" link
- User can flag content as:
  - Inaccurate
  - Inappropriate
  - Triggering
  - Coercive
- Feedback stored locally, user can export for review

## Christian Framework Respectfulness

### Inclusive Approach
- Acknowledge diverse Christian traditions (Catholic, Protestant, Orthodox)
- Avoid narrow interpretations of theology
- Present biblical principles alongside modern research
- Never use Scripture to justify coercion or control

### Key Scriptural Anchors (if applicable)
- **Genesis 2:24**: "Becoming one flesh" as unity, not obligation
- **Song of Solomon**: Celebration of mutual desire and pleasure
- **1 Corinthians 7:3-5**: Mutual sexual generosity, not demand
- **Ephesians 5:21**: Mutual submission, not hierarchy

### Tone Guidelines
- Respectful of faith, not preachy
- Integrate theology naturally (not forced)
- Allow space for users to interpret through their own faith lens

## Privacy & Data Ethics

### Data Minimization
- Only collect data essential for app function
- No behavioral tracking or analytics
- No third-party integrations (ads, trackers)

### User Control
- Export all data as JSON
- Delete all data with one button
- No "are you sure?" dark patterns

### Transparency
- Open-source code (if desired)
- Clear privacy policy in plain language
- No hidden data collection

## Testing for Safety

### Pre-Launch Checklist
- [ ] All lessons reviewed by licensed therapist or educator
- [ ] Content tested with beta users for tone/appropriateness
- [ ] Warnings trigger correctly
- [ ] Resource links verified and current
- [ ] Privacy policy legally reviewed
- [ ] No unintended pressure tactics in language

### Ongoing Monitoring
- Regular content audits (quarterly)
- User feedback review
- Research updates incorporated
- Expert consultation for new topics
```

### 4. Engineering Documents

#### 08-architecture.md
```markdown
# Technical Architecture (MVP)

## Stack

### Core Technologies
- **Framework**: Next.js 15 (App Router)
- **Language**: TypeScript 5.x (strict mode)
- **Styling**: Tailwind CSS 3.x + shadcn/ui components
- **Database**: SQLite (via better-sqlite3)
- **ORM**: Prisma 5.x
- **Testing**: Vitest + Testing Library

### Why This Stack?

**Next.js**:
- Server components for performance
- File-based routing (intuitive structure)
- Built-in API routes
- Easy deployment (Vercel, self-hosted)

**SQLite**:
- Zero-config database (perfect for local-first)
- Single file (easy backup/restore)
- Fast for <100k records (MVP scale)
- Can migrate to PostgreSQL later if needed

**Prisma**:
- Type-safe database access
- Migration management
- Excellent TypeScript integration

**Tailwind + shadcn/ui**:
- Rapid UI development
- Accessible components out-of-box
- Consistent design system

## Project Structure

```
joshcoach/
├── app/                    # Next.js App Router
│   ├── (dashboard)/       # Groupe

```
│   ├── (dashboard)/       # Grouped routes (shared layout)
│   │   ├── layout.tsx     # Dashboard layout with nav
│   │   ├── page.tsx       # Home/Dashboard
│   │   ├── topics/
│   │   │   ├── page.tsx   # Topics list
│   │   │   └── [id]/
│   │   │       └── page.tsx  # Topic detail
│   │   ├── lessons/
│   │   │   └── [id]/
│   │   │       └── page.tsx  # Lesson reader
│   │   ├── quiz/
│   │   │   └── [lessonId]/
│   │   │       └── page.tsx  # Quiz runner
│   │   ├── review/
│   │   │   └── page.tsx   # Review queue
│   │   ├── rituals/
│   │   │   └── page.tsx   # Ritual tracker
│   │   └── summary/
│   │       └── page.tsx   # Weekly analytics
│   ├── api/               # API routes
│   │   ├── quiz/
│   │   │   └── submit/route.ts
│   │   ├── review/
│   │   │   └── submit/route.ts
│   │   └── rituals/
│   │       └── log/route.ts
│   ├── globals.css        # Global styles
│   └── layout.tsx         # Root layout
├── components/
│   ├── ui/                # shadcn/ui components
│   │   ├── button.tsx
│   │   ├── card.tsx
│   │   ├── progress.tsx
│   │   └── ...
│   ├── dashboard/
│   │   ├── DashboardCard.tsx
│   │   ├── StreakIndicator.tsx
│   │   └── TodaysPlan.tsx
│   ├── quiz/
│   │   ├── QuestionCard.tsx
│   │   ├── MCQOptions.tsx
│   │   ├── ShortAnswerInput.tsx
│   │   └── QualityRating.tsx
│   ├── review/
│   │   └── ReviewCard.tsx
│   └── shared/
│       ├── Navbar.tsx
│       ├── Breadcrumb.tsx
│       └── ProgressBar.tsx
├── lib/
│   ├── db.ts              # Prisma client singleton
│   ├── scheduler.ts       # SM-2 algorithm
│   ├── analytics.ts       # Mastery calculations
│   └── utils.ts           # Shared utilities
├── prisma/
│   ├── schema.prisma      # Database schema
│   ├── seed.ts            # Seed data script
│   └── migrations/        # Migration history
├── content/               # Lesson content (Markdown)
│   ├── topics/
│   │   ├── communication-foundations/
│   │   │   ├── 01-active-listening.md
│   │   │   └── 02-consent-conversations.md
│   │   ├── understanding-arousal/
│   │   │   ├── 01-dual-control-model.md
│   │   │   └── 02-responsive-desire.md
│   │   └── mindfulness-presence/
│   │       ├── 01-sensate-focus.md
│   │       └── 02-mindfulness-intimacy.md
│   └── questions/         # Question bank (JSON)
│       ├── communication-foundations.json
│       ├── understanding-arousal.json
│       └── mindfulness-presence.json
├── tests/
│   ├── unit/
│   │   ├── scheduler.test.ts
│   │   └── analytics.test.ts
│   └── e2e/
│       ├── quiz-flow.test.ts
│       └── review-flow.test.ts
├── docs/                  # Documentation (from above)
│   ├── 01-vision.md
│   ├── 02-mvp.md
│   ├── ...
│   └── 09-safety-boundaries.md
├── public/
│   └── images/            # Static assets
├── .env.example
├── .gitignore
├── next.config.js
├── package.json
├── tsconfig.json
├── tailwind.config.ts
└── vitest.config.ts
```

## Data Flow

### Quiz Submission Flow
```
User answers question
  ↓
POST /api/quiz/submit
  ↓
Create QuizAttempt + QuestionAttempt records
  ↓
For each question:
  - Calculate next review (SM-2)
  - Create/update ReviewItem
  ↓
Return quiz results + scheduled reviews
  ↓
Redirect to quiz summary page
```

### Review Submission Flow
```
User completes review question
  ↓
Rate quality (0-5)
  ↓
POST /api/review/submit
  ↓
Update ReviewItem:
  - Calculate new EF, interval, dueAt
  - Increment repetitions (or reset if lapse)
  ↓
Return next due review (if any)
  ↓
Show next review or "All done!" message
```

### Dashboard Data Loading
```
Server Component loads:
  - Review count (WHERE dueAt <= NOW)
  - Next lesson (first incomplete)
  - Today's rituals (grouped by daily/weekly)
  - Current streak (consecutive active days)
  ↓
Render with prefetched data (no loading spinners)
```

## Database Schema

### Core Tables
See `07-data-model.md` for full Prisma schema. Key relationships:

```
Topic (1) ──→ (N) Lesson
Lesson (1) ──→ (N) Question
Question (1) ──→ (N) QuestionAttempt
Question (1) ──→ (1) ReviewItem
User (1) ──→ (N) QuizAttempt
User (1) ──→ (N) RitualLog
```

### Indexes
```prisma
@@index([dueAt])                    // ReviewItem: Fast queue queries
@@index([lessonId])                 // Question: Group by lesson
@@index([userId, createdAt])        // QuizAttempt: User history
@@index([userId, ritualId, date])   // RitualLog: Daily tracking
```

## API Routes

### POST /api/quiz/submit
**Request**:
```json
{
  "lessonId": "uuid",
  "answers": [
    {
      "questionId": "uuid",
      "answer": "string | number",
      "quality": 0-5
    }
  ]
}
```

**Response**:
```json
{
  "quizAttemptId": "uuid",
  "score": 80,
  "totalQuestions": 5,
  "scheduledReviews": 5,
  "results": [
    {
      "questionId": "uuid",
      "correct": true,
      "explanation": "...",
      "nextReviewAt": "2025-12-18T10:00:00Z"
    }
  ]
}
```

### POST /api/review/submit
**Request**:
```json
{
  "reviewItemId": "uuid",
  "answer": "string | number",
  "quality": 0-5
}
```

**Response**:
```json
{
  "correct": true,
  "explanation": "...",
  "nextReviewAt": "2025-12-24T10:00:00Z",
  "newInterval": 7,
  "remainingReviews": 3
}
```

### POST /api/rituals/log
**Request**:
```json
{
  "ritualId": "uuid",
  "date": "2025-12-17",
  "notes": "Felt really connected during our hug"
}
```

**Response**:
```json
{
  "ritualLogId": "uuid",
  "streakUpdated": true,
  "newStreak": 8
}
```

## Performance Targets

### Page Load
- **Dashboard**: <1s (server-rendered)
- **Lesson**: <1.5s (Markdown parse + render)
- **Quiz**: <800ms
- **Review**: <500ms (single question)

### Database Queries
- **Dashboard data**: <50ms (4-5 queries, indexed)
- **Quiz submission**: <100ms (transaction with 5-10 inserts)
- **Review queue**: <30ms (indexed dueAt query)

### Bundle Size
- **First Load JS**: <150KB (Next.js + React)
- **Page JS**: <50KB per route
- **Total**: <500KB (including Tailwind)

## Security Considerations

### Local-First Security
- No authentication needed (single-user, local device)
- File permissions: Database file readable only by user
- No network requests (except optional future sync)

### Input Validation
- **API routes**: Validate all inputs with Zod schemas
- **Quality ratings**: Constrain to 0-5
- **Dates**: Validate ISO 8601 format
- **SQL injection**: Prevented by Prisma (parameterized queries)

### Data Integrity
- **Transactions**: Use Prisma transactions for multi-step operations
- **Constraints**: Foreign keys, unique constraints in schema
- **Soft deletes**: Flag records as deleted, don't remove

## Deployment Options

### Development (WSL)
```bash
npm run dev        # Next.js dev server on localhost:3000
npm run db:push    # Sync Prisma schema to SQLite
npm run db:seed    # Populate with seed data
```

### Production (Self-Hosted)
```bash
npm run build      # Create optimized production build
npm run start      # Run production server
```

**Database location**: `prisma/dev.db` (can configure path)

### Alternative: Electron Desktop App
For true "offline-first" experience, wrap Next.js in Electron:
- Package as `.exe` (Windows), `.app` (Mac), `.deb` (Linux)
- Bundle SQLite database
- No browser required

## Testing Strategy

### Unit Tests (Vitest)
- **lib/scheduler.ts**: Test SM-2 algorithm with edge cases
- **lib/analytics.ts**: Test mastery calculations
- **lib/utils.ts**: Test helper functions

### Integration Tests
- **API routes**: Test request/response with mock database
- **Database operations**: Test Prisma queries

### E2E Tests (Playwright)
- **Quiz flow**: Complete quiz → verify reviews scheduled
- **Review flow**: Complete review → verify interval updated
- **Dashboard**: Verify correct counts and next lesson

### Test Coverage Target
- **Scheduler logic**: 100% (critical for learning loop)
- **API routes**: 90%
- **Overall**: 80%

## Migration Path (Future)

### v0.1 → v0.2 (Multi-User)
- Add `User` table with authentication
- Add `userId` foreign keys to all tables
- Implement login/signup

### v0.2 → v0.3 (Cloud Sync)
- Add sync API (Supabase, PocketBase, or custom)
- Implement conflict resolution (last-write-wins or CRDT)
- Encrypted backups to cloud

### v0.3 → v1.0 (Mobile Apps)
- Expo/React Native for iOS/Android
- Shared TypeScript logic
- Native SQLite integration
```

#### 07-data-model.md
```markdown
# Data Model Specification

## Prisma Schema

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ============================================================================
// CONTENT STRUCTURE
// ============================================================================

model Topic {
  id          String   @id @default(cuid())
  title       String
  description String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  lessons     Lesson[]
  
  @@index([order])
}

model Lesson {
  id             String   @id @default(cuid())
  topicId        String
  title          String
  slug           String   @unique
  content        String   // Markdown content
  estimatedMinutes Int    @default(10)
  order          Int      @default(0)
  learningObjectives String // JSON array of objectives
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  topic          Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  questions      Question[]
  quizAttempts   QuizAttempt[]
  
  @@index([topicId])
  @@index([order])
}

model Question {
  id          String   @id @default(cuid())
  lessonId    String
  type        String   // 'mcq' | 'short_answer'
  question    String
  options     String?  // JSON array (for MCQ)
  correctAnswer String // Index (for MCQ) or sample answers (for short_answer)
  explanation String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  attempts    QuestionAttempt[]
  reviewItems ReviewItem[]
  
  @@index([lessonId])
  @@index([order])
}

// ============================================================================
// LEARNING ATTEMPTS & REVIEWS
// ============================================================================

model QuizAttempt {
  id          String   @id @default(cuid())
  lessonId    String
  score       Int      // Correct answers count
  total       Int      // Total questions
  timeSpent   Int?     // Seconds
  createdAt   DateTime @default(now())
  
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questionAttempts QuestionAttempt[]
  
  @@index([lessonId])
  @@index([createdAt])
}

model QuestionAttempt {
  id            String   @id @default(cuid())
  quizAttemptId String
  questionId    String
  answer        String   // User's answer
  correct       Boolean
  quality       Int      // 0-5 rating
  createdAt     DateTime @default(now())
  
  quizAttempt   QuizAttempt @relation(fields: [quizAttemptId], references: [id], onDelete: Cascade)
  question      Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  @@index([quizAttemptId])
  @@index([questionId])
}

model ReviewItem {
  id              String    @id @default(cuid())
  questionId      String    @unique
  easinessFactor  Float     @default(2.5)
  intervalDays    Int       @default(0)
  repetitions     Int       @default(0)
  dueAt           DateTime  @default(now())
  lastReviewedAt  DateTime?
  lapseCount      Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  question        Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  @@index([dueAt])
  @@index([questionId])
}

// ============================================================================
// RITUALS & REFLECTIONS
// ============================================================================

model Ritual {
  id          String   @id @default(cuid())
  title       String
  description String
  type        String   // 'daily' | 'weekly'
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  
  logs        RitualLog[]
  
  @@index([type])
  @@index([order])
}

model RitualLog {
  id        String   @id @default(cuid())
  ritualId  String
  date      String   // YYYY-MM-DD format
  notes     String?
  createdAt DateTime @default(now())
  
  ritual    Ritual   @relation(fields: [ritualId], references: [id], onDelete: Cascade)
  
  @@unique([ritualId, date])
  @@index([date])
}

model Reflection {
  id        String   @id @default(cuid())
  type      String   // 'quiz' | 'weekly' | 'ritual'
  content   String
  metadata  String?  // JSON (e.g., { quizAttemptId, weekStart })
  createdAt DateTime @default(now())
  
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// USER PROGRESS & ANALYTICS
// ============================================================================

model Session {
  id        String   @id @default(cuid())
  date      String   @unique // YYYY-MM-DD format
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  
  @@index([date])
}
```

## Table Descriptions

### Topic
**Purpose**: Top-level content organization (e.g., "Communication Foundations")

**Fields**:
- `id`: Unique identifier
- `title`: Display name
- `description`: Brief overview (2-3 sentences)
- `order`: Sort order for display
- `lessons`: One-to-many relationship with Lesson

**Example**:
```json
{
  "id": "topic_1",
  "title": "Communication Foundations",
  "description": "Master the basics of emotional connection through Gottman's research and consent-first communication.",
  "order": 1
}
```

### Lesson
**Purpose**: Individual learning modules with content + quiz

**Fields**:
- `slug`: URL-friendly identifier (e.g., "active-listening")
- `content`: Full Markdown text (rendered on lesson page)
- `estimatedMinutes`: Reading + quiz time estimate
- `learningObjectives`: JSON array of goals (e.g., `["Identify Gottman's 'bids'", "Practice turning towards"]`)

**Example**:
```json
{
  "id": "lesson_1",
  "topicId": "topic_1",
  "title": "Active Listening & Bids for Connection",
  "slug": "active-listening",
  "content": "# Active Listening...",
  "estimatedMinutes": 12,
  "learningObjectives": "[\"Identify bids\", \"Practice responses\"]",
  "order": 1
}
```

### Question
**Purpose**: Quiz/review questions linked to lessons

**Fields**:
- `type`: "mcq" or "short_answer"
- `options`: JSON array for MCQ (e.g., `["Option A", "Option B"]`)
- `correctAnswer`: For MCQ, index (e.g., `"0"`); for short_answer, sample answers JSON
- `explanation`: Feedback shown after answering

**MCQ Example**:
```json
{
  "id": "q_1",
  "lessonId": "lesson_1",
  "type": "mcq",
  "question": "What is a 'bid' in Gottman's terminology?",
  "options": "[\"Request for connection\", \"Argument tactic\", \"Compliment\", \"Apology\"]",
  "correctAnswer": "0",
  "explanation": "A bid is any attempt to connect..."
}
```

**Short Answer Example**:
```json
{
  "id": "q_2",
  "type": "short_answer",
  "question": "Describe one brake from Nagoski's model you experience.",
  "correctAnswer": "[\"Stress\", \"Fatigue\", \"Distractions\"]",
  "explanation": "Common brakes include..."
}
```

### QuizAttempt
**Purpose**: Track each quiz completion

**Fields**:
- `score`: Number of correct answers
- `total`: Total questions in quiz
- `timeSpent`: Optional (seconds to complete)
- `questionAttempts`: One-to-many with QuestionAttempt

### QuestionAttempt
**Purpose**: Individual question responses within a quiz

**Fields**:
- `answer`: User's raw answer (text or option index)
- `correct`: Boolean (calculated server-side)
- `quality`: User's self-rating (0-5)

### ReviewItem
**Purpose**: Spaced repetition state for each question

**Fields**:
- `easinessFactor`: SM-2 difficulty metric (1.3-2.5)
- `intervalDays`: Days until next review
- `repetitions`: Successful review count
- `dueAt`: DateTime when review is due
- `lapseCount`: Times user forgot (for analytics)

**State Progression**:
```
New Question → First Review (1 day) → Second Review (6 days) 
  → Third Review (14 days) → Fourth Review (~35 days) → ...
```

### Ritual
**Purpose**: Seed data for daily/weekly connection activities

**Fields**:
- `type`: "daily" or "weekly"
- `title`: "20-second hug", "2-minute check-in", etc.
- `description`: Instructions and purpose

**Example**:
```json
{
  "id": "ritual_1",
  "title": "20-Second Hug",
  "description": "A sustained hug lasting at least 20 seconds releases oxytocin...",
  "type": "daily",
  "order": 1
}
```

### RitualLog
**Purpose**: Track ritual completion

**Fields**:
- `date`: YYYY-MM-DD string (unique per ritual per day)
- `notes`: Optional reflection

**Constraint**: `@@unique([ritualId, date])` prevents duplicate logs

### Reflection
**Purpose**: Store user's metacognitive reflections

**Fields**:
- `type`: Context (quiz, weekly, ritual)
- `content`: User's text
- `metadata`: JSON with related IDs

### Session
**Purpose**: Track daily activity for streak calculation

**Fields**:
- `date`: YYYY-MM-DD (unique)
- `active`: Boolean (did user do anything today?)

**Streak Logic**:
```typescript
function calculateStreak(): number {
  const sessions = await db.session.findMany({
    where: { active: true },
    orderBy: { date: 'desc' }
  });
  
  let streak = 0;
  let currentDate = new Date();
  
  for (const session of sessions) {
    if (isSameOrPreviousDay(session.date, currentDate)) {
      streak++;
      currentDate = new Date(session.date);
      currentDate.setDate(currentDate.getDate() - 1);
    } else {
      break;
    }
  }
  
  return streak;
}
```

## Relationships Diagram

```
Topic
  └─→ Lesson (many)
        ├─→ Question (many)
        │     ├─→ QuestionAttempt (many)
        │     └─→ ReviewItem (one)
        └─→ QuizAttempt (many)
              └─→ QuestionAttempt (many)

Ritual
  └─→ RitualLog (many)

(Reflection and Session are standalone)
```

## Seed Data Structure

### Seed Script Overview
**File**: `prisma/seed.ts`

**What it populates**:
1. **3 Topics** (Communication, Arousal, Mindfulness)
2. **2 Lessons per topic** (6 total)
3. **5 Questions per lesson** (30 total)
4. **4 Daily rituals** (hug, check-in, gratitude, prayer)
5. **3 Weekly rituals** (date night, sensate focus, reflection)

### Sample Topic Seed
```typescript
const topics = [
  {
    title: "Communication Foundations",
    description: "Master emotional connection through research-backed communication strategies and consent frameworks.",
    order: 1,
    lessons: [
      {
        title: "Active Listening & Bids for Connection",
        slug: "active-listening",
        content: readFileSync('./content/topics/communication-foundations/01-active-listening.md', 'utf-8'),
        estimatedMinutes: 12,
        learningObjectives: JSON.stringify([
          "Identify Gottman's 'bids' for connection",
          "Practice turning towards responses",
          "Recognize turning away and turning against patterns"
        ]),
        order: 1,
        questions: [
          {
            type: "mcq",
            question: "What is a 'bid' in Gottman's terminology?",
            options: JSON.stringify([
              "An attempt to connect emotionally",
              "A way to win an argument",
              "A form of manipulation",
              "A romantic gesture"
            ]),
            correctAnswer: "0",
            explanation: "A bid is any attempt—verbal or nonverbal—to connect with your partner...",
            order: 1
          },
          // ... 4 more questions
        ]
      },
      // ... 1 more lesson
    ]
  },
  // ... 2 more topics
];
```

### Content File Structure
**Location**: `content/topics/[topic-slug]/[lesson-number]-[lesson-slug].md`

**Example**: `content/topics/communication-foundations/01-active-listening.md`

```markdown
# Active Listening & Bids for Connection

## Learning Objectives
By the end of this lesson, you will be able to:
- Identify emotional bids in everyday interactions
- Practice "turning towards" responses
- Recognize patterns of turning away or against

## What Are Bids?

Dr. John Gottman's research on couples revealed a simple but profound insight: **the small moments matter most**. A "bid" is any attempt to connect—verbal or nonverbal...

## The Three Responses

When your partner makes a bid, you have three options...

[Full lesson content continues...]
```

## Migration Strategy

### Initial Setup
```bash
npx prisma migrate dev --name init
npx prisma db seed
```

### Adding Fields (Example: Add `difficulty` to Question)
```bash
# 1. Update schema.prisma
model Question {
  // ... existing fields
  difficulty String @default("medium") // 'easy' | 'medium' | 'hard'
}

# 2. Create migration
npx prisma migrate dev --name add_question_difficulty

# 3. Backfill existing data
npx prisma db execute --stdin < backfill-difficulty.sql
```

### Data Export/Import
```typescript
// Export all data
async function exportData() {
  const data = {
    topics: await db.topic.findMany({ include: { lessons: { include: { questions: true } } } }),
    rituals: await db.ritual.findMany(),
    quizAttempts: await db.quizAttempt.findMany({ include: { questionAttempts: true } }),
    reviewItems: await db.reviewItem.findMany(),
    // ...
  };
  
  writeFileSync('./backup.json', JSON.stringify(data, null, 2));
}

// Import from backup
async function importData(backup: any) {
  await db.$transaction(async (tx) => {
    // Delete existing data
    await tx.questionAttempt.deleteMany();
    await tx.quizAttempt.deleteMany();
    // ... (in reverse FK order)
    
    // Re-create from backup
    for (const topic of backup.topics) {
      await tx.topic.create({ data: topic });
    }
    // ...
  });
}
```
```

#### Content Authoring + Import Spec
```markdown
# Content Authoring + Import Specification

## Content Format Standards

### Lesson Content (Markdown)

**File Naming**: `[order]-[slug].md` (e.g., `01-active-listening.md`)

**Required Frontmatter**:
```yaml
---
title: Active Listening & Bids for Connection
slug: active-listening
topic: communication-foundations
estimatedMinutes: 12
learningObjectives:
  - Identify Gottman's 'bids' for connection
  - Practice turning towards responses
  - Recognize turning away/against patterns
---
```

**Content Structure**:
```markdown
# [Lesson Title]

## Learning Objectives
[Bulleted list matching frontmatter]

## Introduction
[Hook + relevance]

## Main Content
[Sections with ## headers]

### Subsection Example
[Explanations, examples, research citations]

## Key Takeaways
[3-5 bullet summary]

## Reflection Prompt
[Optional: Question for user to ponder]

## Resources
[Optional: Links to research papers, videos]
```

**Markdown Guidelines**:
- Use `##` for sections, `###` for subsections
- Bold key terms on first use: `**bid**`
- Use block quotes for important warnings:
  ```markdown
  > **Important**: Always prioritize consent and communication.
  ```
- Code blocks for examples (if applicable)
- No raw HTML (keep it portable)

### Question Bank (JSON)

**File Naming**: `[topic-slug].json`

**Structure**:
```json
{
  "topic": "communication-foundations",
  "lessons": [
    {
      "lessonSlug": "active-listening",
      "questions": [
        {
          "type": "mcq",
          "question": "What is a 'bid' in Gottman's terminology?",
          "options": [
            "An attempt to connect emotionally",
            "A way to win an argument",
            "A form of manipulation",
            "A romantic gesture"
          ],
          "correctAnswer": 0,
          "explanation": "A bid is any attempt—verbal or nonverbal—to connect with your partner. Examples include sharing a thought, asking a question, or physical touch.",
          "order": 1
        },
        {
          "type": "short_answer",
          "question": "Describe a recent 'bid' your partner made toward you. How did you respond?",
          "sampleAnswers": [
            "They asked about my day, and I put down my phone to listen",
            "They touched my shoulder, and I leaned into the touch",
            "They shared a worry, and I validated their feelings"
          ],
          "explanation": "Turning towards bids strengthens connection. Even small acknowledgments matter.",
          "order": 2
        }
        // ... 3 more questions
      ]
    }
    // ... more lessons
  ]
}
```

**Question Validation Rules**:
- MCQ must have 4 options (no more, no fewer)
- `correctAnswer` is 0-indexed integer for MCQ
- `sampleAnswers` array for short_answer (2-3 examples)
- `explanation` is required (shown after answering)
- `order` determines sequence in quiz

### Ritual Definitions (JSON)

**File**: `content/rituals.json`

```json
{
  "daily": [
    {
      "title": "20-Second Hug",
      "description": "A sustained hug lasting at least 20 seconds releases oxytocin, the 'bonding hormone.' This simple practice reduces stress and increases feelings of safety and connection.",
      "order": 1
    },
    {
      "title": "2-Minute Check-In",
      "description": "Share one high and one low from your day. Listen without trying to fix or advise—just acknowledge and empathize.",
      "order": 2
    }
  ],
  "weekly": [
    {
      "title": "At-Home Date Night",
      "description": "Set aside 60-90 minutes for a distraction-free activity together: cook a meal, play a game, or try a sensate focus exercise. The goal is presence, not perfection.",
      "order": 1
    }
  ]
}
```

## Import Script Specification

### Seed Script (`prisma/seed.ts`)

**Purpose**: Populate database with initial content for MVP.

**Steps**:
1. Parse Markdown frontmatter from lesson files
2. Load question banks (JSON)
3. Load ritual definitions
4. Create Prisma records in correct order (respect FKs)

**Implementation**:
```typescript
import { PrismaClient } from '@prisma/client';
import { readdirSync, readFileSync } from 'fs';
import matter from 'gray-matter';

const db = new PrismaClient();

async function main() {
  console.log('🌱
Seeding database...');

  // ============================================================================
  // 1. LOAD TOPICS + LESSONS FROM MARKDOWN FILES
  // ============================================================================
  
  const topicsDir = './content/topics';
  const topicFolders = readdirSync(topicsDir);
  
  const topicsData = [];
  
  for (const [index, topicSlug] of topicFolders.entries()) {
    const lessonFiles = readdirSync(`${topicsDir}/${topicSlug}`)
      .filter(f => f.endsWith('.md'))
      .sort();
    
    const lessonsData = [];
    
    for (const lessonFile of lessonFiles) {
      const filePath = `${topicsDir}/${topicSlug}/${lessonFile}`;
      const fileContent = readFileSync(filePath, 'utf-8');
      const { data: frontmatter, content } = matter(fileContent);
      
      lessonsData.push({
        title: frontmatter.title,
        slug: frontmatter.slug,
        content: content.trim(),
        estimatedMinutes: frontmatter.estimatedMinutes,
        learningObjectives: JSON.stringify(frontmatter.learningObjectives),
        order: parseInt(lessonFile.split('-')[0]),
      });
    }
    
    topicsData.push({
      title: toTitleCase(topicSlug),
      slug: topicSlug,
      description: getTopicDescription(topicSlug), // Helper function
      order: index + 1,
      lessons: lessonsData,
    });
  }
  
  // ============================================================================
  // 2. LOAD QUESTION BANKS
  // ============================================================================
  
  const questionBanks: Record<string, any> = {};
  
  for (const topic of topicsData) {
    const questionFile = `./content/questions/${topic.slug}.json`;
    const questionData = JSON.parse(readFileSync(questionFile, 'utf-8'));
    questionBanks[topic.slug] = questionData;
  }
  
  // ============================================================================
  // 3. CREATE TOPICS, LESSONS, QUESTIONS
  // ============================================================================
  
  for (const topicData of topicsData) {
    const topic = await db.topic.create({
      data: {
        title: topicData.title,
        description: topicData.description,
        order: topicData.order,
      },
    });
    
    console.log(`  ✓ Topic: ${topic.title}`);
    
    for (const lessonData of topicData.lessons) {
      const lesson = await db.lesson.create({
        data: {
          topicId: topic.id,
          title: lessonData.title,
          slug: lessonData.slug,
          content: lessonData.content,
          estimatedMinutes: lessonData.estimatedMinutes,
          learningObjectives: lessonData.learningObjectives,
          order: lessonData.order,
        },
      });
      
      console.log(`    ✓ Lesson: ${lesson.title}`);
      
      // Find questions for this lesson
      const questionBank = questionBanks[topicData.slug];
      const lessonQuestions = questionBank.lessons.find(
        (l: any) => l.lessonSlug === lessonData.slug
      )?.questions || [];
      
      for (const q of lessonQuestions) {
        const question = await db.question.create({
          data: {
            lessonId: lesson.id,
            type: q.type,
            question: q.question,
            options: q.options ? JSON.stringify(q.options) : null,
            correctAnswer: q.type === 'mcq' 
              ? String(q.correctAnswer) 
              : JSON.stringify(q.sampleAnswers),
            explanation: q.explanation,
            order: q.order,
          },
        });
        
        console.log(`      ✓ Question: ${question.question.substring(0, 50)}...`);
      }
    }
  }
  
  // ============================================================================
  // 4. CREATE RITUALS
  // ============================================================================
  
  const ritualsFile = './content/rituals.json';
  const ritualsData = JSON.parse(readFileSync(ritualsFile, 'utf-8'));
  
  for (const ritual of ritualsData.daily) {
    await db.ritual.create({
      data: {
        title: ritual.title,
        description: ritual.description,
        type: 'daily',
        order: ritual.order,
      },
    });
    console.log(`  ✓ Daily Ritual: ${ritual.title}`);
  }
  
  for (const ritual of ritualsData.weekly) {
    await db.ritual.create({
      data: {
        title: ritual.title,
        description: ritual.description,
        type: 'weekly',
        order: ritual.order,
      },
    });
    console.log(`  ✓ Weekly Ritual: ${ritual.title}`);
  }
  
  console.log('✅ Seed complete!');
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

function toTitleCase(slug: string): string {
  return slug
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

function getTopicDescription(slug: string): string {
  const descriptions: Record<string, string> = {
    'communication-foundations': 'Master emotional connection through research-backed communication strategies and consent frameworks.',
    'understanding-arousal': 'Learn the science of desire, arousal, and pleasure through evidence-based models.',
    'mindfulness-presence': 'Develop presence and body awareness for deeper intimacy and connection.',
  };
  return descriptions[slug] || '';
}

// ============================================================================
// RUN SEED
// ============================================================================

main()
  .catch((e) => {
    console.error('❌ Seed failed:', e);
    process.exit(1);
  })
  .finally(async () => {
    await db.$disconnect();
  });
```

### Content Validation Script

**File**: `scripts/validate-content.ts`

**Purpose**: Check content before seeding to catch errors early.

```typescript
import { readdirSync, readFileSync } from 'fs';
import matter from 'gray-matter';

const errors: string[] = [];
const warnings: string[] = [];

// Validate lesson files
function validateLessons() {
  const topicsDir = './content/topics';
  const topicFolders = readdirSync(topicsDir);
  
  for (const topicSlug of topicFolders) {
    const lessonFiles = readdirSync(`${topicsDir}/${topicSlug}`)
      .filter(f => f.endsWith('.md'));
    
    for (const lessonFile of lessonFiles) {
      const filePath = `${topicsDir}/${topicSlug}/${lessonFile}`;
      const fileContent = readFileSync(filePath, 'utf-8');
      
      try {
        const { data: frontmatter, content } = matter(fileContent);
        
        // Check required frontmatter
        if (!frontmatter.title) {
          errors.push(`${filePath}: Missing 'title' in frontmatter`);
        }
        if (!frontmatter.slug) {
          errors.push(`${filePath}: Missing 'slug' in frontmatter`);
        }
        if (!frontmatter.learningObjectives || !Array.isArray(frontmatter.learningObjectives)) {
          errors.push(`${filePath}: 'learningObjectives' must be an array`);
        }
        
        // Check content length
        if (content.trim().length < 500) {
          warnings.push(`${filePath}: Content seems short (<500 chars)`);
        }
        
        // Check for common mistakes
        if (content.includes('TODO') || content.includes('FIXME')) {
          warnings.push(`${filePath}: Contains TODO/FIXME`);
        }
        
      } catch (e) {
        errors.push(`${filePath}: Failed to parse - ${e.message}`);
      }
    }
  }
}

// Validate question banks
function validateQuestions() {
  const topicsDir = './content/topics';
  const topicFolders = readdirSync(topicsDir);
  
  for (const topicSlug of topicFolders) {
    const questionFile = `./content/questions/${topicSlug}.json`;
    
    try {
      const questionData = JSON.parse(readFileSync(questionFile, 'utf-8'));
      
      for (const lesson of questionData.lessons) {
        for (const q of lesson.questions) {
          // Validate MCQ
          if (q.type === 'mcq') {
            if (!Array.isArray(q.options) || q.options.length !== 4) {
              errors.push(`${questionFile} (${lesson.lessonSlug}): MCQ must have exactly 4 options`);
            }
            if (typeof q.correctAnswer !== 'number' || q.correctAnswer < 0 || q.correctAnswer > 3) {
              errors.push(`${questionFile} (${lesson.lessonSlug}): correctAnswer must be 0-3`);
            }
          }
          
          // Validate short_answer
          if (q.type === 'short_answer') {
            if (!Array.isArray(q.sampleAnswers) || q.sampleAnswers.length < 2) {
              errors.push(`${questionFile} (${lesson.lessonSlug}): short_answer needs 2+ sampleAnswers`);
            }
          }
          
          // Common validations
          if (!q.question || q.question.length < 10) {
            errors.push(`${questionFile}: Question text too short`);
          }
          if (!q.explanation || q.explanation.length < 20) {
            errors.push(`${questionFile}: Explanation too short`);
          }
        }
      }
    } catch (e) {
      errors.push(`${questionFile}: Failed to parse - ${e.message}`);
    }
  }
}

// Run validations
validateLessons();
validateQuestions();

// Report results
if (errors.length > 0) {
  console.error('❌ ERRORS:');
  errors.forEach(e => console.error(`  - ${e}`));
  process.exit(1);
}

if (warnings.length > 0) {
  console.warn('⚠️  WARNINGS:');
  warnings.forEach(w => console.warn(`  - ${w}`));
}

console.log('✅ Content validation passed!');
```

## Versioning & Updates

### Content Versioning Strategy

**Problem**: Users have completed lessons/quizzes. If content updates, how do we handle existing progress?

**Solution**: Content versioning with backward compatibility.

```prisma
model Lesson {
  // ... existing fields
  version     Int      @default(1)
  archivedAt  DateTime?
  
  @@index([slug, version])
}

model Question {
  // ... existing fields
  version     Int      @default(1)
  archivedAt  DateTime?
}
```

**Update Process**:
1. New content version created (v2)
2. Old version marked as archived
3. User progress remains valid (linked to v1)
4. New users get v2
5. Returning users see "Updated content available" prompt

### Migration Script Example

```typescript
// scripts/update-lesson.ts

async function updateLesson(slug: string, newContent: string) {
  // 1. Find current lesson
  const currentLesson = await db.lesson.findFirst({
    where: { slug, archivedAt: null },
  });
  
  if (!currentLesson) throw new Error('Lesson not found');
  
  // 2. Archive current version
  await db.lesson.update({
    where: { id: currentLesson.id },
    data: { archivedAt: new Date() },
  });
  
  // 3. Create new version
  await db.lesson.create({
    data: {
      ...currentLesson,
      id: undefined, // Generate new ID
      content: newContent,
      version: currentLesson.version + 1,
      archivedAt: null,
      createdAt: new Date(),
      updatedAt: new Date(),
    },
  });
  
  console.log(`✓ Updated lesson ${slug} to v${currentLesson.version + 1}`);
}
```

## Content Guidelines Reference

### Writing Style
- **Tone**: Warm, professional, non-judgmental
- **POV**: Second person ("you") for connection
- **Length**: 800-1500 words per lesson (10-12 min read)
- **Citations**: Include researcher names inline (e.g., "Dr. Gottman found...")

### Safety Reminders
- Include consent reminder every 2-3 lessons
- Medical disclaimer on any physiology content
- Conflict warning on sensitive topics (desire discrepancy, porn effects)

### Accessibility
- Alt text for any images: `![Woman and man hugging](hug.jpg "20-second embrace")`
- Heading hierarchy (no skipped levels)
- No color-only information
```

---

## CODEX PROMPT (Ready to Paste)

Now, here's the **complete prompt** to paste into Codex in VS Code on WSL:

```
ROLE: You are a senior full-stack engineer working inside VS Code on WSL. Build an MVP learning app for expertise in intimate relationships within a Christian marriage framework, using evidence-based learning loops (retrieval practice + spaced repetition + feedback + reflection).

STACK (MVP): 
- Next.js 15 (App Router) + TypeScript 5 (strict mode)
- Tailwind CSS 3 + shadcn/ui components
- Prisma 5 + SQLite (better-sqlite3)
- Vitest + Testing Library

DELIVERABLE: In this repo, create:

1. /docs/ folder with complete Markdown documentation:
   - 01-vision.md
   - 02-mvp.md
   - 03-user-stories.md
   - 04-learning-model.md
   - 05-question-bank.md
   - 06-spaced-repetition.md
   - 07-data-model.md
   - 08-architecture.md
   - 09-safety-boundaries.md

2. A working Next.js web app with these routes:
   - / → Dashboard (today's plan: reviews + next lesson + ritual status + streak)
   - /topics → List all topics with mastery %
   - /topics/[id] → Topic detail (lessons list + overall mastery)
   - /lessons/[id] → Lesson reader (Markdown rendered) + "Start Quiz" button
   - /quiz/[lessonId] → Quiz runner (5 questions: MCQ + short answer) with immediate feedback + quality rating (0-5)
   - /review → Spaced repetition queue (due questions, sorted by dueAt)
   - /rituals → Daily/weekly connection activity checklist + notes
   - /summary → Weekly analytics (streak, mastery by topic, weakest areas)

3. Database schema (Prisma) with these tables:
   - Topic, Lesson, Question, QuizAttempt, QuestionAttempt, ReviewItem, Ritual, RitualLog, Reflection, Session

4. Seed data:
   - 3 topics: "Communication Foundations", "Understanding Arousal", "Mindfulness & Presence"
   - 2 lessons per topic (6 total)
   - 5 questions per lesson (30 total: mix of MCQ and short answer)
   - Use neutral, educational titles inspired by Christian marriage, intimacy research, consent frameworks, and porn impact studies
   - DO NOT generate explicit sexual content or medical advice
   - 4 daily rituals (20-second hug, 2-minute check-in, gratitude sharing, prayer moment)
   - 3 weekly rituals (date night, sensate focus session, weekly reflection)

5. Implement SM-2 spaced repetition scheduler:
   - After each question attempt, calculate: easinessFactor, intervalDays, dueAt
   - Quality 0-2 = lapse (reset to 1 day)
   - Quality 3-5 = success (increase interval exponentially)
   - Store full review history in ReviewItem table

6. API routes:
   - POST /api/quiz/submit → Create QuizAttempt + QuestionAttempts, schedule reviews
   - POST /api/review/submit → Update ReviewItem with new schedule
   - POST /api/rituals/log → Create RitualLog entry

7. Basic tests:
   - Unit tests for lib/scheduler.ts (SM-2 algorithm edge cases)
   - Unit tests for lib/analytics.ts (mastery calculations)
   - Integration tests for API routes (with mock DB)
   - Aim for 80%+ coverage on scheduler logic

8. UI Components (shadcn/ui):
   - Use shadcn/ui for Button, Card, Progress, RadioGroup, Textarea, etc.
   - Dashboard with cards for reviews, next lesson, rituals
   - Quiz interface with question cards, immediate feedback, quality rating (0-5 slider)
   - Review queue with card-flip interaction
   - Streak indicator (fire emoji + number)

CONSTRAINTS:
- Local-first (SQLite, no cloud services)
- No authentication (single-user MVP)
- No medical claims, no coercive relationship advice, no explicit sexual instructions
- All intimacy content emphasizes consent and communication
- Include safety warnings where appropriate (conflict, medical referral)
- Keep code clean, typed (TypeScript strict), and well-organized

OUTPUT REQUIRED:
1. Create all files and code
2. Provide exact commands to run:
   - Installation: npm install (or pnpm, yarn)
   - Database setup: npx prisma generate && npx prisma db push
   - Seed data: npx prisma db seed
   - Dev server: npm run dev
   - Tests: npm run test
3. Use stable current versions (Next.js 15, Prisma 5, TypeScript 5)
4. Ensure app runs on localhost:3000 with no errors

START NOW: 
1. Initialize Next.js project with TypeScript + Tailwind
2. Set up Prisma with SQLite
3. Create schema with all tables
4. Implement seed script with sample content
5. Build UI components + pages
6. Implement quiz/review flow end-to-end
7. Add scheduler logic + tests
8. Verify everything works

GO!
```

---

## Additional Setup Commands

After Codex generates the project, you'll run:

```bash
# Install dependencies
npm install

# Install shadcn/ui components
npx shadcn-ui@latest init
npx shadcn-ui@latest add button card progress radio-group textarea badge separator

# Install additional dependencies
npm install gray-matter date-fns zod

# Set up database
npx prisma generate
npx prisma db push
npx prisma db seed

# Run development server
npm run dev

# Open browser to http://localhost:3000

# Run tests
npm run test
```

---

## Success Criteria Checklist

After Codex completes, verify:

- [ ] App loads at `http://localhost:3000` without errors
- [ ] Dashboard shows correct counts (0 reviews initially)
- [ ] Can navigate to Topics → Lesson → Quiz
- [ ] Quiz submission creates ReviewItem records
- [ ] Review queue shows due questions (next day)
- [ ] Quality ratings (0-5) correctly update scheduler
- [ ] Rituals can be logged with notes
- [ ] Weekly summary shows streak + mastery
- [ ] Tests pass: `npm run test`
- [ ] No TypeScript errors: `npx tsc --noEmit`
- [ ] Database persists on restart (check `prisma/dev.db`)

---

This specification is **production-ready** and gives Codex everything needed to build a fully functional MVP. The documentation is comprehensive, technically accurate, and respects all safety/consent boundaries while delivering a scientifically-grounded learning system.








User Stories + Acceptance Criteria (engineer-ready)


Eg. “As Josh, I can complete a 5-question quiz from a lesson and get scheduled reviews.”

Content Taxonomy + Competency Map


Topics → modules → lessons → skills → “mastery checks”.
Seed topics from your PDFs (marriage foundations, at-home connection rituals, sexuality within Christian marriage, porn effects, etc.).

2) Learning science + quiz design (this is the “scientifically proven” core)
Learning Model Spec (how people improve)


Retrieval practice, spaced repetition, interleaving, feedback, reflection, overlearning rules.
Define your “daily loop” (10–15 min) and “weekly loop” (30–60 min).
Question Bank Spec


Question types you’ll support: MCQ, short answer, scenario, “explain like I’m five”, reflection prompts.
Rules for good questions (single concept, plausible distractors, immediate feedback).
Spaced Repetition Spec


Pick algorithm (SM-2 variant is fine), define scheduling fields + lapse rules.
Mastery + Analytics Spec


What counts as “mastered”? (e.g., 90%+ over last N reviews, or stable interval threshold)
What charts you’ll show (streak, mastery by topic, weakest skills).

3) Relationship + spiritual integration (without being weird or unsafe)
Rituals & Check-ins Spec


“2-minute check-in”, “20-second hug”, prayer/Scripture prompts, at-home date templates.
Consent + tone guidelines (never coercive, never guilt-driven).
Safety + Boundaries Policy


Clear guardrails: no coercion, no explicit sexual content, no medical diagnosis, no “pressure Kristy” content.
Escalation guidance: “if this brings conflict, pause and consider counselling / GP”.

4) Engineering docs (so Codex builds the right thing)
Technical Architecture (MVP)
Stack choice (recommended for WSL): Next.js + TypeScript + Tailwind + SQLite + Prisma
Data model overview + API routes overview.
Data Model Spec (tables + fields)
Topics, Lessons, Questions, Attempts, ReviewSchedule, Reflections, Rituals, Sessions.
Content Authoring + Import Spec
Markdown format for lessons/questions + a script to import into DB.
Versioning + IDs so you can safely edit content later.
Security + Privacy Notes
Local-first by default, encryption-at-rest optional, backups, no cloud until you choose.
Test Plan
Unit tests for scheduling + scoring; e2e for “take quiz → schedule review → review”.

Prompt 1 for Codex (VS Code on WSL)
Paste this as-is into Codex:
ROLE: You are a senior full-stack engineer working inside VS Code on WSL. Build an MVP learning app for “expertise + marriage connection” using evidence-based learning loops (retrieval + spaced repetition + feedback + reflection).
STACK (MVP): Next.js (App Router) + TypeScript + Tailwind + shadcn/ui + Prisma + SQLite.
DELIVERABLE: In this repo, create:
/docs/ with Markdown docs: 01-vision.md, 02-mvp.md, 03-user-stories.md, 04-learning-model.md, 05-question-bank.md, 06-spaced-repetition.md, 07-data-model.md, 08-architecture.md, 09-safety-boundaries.md.
A working web app with these routes:
/ Dashboard (today’s plan: reviews + 1 quiz + 1 ritual)
/topics list topics
/topics/[id] topic detail (lessons + mastery)
/lessons/[id] lesson reader (markdown render) + “Start Quiz”
/quiz/[lessonId] quiz runner (MCQ + short answer) with instant feedback
/review spaced repetition queue (cards/questions due)
/rituals simple connection checklist + reflection log
Database schema with Prisma for: Topic, Lesson, Question, QuizAttempt, QuestionAttempt, ReviewItem, Reflection, Ritual, RitualLog.
Seed data with 3 topics and 2 lessons each, and 5 questions per lesson. Use neutral titles inspired by the provided PDFs (Christian marriage, intimacy, at-home dates, porn impacts) but do NOT generate explicit sexual content.
Implement a simple SM-2-style scheduler: after each question attempt, store quality (0-5), update easinessFactor, intervalDays, dueAt. Lapses reset interval.
Add basic tests for scheduler logic.
CONSTRAINTS:
Keep it local-first (SQLite). No external services required.
No medical claims, no coercive relationship advice, no explicit sexual instructions.
Keep code clean and runnable.
OUTPUT REQUIRED:
Create the files and code.
Provide exact commands to run: install, migrate, seed, dev server, tests.
If you need to choose versions, pick stable current defaults.
START NOW: Scaffold the repo, implement the Prisma schema + seed, then implement the minimal UI and quiz/review loop end-to-end.

If you want, next message I can turn your PDFs into a Topic → Lesson → Question bank blueprint (titles + learning objectives + quiz styles) so you can seed the app with content that matches what you actually care about.


# Vision + Outcomes for the GoodNik App

## Vision
The GoodNik app is designed to empower Josh in mastering sexual intimacy within a Christian marriage framework, focusing on becoming an unparalleled expert in pleasuring Kristy through every conceivable technique, position, and sensory exploration that enhances her arousal, orgasmic intensity, and overall ecstasy. This vision extends beyond physical acts to foster profound emotional and spiritual bonds, ensuring that sexual encounters result in the most explosive, multi-orgasmic experiences for both partners while aligning with principles of mutual consent, respect, and biblical values of oneness in marriage (e.g., Genesis 2:24, Song of Solomon). By integrating evidence-based insights from leading sexologists, the app transforms routine intimacy into transcendent, orgasm-centered connections that prioritize Kristy's pleasure—making her feel desired, ravished, and deeply loved—while helping Josh overcome any barriers like performance anxiety or porn-influenced distortions.

Drawing from initial content sources in the uploaded PDFs (e.g., "Thriving Sexual Intimacy in Christian Marriage," "Restoring and Strengthening a Christian Marriage," "Holistic Attraction & Seduction Plan," porn impact studies from PubMed and APA, and date idea compilations), the app starts with v0 content emphasizing privacy, consent, and avoiding porn triggers. These sources highlight self-reports on satisfaction, emotional closeness, conflict repair, and orgasm quality, ensuring the app respects Kristy's autonomy while guiding Josh toward expert-level proficiency in delivering mind-blowing orgasms through clitoral stimulation, G-spot targeting, anal play (if consensual), edging techniques, and multi-sensory foreplay. The ultimate goal is a marriage where sex is not just frequent but extraordinarily fulfilling, with orgasms that leave Kristy quivering in waves of pleasure, strengthening the emotional-spiritual union and reducing any negative porn effects like desensitization or unrealistic expectations.

Incorporating diverse sexologist perspectives:

- **Esther Perel** (Mating in Captivity): Emphasizes maintaining erotic mystery in long-term relationships to fuel desire, suggesting playful teasing and novelty to build anticipation for intense orgasms, viewing sex as a gateway to deepest emotional places where pleasure triggers passion, joy, and love.

- **Emily Nagoski** (Come As You Are): Introduces the Dual Control Model, where accelerators (e.g., erotic stimuli like nipple play or dirty talk) amp up arousal, while removing brakes (stress, fatigue) allows for easier, more powerful orgasms; app modules will teach identifying Kristy's personal accelerators for squirting or full-body climaxes.


- **Rosemary Basson**: Her circular model of female sexual response highlights that women's desire often emerges from arousal rather than preceding it, so starting with non-genital touch builds to responsive desire, leading to multiple orgasms through cycles of pleasure and satisfaction



- **Peggy Kleinplatz**: Defines optimal sexuality through eight components like deep erotic intimacy, extraordinary communication, and being fully present, enabling "magnificent sex" with transcendent pleasure, vulnerability, and connection that elevates orgasms to spiritual highs




- **Lori Brotto**: Advocates mindfulness to heighten bodily sensations, improving orgasm quality by unifying mind and body, reducing distractions for more intense, connected climaxes during penetration or oral sex.




- **Ian Kerner** (She Comes First): Focuses on cunnilingus mastery with techniques like rhythmic tongue circles on the clitoris, building tension for clitoral orgasms, ensuring Kristy achieves ecstasy before intercourse for mutual fulfillment.


- **Barry McCarthy**: Promotes intimacy-based sex therapy, integrating emotional bonds with erotic play to enhance pleasure, using shared exploration of erogenous zones for deeper orgasms and relational security




- **John Gottman** (Sound Relationship House): Builds emotional intimacy through love maps and turning towards bids, creating a foundation where sex reinforces trust and fondness, leading to more vulnerable, orgasmic encounters.


- **Sue Johnson** (Emotionally Focused Therapy): Views sex through attachment lenses, where secure bonds allow open exploration of desires, turning physical pleasure into emotional healing and intensified orgasms


- **Masters and Johnson**: Their sensate focus technique encourages non-goal-oriented touch to build arousal gradually, reducing anxiety for spontaneous, powerful orgasms through full-body exploration.



This holistic vision ensures the app evolves from Christian-rooted content to expert-guided explicit mastery, always prioritizing consent and avoiding coercion.

## Outcomes
### What "Expert" Means: Measurable Competencies
Becoming an "expert" in pleasuring Kristy involves mastering techniques for every facet of her pleasure, measured by self-reported metrics from app quizzes, reflections, and weekly summaries. Competencies include:
- **Clitoral Mastery (Kerner-inspired)**: Achieve 90% success in inducing clitoral orgasms via oral techniques like flat-tongue lapping, suction, and vibration simulation, tracking frequency of Kristy's vocalized peak pleasure (e.g., 5+ sessions/week with multi-orgasms)





- **G-Spot and Internal Stimulation (Nagoski/Basson)**: Expertly locate and stimulate the G-spot with curved fingers or angled penetration for squirting orgasms, measuring via orgasm intensity scales (1-10, aiming for 8+ consistently), incorporating accelerators like simultaneous clitoral touch.





- **Anal and Full-Body Exploration (Kleinplatz/McCarthy)**: If consensual, introduce gentle anal play (fingering, toys) for blended orgasms, with metrics on erotic intimacy depth (e.g., post-session connection ratings) and pleasure variety (tracking 10+ positions/erogenous zones per month).



- **Edging and Multi-Orgasmic Build-Up (Brotto/Perel)**: Use mindfulness to edge Kristy toward orgasm thresholds, delaying release for amplified climaxes, measured by orgasm count per session (target: 3-5) and duration variability from PDFs (e.g., extending pleasure waves)





- **Porn Impact Mitigation**: From PDF sources on porn effects, competencies include shifting from visual fixation to sensory focus, measured by reduced desensitization (e.g., easier arousal without aids, per self-reports).

Mastery threshold: 90% quiz accuracy on techniques, stable review intervals in spaced repetition.

### What "Connection with Kristy + Self" Means: Measurable Habits/Rituals
Connection manifests as intertwined emotional-spiritual bonds amplified by orgasms, measured through daily/weekly rituals:


- **Emotional Bids and Rituals (Gottman/Johnson)**: Daily 20-second hugs or prayer prompts building attachment, tracked by connection scores (e.g., fondness/admiration logs, aiming for 80% positive bids), leading to post-orgasm cuddling for oxytocin-fueled bonding.



- **Sensate Focus Sessions (Masters and Johnson)**: Weekly non-sexual touch rituals evolving to erotic play, measuring self-connection via reflection prompts on bodily awareness and mutual pleasure peaks.

</argument>
</grok:render>


- **Mindful Orgasm Sharing (Brotto/Kleinplatz)**: Habits like shared breathing during climax for synchronized orgasms, tracked by emotional closeness scales (e.g., pre/post-session ratings) and rituals from date idea PDFs (at-home dates with teasing foreplay).- *

*Erotic Communication (Perel/McCarthy)**: Daily discussions of fantasies without judgment, measured by orgasm satisfaction feedback loops, ensuring spiritual alignment from Christian marriage PDFs.

Outcomes tracked via app analytics: Streak maintenance, mastery charts, and weakest areas for growth, aiming for sustained high orgasm quality and connection over 6 months.



Prompt 2
ROLE: You are a senior full-stack engineer continuing development on the HugCoach app repo built from the previous MVP prompt. The app is a local-first Next.js learning platform using spaced repetition to help Josh become an absolute master of female pleasure and orgasms in marriage. The goal is now to make the content MUCH more explicit, detailed, and "spicy" — no censorship, no holding back on anatomical language, techniques, or descriptions. Focus heavily on teaching advanced, proven techniques for giving Kristy intense, multiple, full-body, squirting, and blended orgasms using insights from PhD sexologists (Ian Kerner, Emily Nagoski, Peggy Kleinplatz, Rosemary Basson, Lori Brotto, etc.).
STACK remains: Next.js (App Router) + TypeScript + Tailwind + shadcn/ui + Prisma + SQLite.
PREVIOUS WORK: The repo already has safe, neutral topics (communication, arousal models, mindfulness). Keep those but now ADD a new "Advanced Mastery" section with explicitly sexual topics and lessons. Mark advanced topics as optional/unlockable after basic mastery if possible, but make them fully accessible.
DELIVERABLE: Update the existing repo with the following:
Update /docs/01-vision.md to a spicier version emphasizing mastery of female orgasm techniques (clitoral, G-spot, squirting, edging, blended, multiple, full-body) and explicit pleasuring skills. Explicitly state the goal is for Josh to learn more about female orgasms and sexual techniques than he ever thought possible, drawing directly from Kerner ("She Comes First" oral mastery), Nagoski (Dual Control Model accelerators/brakes), Kleinplatz (components of magnificent sex), etc. Include measurable outcomes like "90% mastery on techniques for inducing squirting orgasms" and "tracking multi-orgasm sessions."
Add new advanced topics to the seed data (in prisma/seed.ts or equivalent):
Topic: "Clitoral Orgasm Mastery" (Inspired by Ian Kerner – She Comes First)
Lessons:
Core Techniques: Tension building, flat tongue strokes, rhythmic consistency, suction, specific patterns (circles, side-to-side, up-down flicks).
Advanced Oral Routines: Full sequences (start slow at perineum → long licks → focused clitoral head → building to climax without stopping).
6-8 explicit questions per lesson (mix MCQ and short answer) testing detailed technique recall.
Topic: "G-Spot Stimulation & Squirting"
Lessons:
Locating and stimulating the G-spot (come-hither motion, firm pressure, simultaneous clitoral touch).
Squirting mechanics and techniques (bearing down, relaxation, building pressure, best positions like doggy or legs-up missionary).
Explicit questions on angles, pressure, and combining with clitoral stim.
Topic: "Edging & Multiple Orgasms"
Lessons:
Edging theory and practice (bringing to the brink 5-10 times, reading body signals, backing off).
Building to 3-10+ orgasms per session, recovery techniques, tantric breathing.
Questions on timing, reading cues, and personal application.
Topic: "Blended & Full-Body Orgasms"
Lessons:
Combining clitoral + G-spot, nipple play, anal (if consensual), A-spot/cervical.
Positions for maximum stimulation (woman on top grinding, doggy with reach-around, prone bone, bridge, etc.).
Types of orgasms (clitoral, vaginal, blended, anal, coregasm, nipple).
Explicit scenario questions.
Topic: "Magnificent Sex Framework" (Peggy Kleinplatz)
Lessons on the 8 components: presence, authenticity, vulnerability, transcendence, extraordinary communication, etc., applied to explicit sexual scenarios.
Topic: "Accelerators & Brakes Mastery" (Emily Nagoski Dual Control Model)
Identifying and maximizing Kristy's personal accelerators (specific touches, dirty talk, settings) while removing brakes for easier, more explosive orgasms.
Update seed data to include 4-6 lessons per advanced topic, each with detailed Markdown content that is fully explicit:
Use anatomical terms (clitoris, vulva, labia, G-spot, urethral sponge, etc.).
Describe techniques step-by-step with intensity, rhythm, pressure, duration.
Include warnings/reminders about consent, communication, and stopping if uncomfortable.
Example lesson excerpt style: "Start with 10 slow, flat-tongue licks from the vaginal entrance to the clitoral head, applying gentle upward pressure. Gradually increase speed while maintaining consistent rhythm — this builds tension essential for powerful clitoral orgasms (Kerner)."
Add explicit quiz questions examples (generate 40-50 total across new topics):
MCQ: "According to Ian Kerner, what is the most important principle for clitoral stimulation? A) Speed B) Consistency of rhythm C) Hard pressure D) Intermittent stopping" (Answer: B)
Short answer: "Describe the 'come-hither' motion for G-spot stimulation and explain how combining it with clitoral touch creates a blended orgasm."
Scenario: "Kristy is close to orgasm but plateaus. What edging technique should you use to push her into multiples?"
Minor UI updates:
Add a toggle or section on dashboard for "Advanced Mastery Mode" that shows/unlocks spicy topics.
In lesson reader, add a "Consent Reminder" banner on advanced lessons.
Add tracking fields if needed (e.g., self-reported orgasm quality logs in reflections, optional).
Keep all previous functionality (SM-2 scheduler, reviews, rituals, dashboard) but enhance ritual suggestions to include spicier options (e.g., "Extended oral pleasure session" or "Edging practice date").
CONSTRAINTS:
REMAIN local-first, privacy-focused.
ALWAYS emphasize enthusiastic consent, communication, and Kristy's comfort/autonomy in every lesson.
Explicit sexual content is REQUIRED and encouraged in advanced sections — be detailed, anatomical, and technique-focused.
NO coercion, pressure, or guilt language.
Base techniques on established sexologists (cite Kerner, Nagoski, Kleinplatz, etc., in lessons).
OUTPUT REQUIRED:
Update existing files (vision.md, seed.ts, etc.).
Add new seed content with explicit lessons/questions.
Provide exact commands: npm run dev, etc.
Ensure the app runs with new spicy content loaded.
START NOW: First update 01-vision.md with the spicier vision, then add the new advanced topics and seed data with fully explicit content, then test the quiz/review flow with the new questions. Make this the deepest, most comprehensive female orgasm mastery curriculum possible.







Prompt 3

ROLE: You are a senior full-stack engineer continuing development on the HugCoach app repo (built from previous MVP and Prompt 2). The app is now a deeply explicit, NSFW, mind-expanding sexual mastery platform designed to blow Josh's mind with every new concept, technique, and philosophy from global sexology traditions — focused exclusively on heterosexual married intimacy (man pleasuring woman + mutual ecstasy). The goal is to expose Josh to the widest possible range of advanced, proven ideas from Eastern and Western sexology (Tantra, Taoism, Kama Sutra, modern sex therapists) so he gains encyclopedic knowledge of female pleasure, multiple orgasm pathways, energy-based sex, prolonged ecstasy, and creative variations — all while prioritizing enthusiastic consent, communication, and Kristy's autonomy/comfort.
STACK remains: Next.js (App Router) + TypeScript + Tailwind + shadcn/ui + Prisma + SQLite.
PREVIOUS WORK: The app already has foundational topics (communication, arousal models) + advanced female orgasm mastery (clitoral, G-spot/squirting, edging/multiples, blended/full-body, magnificent sex, accelerators/brakes). Keep everything but now EXPAND dramatically with mind-blowing new sections covering diverse sexual philosophies and advanced heterosexual techniques.
DELIVERABLE: Update the repo to make the content explosively spicy, NSFW, and comprehensive:
Update /docs/01-vision.md to reflect the new expanded scope: Emphasize mind-blowing exposure to EVERY major sexual philosophy (Tantra, Taoism, Kama Sutra, Western sexology) for straight couples. State the goal is for Josh to learn thousands of explicit techniques/ideas that will repeatedly blow his mind with new possibilities for Kristy's pleasure and mutual transcendence. Include measurable outcomes like "90% mastery on Tantric energy circulation for full-body orgasms" and "tracking 10+ different orgasm types achieved."
Add a new "Sexual Philosophies & Advanced Exploration" category in topics (unlockable or visible in Advanced Mastery Mode). Seed 8-10 new high-impact topics with 4-6 explicit lessons each:
Topic: "Tantric Sex Mastery" (Eastern Tantra – slow, energetic, transcendent sex)
Lessons: Eye gazing & breath synchronization; Yab-Yum position for energy merging; Slow penetration with PC muscle contractions; Energy orgasms without movement; Full-body energy circulation for extended ecstasy.
Topic: "Taoist Sexual Alchemy" (Mantak Chia-inspired – energy retention, multi-orgasmic man/woman)
Lessons: Testicle/ovarian breathing; Big Draw technique for whole-body orgasms; Valley orgasms (non-ejaculatory male peaks); Circulating sexual energy up the spine; Harmonizing yin/yang for marathon sessions.
Topic: "Kama Sutra Exploration"
Lessons: Embracing & kissing varieties; Nail marks, biting, scratching (consensual); Advanced positions (Mare's Position, Congress of the Cow, etc.); Oral techniques from ancient texts; Erotic scratching and hair-pulling dynamics.
Topic: "Advanced Erotic Massage"
Lessons: Full-body sensual massage sequences (lingam/yoni focus last); Feather-light touch to intense pressure; Breast/nipple massage for arousal; Perineum and sacral stimulation; Yoni massage for deep release and squirting prep.
Topic: "Exotic Orgasm Types"
Lessons: Cervical orgasms (deep penetration techniques); A-spot & U-spot stimulation; Nipple-only orgasms; Coregasms & exercise-induced; Breath/blended energy orgasms; Sleep orgasms & dream cultivation.
Topic: "Marathon Lovemaking Sessions"
Lessons: Building sessions to 1-3+ hours; Alternating high/low arousal; Edging both partners; Position marathons; Recovery strokes for endless waves.
Topic: "Fantasy & Role-Play Integration" (Perel-inspired eroticism)
Lessons: Building mystery/desire in long-term marriage; Safe fantasy sharing; Stranger role-play; Dominant/submissive dynamics (light); Erotic storytelling during sex.
Topic: "Sensual Toys & Enhancers"
Lessons: Vibrators for clitoral/G-spot blending; Dildos for dual penetration feel; Cock rings for prolonged erection; Nipple clamps & feathers; Lubricants and temperature play.
Topic: "The Joy of Sex Variations" (Alex Comfort-inspired creative play)
Lessons: Outercourse & mutual masturbation; Pompoir (vaginal gripping); Advanced oral variations; Spontaneous quickies vs. planned rituals.
Topic: "Passionate Marriage Dynamics" (David Schnarch – differentiation & intense intimacy)
Lessons: Holding onto self during deep vulnerability; Wall-socket sex (intense eye contact penetration); Using desire differences for growth.
For each new topic/lesson: Write fully explicit Markdown content — anatomical (yoni, lingam, clitoris, cervix, etc.), step-by-step techniques, rhythms, pressures, durations, body signals. Example: "In Yab-Yum, sit lotus-style with penetration; synchronize breathing while contracting PC muscles in waves — this circulates energy for full-body orgasms that feel like electric waves through the spine (Tantra)."
Generate 50-80 new explicit quiz questions across topics (MCQ, short answer, scenario):
MCQ: "In Taoist practice, the 'Big Draw' is used to: A) Ejaculate forcefully B) Circulate energy for non-ejaculatory orgasm C) Speed up thrusting" (B)
Short answer: "Describe the Mare's Position from Kama Sutra and how the woman controls rhythm for her pleasure."
Scenario: "Kristy wants longer sessions without fatigue — outline a Tantric breathing sequence to build energy."
Enhancements:
Add "Session Journal" feature: Optional logging of practice sessions (orgasm types achieved, duration, new techniques tried, Kristy's feedback, mind-blowing insights).
Spicier rituals: "Tantric date night," "Extended yoni massage," "Energy circulation practice," "Role-play evening."
UI: Add "Mind-Blowing Insights" highlights in lessons (quotes from philosophies that reframe sex entirely).
Reflection prompts: "What new idea from this lesson completely shifted your view of what's possible in bed?"
CONSTRAINTS:
Local-first, privacy absolute.
EVERY piece of content MUST hammer enthusiastic consent, communication, check-ins, and stopping immediately if uncomfortable.
Explicit, anatomical, NSFW language REQUIRED — no censorship, detailed descriptions of penetration, oral, manual, energy, positions.
Straight heterosexual focus only (man/woman married couple).
Base on real philosophies/sexologists (cite Tantra, Taoism, Kama Sutra, Schnarch, Comfort, etc.).
No coercion, pressure, or guilt — frame as joyful exploration.
OUTPUT REQUIRED:
Update vision.md with expanded mind-blowing scope.
Add all new topics/lessons/questions to seed data.
Implement journal feature (simple form + list view).
Provide run commands.
Ensure app loads new content seamlessly.
START NOW: Begin with vision update, then seed the new philosophy topics with maximally explicit, mind-expanding content that will repeatedly blow the user's mind with depth and variety. Make this the ultimate heterosexual sexology encyclopedia.
Based on the metadata and content of your uploaded file HugCoach.txt, it appears you are following a "LLM-driven development" workflow. Prompt 1 generated the specifications. Prompt 4 is designed to take the app from a basic MVP to a "mind-blowing," feature-rich, and content-heavy application, specifically focusing on the Journal feature and expanding the content depth (incorporating the explicit/philosophical aspects mentioned in the file's tail).
Here is Prompt 4, drafted to be pasted directly into Codex or your LLM editor to execute these improvements.

Prompt 4: Comprehensive Expansion & Polish
Context: We have established the MVP specifications and the basic application structure for HugCoach. Now, we need to significantly upgrade the application's scope, content depth, and feature set to move beyond a "basic" app into a "mind-blowing" expert tool.
Goal: Improve the app in every possible way by:
Expanding the Vision & Content: Shift from basic instruction to a deep, explicit, and philosophical "encyclopedia" of heterosexual intimacy.
Implementing the Journal Feature: Allow users to track their journey and insights.
Polishing the UI/UX: Ensure the new content loads seamlessly and the experience is engaging.
Constraints & Guidelines:
Privacy First: Maintain strict local-only data storage (SQLite).
Consent & Safety: EVERY piece of content MUST emphasize enthusiastic consent, communication, and the ability to stop immediately.
Explicit & Anatomical: Use NSFW, clinical, and descriptive language (no censorship). Cover detailed descriptions of penetration, oral, manual, energy, and positions.
Philosophical Basis: Integrate concepts from Tantra, Taoism, Kama Sutra, Schnarch, Comfort, etc.
Target Audience: Straight heterosexual married couples (man/woman).
Tone: Joyful exploration, no pressure, no coercion, no guilt.
Execution Tasks:
1. Update Product Documents
Update 01-vision.md and 02-mvp.md to reflect the expanded scope:
New Feature: "Mind-Blowing Insights" – highlights in lessons that reframe sex entirely.
New Feature: "Spicier Rituals" – e.g., "Tantric date night," "Extended yoni massage," "Energy circulation practice," "Role-play evening."
Journaling: Define the requirements for the Journal feature (tracking practice sessions, orgasm types, duration, techniques tried, feedback).
2. Implement the Journal Feature
Create the full vertical slice for the Journal:
Database: Update schema.prisma to include a JournalEntry model (date, activity types, duration, rating, notes, private boolean).
UI: Create /journal page with:
A "Log Session" form (simple, friction-less).
A list view of past entries.
Reflection prompts: "What new idea shifted your view?", "What was the highlight?".
3. Expand Seed Content (The "Encyclopedia")
Update the seed script (prisma/seed.ts or equivalent) to include 3-5 new, highly detailed topics that push the boundaries:
Topic Ideas: "The Art of Tantric Touch," "Advanced Oral Mastery," "Energy & Breathwork."
Content: Write explicit, step-by-step lessons for these topics using the "Expert Integration" sources (Perel, Nagoski, etc.).
Reframing: Include "Mind-Blowing Insight" callouts in these lessons.
4. Technical Refinement
Ensure the "Run Commands" (dev server, db push) work with the new schema.
Verify that the app loads the new heavy content steps seamlessly.
START NOW: Begin by updating 01-vision.md with the new "mind-blowing" scope, then proceed to modify the schema and implement the Journal feature. Finally, generate the new explicit seed data. Output the code for all changed files.

Prompt 5: Technical Excellence & Feature Enhancement
ROLE: You are a distinguished principal engineer and UX architect tasked with transforming the HugCoach app from a functional MVP into a world-class, production-grade learning platform. Your mandate is to implement cutting-edge technical improvements, sophisticated UX patterns, advanced analytics, and robust engineering practices while maintaining the app's explicit educational mission and local-first architecture.

STACK: Next.js 15 (App Router) + TypeScript 5 (strict) + Tailwind CSS 3 + shadcn/ui + Prisma 5 + SQLite (better-sqlite3) + Vitest + Playwright

CURRENT STATE: The app has comprehensive content (foundational → advanced → philosophical sexual mastery), basic SM-2 spaced repetition, quiz/review flows, ritual tracking, and weekly analytics. All core features work but lack polish, performance optimization, advanced UX patterns, and production-grade error handling.

OBJECTIVE: Elevate EVERY aspect of the application to professional standards while adding powerful new features that dramatically improve learning efficacy, user engagement, and technical robustness.

---

## PART 1: CORE TECHNICAL IMPROVEMENTS

### 1.1 Advanced Spaced Repetition & Learning Science

**Upgrade SM-2 to FSRS (Free Spaced Repetition Scheduler)**:
- Implement FSRS algorithm (more accurate than SM-2, uses ML-derived parameters)
- Add difficulty/stability tracking per question
- Implement retrievability calculation for optimal scheduling
- Add load balancing (distribute reviews evenly across days)
- Support custom scheduling presets (aggressive/balanced/relaxed)

**Learning Analytics Engine**:
```typescript
// lib/analytics/learning-engine.ts
interface LearningMetrics {
  retentionRate: number;           // % correct on first review attempt
  masteryVelocity: number;          // Days to reach 90% mastery
  forgettingCurve: DataPoint[];     // Plot retention over time
  optimalStudyTime: number;         // Personalized best time of day
  weeklyLoadRecommendation: number; // Adaptive new lesson suggestions
  strugglingConcepts: string[];     // Auto-identified weak areas
  learningMomentum: number;         // Engagement trajectory score
}

Adaptive Difficulty:
Analyze performance patterns to surface easier questions first in reviews
Auto-flag questions with >40% lapse rate for content review
Suggest prerequisite lessons if struggling with advanced topics
Implement "graduated interval" unlocking (master basics before philosophy topics)
Interleaving Scheduler:
Never show 2 questions from same lesson consecutively in reviews
Mix topics in daily queue for better discrimination learning
Smart shuffling based on similarity scores
1.2 Performance Optimization
Database Query Optimization:
// Implement query result caching
import { LRUCache } from 'lru-cache';

const queryCache = new LRUCache<string, any>({
  max: 500,
  ttl: 1000 * 60 * 5, // 5 min cache
});

// Add database indexes for all hot paths
@@index([dueAt, userId])
@@index([lessonId, order])
@@index([topicId, completedAt])

// Implement prepared statements for frequent queries
const getReviewQueueStmt = db.prepare(`
  SELECT * FROM ReviewItem 
  WHERE dueAt <= ? AND userId = ? 
  ORDER BY dueAt ASC, priority DESC 
  LIMIT 50
`);

Bundle Optimization:
Implement route-based code splitting for all lesson content
Lazy load quiz components until needed
Use Next.js Image component with proper sizing
Tree-shake unused shadcn/ui components
Target: <100KB First Load JS, <30KB per route
Virtual Scrolling:
Implement react-virtual for long lesson lists (1000+ items)
Infinite scroll for review history
Windowed rendering for question banks
Progressive Web App (PWA):
// next.config.js + workbox
{
  "pwa": {
    "dest": "public",
    "register": true,
    "skipWaiting": true,
    "runtimeCaching": [
      {
        "urlPattern": "/api/.*",
        "handler": "NetworkFirst",
        "options": { "cacheName": "api-cache" }
      }
    ]
  }
}

Offline support for reading lessons
Background sync for quiz submissions
Add to home screen prompt
Service worker for asset caching
1.3 Advanced State Management
Implement Zustand for Global State:
// stores/app-store.ts
interface AppState {
  // User preferences
  theme: 'light' | 'dark' | 'auto';
  studyReminders: boolean;
  reviewsPerSession: number;
  
  // Learning state
  currentStreak: number;
  reviewQueue: ReviewItem[];
  todayProgress: DailyProgress;
  
  // UI state
  sidebarOpen: boolean;
  activeFilters: TopicFilter[];
  
  // Actions
  updatePreferences: (prefs: Partial<Preferences>) => void;
  incrementStreak: () => void;
  markReviewComplete: (id: string) => void;
}

Optimistic Updates:
Instant UI feedback on quiz submissions (update before API response)
Rollback mechanism for failed mutations
Toast notifications for sync status
React Query Integration:
// For server state management
const { data: reviewQueue, isLoading } = useQuery({
  queryKey: ['reviews', userId],
  queryFn: fetchReviews,
  staleTime: 1000 * 60, // 1 min
  refetchOnWindowFocus: true,
});

const submitQuiz = useMutation({
  mutationFn: submitQuizAttempt,
  onMutate: async (newAttempt) => {
    // Optimistic update
    await queryClient.cancelQueries(['reviews']);
    const prev = queryClient.getQueryData(['reviews']);
    queryClient.setQueryData(['reviews'], optimisticUpdate);
    return { prev };
  },
  onError: (err, vars, context) => {
    queryClient.setQueryData(['reviews'], context.prev);
  },
});



PART 2: ADVANCED UX/UI ENHANCEMENTS
2.1 Sophisticated Quiz Interface
Multi-Modal Question Types:
// Add new question types
type QuestionType = 
  | 'mcq' 
  | 'short_answer'
  | 'multi_select'          // Multiple correct answers
  | 'ordering'              // Sequence steps correctly
  | 'matching'              // Match terms to definitions
  | 'fill_blank'            // Cloze deletion
  | 'image_hotspot'         // Click anatomical diagrams
  | 'slider_rating';        // Rate 1-10 with justification

Progressive Disclosure Quiz UI:
Show one question at a time with smooth transitions
Progress bar with question numbers
"Mark for review" flag system
Skip button with later prompt
Timer (optional, for self-pacing awareness)
Rich Feedback System:
interface Feedback {
  correct: boolean;
  explanation: string;
  expertInsight: string;        // Sexologist quote
  relatedLesson: string;         // Link to review
  commonMistake: string;         // If wrong, why people miss this
  practicalTip: string;          // Immediate application
  visualAid?: string;            // Optional diagram/animation
}

Answer Confidence Rating:
Before seeing result, rate confidence (1-5)
Track metacognition accuracy over time
Adjust scheduling based on confidence-correctness mismatch
2.2 Immersive Lesson Reader
Enhanced Markdown Rendering:
// Custom MDX components
const components = {
  h2: ({ children }) => (
    <h2 className="scroll-mt-16 text-2xl font-bold tracking-tight">
      {children}
      <button className="ml-2 text-xs">🔗 Copy Link</button>
    </h2>
  ),
  
  Callout: ({ type, children }) => (
    <div className={`p-4 rounded-lg ${typeStyles[type]}`}>
      {children}
    </div>
  ),
  
  Technique: ({ name, steps }) => (
    <div className="technique-card">
      <h3>{name}</h3>
      <ol>{steps.map(s => <li key={s}>{s}</li>)}</ol>
    </div>
  ),
  
  ConsentReminder: () => (
    <aside className="consent-banner">
      ⚠️ Always ensure enthusiastic consent and open communication
    </aside>
  ),
};

Interactive Elements:
Expandable technique demonstrations
Inline glossary (hover anatomical terms for definitions)
Progress checkpoints ("Mark as understood" per section)
Audio narration (optional TTS for lessons)
Highlight & note-taking (local storage)
Table of Contents:
Auto-generated from headings
Sticky sidebar with scroll spy
Estimated reading time per section
Jump to specific techniques
2.3 Advanced Dashboard
Personalized Learning Dashboard:
interface DashboardData {
  hero: {
    streak: number;
    nextMilestone: string;
    motivationalQuote: string;
  };
  
  todayPlan: {
    reviewsDue: number;
    reviewsOverdue: number;
    suggestedNewLesson: Lesson;
    ritualReminder: Ritual;
    estimatedTime: number; // minutes
  };
  
  insights: {
    weeklyProgress: ProgressChart;
    topicMasteryRadar: RadarChart;
    learningVelocity: number;
    consistencyScore: number;
    weakestAreas: ConceptGap[];
  };
  
  achievements: Badge[];
  recentActivity: Activity[];
}

Gamification Elements:
Achievement badges (first orgasm mastery, 30-day streak, philosophy explorer)
Level system (Novice → Intermediate → Expert → Master → Guru)
Daily challenges ("Review 10 questions today")
Leaderboard (compete with past self, not others)
Unlock rewards (new ritual ideas, bonus content)
Smart Suggestions:
ML-based next lesson recommendations
"Similar learners also studied..."
Adaptive difficulty progression
Time-of-day optimization ("You learn best at 7pm")
2.4 Enhanced Ritual Tracking
Ritual Logging 2.0:
interface RitualLog {
  id: string;
  ritualId: string;
  date: string;
  completed: boolean;
  
  // New fields
  durationMinutes: number;
  qualityRating: number;          // 1-10
  emotionalConnectionScore: number; // 1-10
  notes: string;
  techniques: string[];           // Tags for what was practiced
  partnerFeedback?: string;       // Optional Kristy input
  nextTimeGoals: string;
  
  // Metrics
  orgasmsCount?: number;
  newDiscoveries: string[];
}

Ritual Analytics:
Correlation analysis (ritual frequency → mastery improvement)
Best time/day for rituals (pattern detection)
Technique effectiveness tracking
Emotional connection trends
Ritual Library:
Searchable/filterable ritual database
Custom ritual creation
Community-inspired rituals (future)
Difficulty ratings (beginner → advanced)


PART 3: ADVANCED FEATURES
3.1 Intelligent Content System
Dynamic Content Generation:
// AI-powered quiz generation from lessons
async function generateQuizFromLesson(lessonId: string) {
  const lesson = await getLesson(lessonId);
  
  // Extract key concepts via NLP
  const concepts = extractConcepts(lesson.content);
  
  // Generate questions at varying difficulty
  const questions = concepts.map(concept => ({
    type: 'mcq',
    question: `According to ${lesson.source}, ${concept.question}?`,
    options: generateDistractors(concept),
    correctAnswer: concept.answer,
    explanation: concept.context,
  }));
  
  return questions;
}

Content Versioning:
// Track lesson updates
interface LessonVersion {
  id: string;
  lessonId: string;
  version: number;
  content: string;
  changelog: string;
  publishedAt: Date;
  
  // Migration path for user progress
  questionMappings: { oldId: string; newId: string }[];
}

// Notify users of updates
function checkForUpdates() {
  const outdatedLessons = getCompletedLessons()
    .filter(l => l.version < latestVersion);
    
  if (outdatedLessons.length > 0) {
    showNotification('New insights available in 3 lessons!');
  }
}

Prerequisite System:
model Lesson {
  // ... existing fields
  prerequisites: Lesson[] @relation("Prerequisites")
  unlocksMastery: number @default(0) // Required % to unlock
}

3.2 Advanced Analytics & Insights
Machine Learning Predictions:
// Predict review success rate
function predictReviewSuccess(reviewItem: ReviewItem): number {
  const features = {
    daysSinceLastReview: reviewItem.intervalDays,
    repetitions: reviewItem.repetitions,
    easinessFactor: reviewItem.easinessFactor,
    timeOfDay: new Date().getHours(),
    dayOfWeek: new Date().getDay(),
    recentSuccessRate: getUserSuccessRate(7), // last 7 days
  };
  
  return mlModel.predict(features);
}

// Adaptive review scheduling
if (predictReviewSuccess(item) < 0.7) {
  // Show this review sooner
  adjustInterval(item, -2);
}

Behavioral Analytics:
interface UserBehaviorMetrics {
  sessionDuration: number[];
  peakLearningHours: number[];
  dropoffPoints: string[];        // Where users quit lessons
  strugglingTopics: string[];
  engagementScore: number;
  
  // Advanced
  cognitiveLoad: number;          // Inferred from pause times
  comprehensionRate: number;      // First-attempt accuracy
  retentionCurve: DataPoint[];
}

Visualization Library:
Victory charts for progress over time
Recharts for topic mastery radar
D3.js for custom knowledge graphs
Heatmaps for study patterns
3.3 Session Journal Enhancement
Rich Session Logging:
interface SessionJournal {
  id: string;
  date: Date;
  
  // Detailed tracking
  techniquesUsed: Technique[];
  orgasmDetails: {
    count: number;
    types: OrgasmType[];
    intensityRatings: number[];
    duration: number[];
  };
  
  // Qualitative
  newDiscoveries: string;
  challengesFaced: string;
  kristyFeedback: string;
  emotionalConnection: number;   // 1-10
  physicalSatisfaction: number;  // 1-10
  
  // Learning integration
  lessonsApplied: string[];
  improvementGoals: string;
  
  // Media (optional, encrypted)
  voiceNotes?: Blob[];
  privatePhotos?: Blob[];         // Encrypted at rest
}

Pattern Recognition:
Auto-detect successful technique combinations
Suggest based on past successes
Identify plateaus and recommend new approaches
Goal Tracking:
interface Goal {
  id: string;
  title: string;                  // "Master squirting technique"
  category: 'technique' | 'frequency' | 'connection';
  targetDate: Date;
  milestones: Milestone[];
  
  // Tracking
  currentProgress: number;        // %
  sessionsLogged: number;
  breakthroughs: string[];
}

3.4 Smart Reminders & Notifications
Intelligent Notification System:
interface SmartReminder {
  type: 'review' | 'ritual' | 'lesson' | 'milestone';
  priority: 'low' | 'medium' | 'high';
  
  // ML-optimized timing
  optimalTime: Date;              // Predicted best engagement time
  
  // Context-aware
  message: string;
  actionButton: string;
  
  // Personalization
  tone: 'encouraging' | 'urgent' | 'playful';
}

// Examples:
"Your 7-day streak is at risk! 5 reviews waiting."
"Perfect time for a ritual - Kristy usually feels most connected at 8pm 💑"
"You're 90% through Tantric Mastery - finish tonight?"


Do Not Disturb Modes:
Focus hours (no interruptions)
Weekend-only reminders
Time zone aware
Integrates with device DND

PART 4: TECHNICAL ROBUSTNESS
4.1 Comprehensive Error Handling
Global Error Boundary:
// app/error.tsx
export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    // Log to error tracking (local file)
    logError(error);
  }, [error]);

  return (
    <div className="error-container">
      <h2>Something went wrong</h2>
      <details>
        <summary>Error Details</summary>
        <pre>{error.message}</pre>
      </details>
      <Button onClick={reset}>Try Again</Button>
      <Button onClick={() => exportLogs()}>Export Debug Info</Button>
    </div>
  );
}

Graceful Degradation:
// Handle database errors
async function safeQuery<T>(query: () => Promise<T>): Promise<T | null> {
  try {
    return await query();
  } catch (err) {
    if (err.code === 'SQLITE_BUSY') {
      // Retry with exponential backoff
      await delay(100);
      return safeQuery(query);
    }
    
    // Log and return null
    console.error('Query failed:', err);
    return null;
  }
}

Data Integrity Checks:
// Validate database on startup
async function validateDatabase() {
  const checks = [
    checkForeignKeyIntegrity(),
    checkOrphanedRecords(),
    checkDateConsistency(),
    verifySchedulerState(),
  ];
  
  const results = await Promise.all(checks);
  
  if (results.some(r => !r.valid)) {
    showWarning('Database issues detected. Run repair?');
  }
}

4.2 Advanced Testing
Comprehensive Test Suite:
// Unit tests for scheduler
describe('FSRS Scheduler', () => {
  test('calculates stability correctly', () => {
    const item = createReviewItem();
    const newStability = calculateStability(item, 4);
    expect(newStability).toBeGreaterThan(item.stability);
  });
  
  test('handles lapses appropriately', () => {
    const item = { ...defaults, repetitions: 5 };
    const updated = processReview(item, 1); // lapse
    expect(updated.repetitions).toBe(0);
    expect(updated.intervalDays).toBe(1);
  });
});

// Integration tests for quiz flow
describe('Quiz Submission Flow', () => {
  test('creates review items for all questions', async () => {
    await submitQuiz(mockQuizData);
    const reviews = await getReviewItems(userId);
    expect(reviews.length).toBe(5);
  });
  
  test('schedules first review for tomorrow', async () => {
    await submitQuiz(mockQuizData);
    const firstReview = await getNextReview(userId);
    expect(firstReview.dueAt).toBe(tomorrow);
  });
});

// E2E tests with Playwright
test('complete quiz and review flow', async ({ page }) => {
  await page.goto('/lessons/123');
  await page.click('text=Start Quiz');
  
  // Answer questions
  await page.click('[data-testid="option-0"]');
  await page.click('text=Submit');
  
  // Rate quality
  await page.click('[data-quality="4"]');
  
  // Check review scheduled
  await page.goto('/review');
  await expect(page.locator('text=Review tomorrow')).toBeVisible();
});

Performance Testing:
// Load testing for large datasets
describe('Performance with 10k questions', () => {
  beforeAll(async () => {
    await seedLargeDataset(10000);
  });
  
  test('review queue loads in <500ms', async () => {
    const start = performance.now();
    await getReviewQueue();
    const duration = performance.now() - start;
    expect(duration).toBeLessThan(500);
  });
});

4.3 Security & Privacy
Data Encryption:
// Encrypt sensitive journal entries
import { encrypt, decrypt } from './crypto';

async function saveJournal(entry: SessionJournal) {
  const encrypted = await encrypt(
    JSON.stringify(entry),
    getUserMasterKey()
  );
  
  await db.journal.create({
    data: { userId, encryptedData: encrypted },
  });
}

Secure Backup/Restore:
// Export encrypted backup
async function createBackup() {
  const data = await exportAllData();
  const encrypted = await encrypt(data, userPassword);
  
  downloadFile('joshcoach-backup.enc', encrypted);
}

// Restore with verification
async function restoreBackup(file: File, password: string) {
  const encrypted = await file.text();
  const decrypted = await decrypt(encrypted, password);
  
  // Validate schema before importing
  if (!validateBackupSchema(decrypted)) {
    throw new Error('Invalid backup file');
  }
  
  await importData(decrypted);
}

Audit Logging:
model AuditLog {
  id        String   @id @default(cuid())
  action    String   // 'quiz_submit', 'lesson_complete', etc.
  details   String   // JSON metadata
  timestamp DateTime @default(now())
  
  @@index([action, timestamp])
}

4.4 Developer Experience
Comprehensive Documentation:
# /docs/10-developer-guide.md

## Local Development
1. Clone repo
2. Install: `npm install`
3. Setup DB: `npx prisma generate && npx prisma db push`
4. Seed: `npx prisma db seed`
5. Run: `npm run dev`

## Architecture Decision Records (ADRs)
- ADR-001: Why FSRS over SM-2
- ADR-002: SQLite vs PostgreSQL choice
- ADR-003: Local-first vs cloud-sync

## Code Style
- Use TypeScript strict mode
- Max function length: 50 lines
- Prefer functional components
- Test coverage >80%


Developer Tools:
// Debug panel (dev mode only)
if (process.env.NODE_ENV === 'development') {
  return (
    <DebugPanel>
      <QueryInspector />
      <StateViewer />
      <PerformanceMonitor />
      <DatabaseExplorer />
    </DebugPanel>
  );
}

Hot Module Replacement:
Fast Refresh for instant UI updates
Preserve state during code changes
Error overlay with stack traces


PART 5: DEPLOYMENT & MAINTENANCE
5.1 Production Build
Optimized Build Configuration:
// next.config.js
module.exports = {
  reactStrictMode: true,
  swcMinify: true,
  
  experimental: {
    optimizeCss: true,
    optimizePackageImports: ['recharts', 'lucide-react'],
  },
  
  images: {
    formats: ['image/avif', 'image/webp'],
  },
  
  webpack: (config) => {
    config.optimization.splitChunks.cacheGroups = {
      vendor: {
        test: /[\\/]node_modules[\\/]/,
        name: 'vendor',
        chunks: 'all',
      },
    };
    return config;
  },
};

Lighthouse Score Targets:
Performance: >90
Accessibility: 100
Best Practices: 100
SEO: N/A (local app)
5.2 Update Mechanism
Semantic Versioning:
{
  "version": "1.2.3",
  "changelog": {
    "1.2.3": [
      "Added FSRS scheduler",
      "Fixed quiz timer bug",
      "Improved dashboard performance"
    ]
  }
}

Auto-Update Check:
async function checkForUpdates() {
  const currentVersion = getAppVersion();
  const latestRelease = await fetchLatestRelease();
  
  if (compareVersions(latestRelease, currentVersion) > 0) {
    showUpdateNotification({
      version: latestRelease,
      changes: getChangelog(latestRelease),
      downloadUrl: getReleaseUrl(latestRelease),
    });
  }
}

5.3 Monitoring & Telemetry
Local Analytics (Privacy-Preserving):
// Track aggregate metrics only (no PII)
interface LocalMetrics {
  appVersion: string;
  totalLessons: number;
  totalReviews: number;
  avgSessionDuration: number;
  crashCount: number;
  
  // NO user-identifying info
  // NO content details
  // NO personal data
}

// Export for manual sharing (opt-in)
function exportAnonymizedMetrics() {
  const metrics = calculateLocalMetrics();
  downloadFile('metrics.json', metrics);
}


DELIVERABLES
Update ALL Documentation (/docs/):


10-technical-excellence.md (this spec)
11-developer-guide.md
12-testing-strategy.md
Update 08-architecture.md with new patterns
Implement Core Improvements:


Migrate SM-2 → FSRS scheduler
Add Zustand + React Query
Optimize database queries (add indexes, prepared statements)
Implement PWA with service worker
Advanced Features:


Enhanced dashboard with ML insights
Rich session journal with analytics
Multi-modal question types (matching, ordering, etc.)
Smart notifications system
UX Polish:


Smooth animations (framer-motion)
Loading skeletons everywhere
Optimistic updates
Error states with recovery
Empty states with guidance
Testing Infrastructure:


90%+ unit test coverage on core logic
E2E tests for all critical flows
Performance benchmarks
Visual regression tests (Chromatic/Percy)
Developer Tools:


Debug panel for dev mode
Comprehensive logging
Database migration scripts
Backup/restore system
Production Readiness:


Build optimization (<100KB FCP)
Lighthouse audit passing
Security audit (OWASP basics)
Accessibility audit (WCAG 2.1 AA)
CONSTRAINTS
MAINTAIN local-first architecture (no required cloud services)
PRESERVE all explicit educational content (no censorship)
ENSURE backwards compatibility with existing data
KEEP consent/safety reminders prominent
RESPECT privacy absolutely (no telemetry without opt-in)
TARGET 60fps UI interactions
SUPPORT offline usage
SUCCESS CRITERIA
[ ] App boots in <2s cold start
[ ] Review queue loads in <300ms
[ ] Quiz submission feels instant (<100ms perceived)
[ ] Zero data loss on crashes (WAL mode, transactions)
[ ] 90%+ test coverage on scheduler/analytics
[ ] Lighthouse Performance >90
[ ] Works offline (PWA)
[ ] Smooth 60fps animations
[ ] Zero TypeScript errors
[ ] Comprehensive error handling

OUTPUT REQUIRED
Update all affected files with improvements
Add new files for advanced features
Update tests to match new functionality
Provide migration guide for existing users
Document ALL new features in /docs/
Include performance benchmarks
Exact commands to upgrade existing installation
START NOW:
Begin with FSRS scheduler implementation (most critical)
Add Zustand store for global state
Implement React Query for server state
Optimize database with indexes
Build enhanced dashboard
Add comprehensive tests
Polish UX with animations/loading states
Document everything
GO! Make this the most technically robust, performant, and feature-rich educational platform possible while maintaining privacy and explicit content. Blow past every limitation of the current MVP.

---

This prompt will transform your app from functional to world-class by addressing:

1. **Learning Science**: Upgrading to FSRS (state-of-the-art spaced repetition)
2. **Performance**: Bundle optimization, query caching, PWA
3. **UX**: Sophisticated animations, loading states, error handling
4. **Features**: ML-powered insights, rich journaling, smart notifications
5. **Robustness**: Comprehensive testing, error boundaries, data integrity
6. **Developer Experience**: Better tooling, documentation, debugging

The result will be a production-grade learning platform that rivals commercial apps while maintaining your explicit educational mission and privacy-first architecture.


Prompt 6
STACK remains: Next.js (App Router) + TypeScript + Tailwind + shadcn/ui + Prisma + SQLite.
PREVIOUS WORK: The app already has foundational and advanced topics (orgasms, philosophies like Tantra/Taoism/Kama Sutra, marathon sessions, toys, etc.) + features like FSRS scheduler, journaling, ML insights, PWA. Keep everything but now EXPAND explosively with ultra-spicy, steamy new sections that dive deeper into NSFW territories, making content even more vivid, anatomical, and arousal-inducing while always centering consent, safety, and mutual pleasure.
DELIVERABLE: Update the repo to amplify the spiciness, sexiness, and steaminess across the board:
Update /docs/01-vision.md to a hyper-steamy version: Emphasize the app as a portal to the steamiest, most NSFW sex education, exploring every erotic niche for straight married couples. State the goal is for Josh to absorb an avalanche of sexy, taboo-shattering knowledge that makes every lesson a pulse-racing adventure in pleasure mastery. Include outcomes like "90% mastery on light bondage techniques for heightened orgasms" and "tracking steamy session logs with intensity ratings."
Add a new "Steamy Frontiers & Kink Exploration" category in topics (always accessible in Advanced Mode). Seed 10-12 new ultra-spicy topics with 5-7 explicit lessons each:
Topic: "Light BDSM & Power Play"
Lessons: Safe bondage (silk ties, cuffs) for restraint-enhanced penetration; Spanking rhythms and intensities; Dominant/submissive roles with aftercare; Sensory overload with blindfolds and whispers; Tease and denial games for explosive releases.
Topic: "Sensory Deprivation & Heightened Touch"
Lessons: Blindfold sex for amplified sensations; Earplugs and noise-cancellation during oral; Full-body wrapping/mummification play; Feather tickling to intense whipping (consensual); Combining deprivation with temperature contrasts.
Topic: "Temperature & Sensation Play"
Lessons: Ice cube trails on nipples/clitoris; Warm oil massages leading to penetration; Hot wax dripping patterns; Chilled glass toys for internal stimulation; Alternating hot/cold oral techniques.
Topic: "Anal Adventure Mastery"
Lessons: Gentle entry prep with lubed fingers/toys; Prostate milking for male pleasure; Pegging dynamics (if mutual); Double penetration simulations; Anal orgasms through rhythm and angle mastery.
Topic: "Fisting & Extreme Stretching"
Lessons: Gradual hand insertion techniques (vaginal/anal); Lube essentials and relaxation methods; Building to full fist with rotations; Combining with clitoral stim for overwhelming climaxes; Safety protocols for depth play.


Topic: "Erotic Hypnosis & Mind Control Play"
Lessons: Guided trance for heightened arousal; Suggestion implantation for instant orgasms; Role-play hypnosis scenarios; Combining with physical touch for mind-body fusion.
Topic: "Watersports & Fluid Play" (if consensual boundaries allow)
Lessons: Safe urination play in shower; Incorporating into foreplay; Psychological thrill aspects; Hygiene and consent deep dives.
Topic: "Exhibitionism & Voyeurism in Marriage"
Lessons: Private cam sessions; Mirror sex for visual feedback; Outdoor risk play (discreet); Watching mutual masturbation; Building confidence through exposure games.
Topic: "Fetish Integration" (feet, leather, role-specific)
Lessons: Foot worship and massage leading to intercourse; Leather harness use; Food play (whipped cream, chocolate); Object fetish incorporation.
Topic: "Orgasm Denial & Ruined Orgasms"
Lessons: Long-term edging protocols; Ruining climaxes for intensified next rounds; Chastity device ideas; Power exchange in denial games.
Topic: "Group Fantasy Simulation" (for couples only, no actual third parties)
Lessons: Role-playing threesomes; Using mirrors/toys to simulate multiples; Dirty talk scenarios; Emotional safety in fantasy exploration.
Topic: "Erotic Literature & Audio Inspiration"
Lessons: Incorporating steamy stories during sex; Audio erotica playback; Writing custom fantasies; Using as foreplay ignition.
For each new topic/lesson: Craft ultra-steamy, NSFW Markdown content — dripping with explicit descriptions (throbbing erections, dripping wetness, gasping moans), step-by-step guides with sensations, sounds, and scents. Example: "Slide the ice cube slowly across her erect nipples, watching them harden as she arches in ecstasy; follow with your hot mouth for a shocking contrast that sends shivers to her pulsing clitoris (sensation play)."
Generate 80-100 new steamy quiz questions (MCQ, short answer, scenario):
MCQ: "In light BDSM, the 'safeword' is primarily for: A) Increasing intensity B) Immediate stopping C) Role reversal" (B)
Short answer: "Detail a step-by-step anal prep sequence including lube application, finger progression, and relaxation cues."
Scenario: "Kristy expresses interest in temperature play — outline a steamy session with ice and warm breath on her most sensitive areas."
Enhancements:
Add "Steamy Session Simulator": Interactive quiz-like feature simulating NSFW scenarios with choices leading to outcomes/teachings.
Ultra-spicy rituals: "Blindfold tease night," "Temperature play date," "Light bondage ritual," "Anal exploration evening."
UI: Add "Heat Level" ratings for topics (Mild, Steamy, Inferno); NSFW warnings; Erotic quote popups from lessons.
Journal upgrades: Add fields for "Steamiest Moment," "New Kink Tried," "Intensity Scale (1-10)," "Kristy's Moans Description."

CONSTRAINTS:
Local-first, ironclad privacy.
EVERY SINGLE ELEMENT MUST REINFORCE enthusiastic consent, safewords, aftercare, health checks, and zero coercion — frame as empowering, fun exploration.
Ultra-explicit, steamy, NSFW language MANDATORY — vivid, sensory-rich, arousal-evoking details without limits.
Heterosexual married focus only.
Draw from real sources (cite BDSM guides, kink experts like Midori, erotic authors like Anais Nin, modern therapists).
No harm, violence beyond consensual play; always safe/sane/consensual.
OUTPUT REQUIRED:
Update vision.md with ultra-steamy scope.
Add all new topics/lessons/questions to seed data.
Implement simulator feature (branching scenario UI).
Provide run/migration commands.
Ensure seamless integration.
START NOW: Kick off with vision update, then seed the new kink topics with the steamiest, most boundary-pushing explicit content imaginable to expand sexual knowledge horizons. Make this the ultimate NSFW sex academy.

